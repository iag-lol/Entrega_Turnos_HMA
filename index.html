<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOY 15 · Entrega de Turno – Despacho</title>
    <!-- Librerías CDN requeridas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            /* Variables CSS para tema claro empresarial */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-secondary: #64748b;
            --color-success: #16a34a;
            --color-warning: #f59e0b;
            --color-danger: #dc2626;
            --color-info: #0891b2;
            --color-bg: #ffffff;
            --color-bg-secondary: #f8fafc;
            --color-bg-tertiary: #f1f5f9;
            --color-text: #1e293b;
            --color-text-secondary: #475569;
            --color-border: #e2e8f0;
            --color-border-hover: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 0.375rem;
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--color-bg-secondary);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            font-size: 0.875rem;
        }

        /* Layout */
        .app-container {
            display: flex;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background-color: var(--color-bg);
            border-right: 1px solid var(--color-border);
            height: 100vh;
            position: fixed;
            padding: 1rem 0;
            overflow-y: auto;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            z-index: 50;
        }

        .sidebar-header {
            padding: 0 1rem 1rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1rem;
        }

        .app-logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-primary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--color-text-secondary);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: var(--color-bg-tertiary);
            color: var(--color-primary);
            border-left-color: var(--color-primary);
        }

        .nav-item i {
            margin-right: 0.75rem;
            font-size: 1.125rem;
        }

        /* Main content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 1.5rem;
            min-height: 100vh;
            transition: var(--transition);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .content-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Panels & Cards */
        .panel {
            background-color: var(--color-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .panel-body {
            padding: 1rem;
        }

        .panel-footer {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background-color: var(--color-bg-tertiary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-bg);
            background-clip: padding-box;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        }

        .form-control::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.7;
        }

        .form-control:disabled {
            background-color: var(--color-bg-tertiary);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-check-input {
            margin-right: 0.5rem;
        }

        .form-check-label {
            cursor: pointer;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -0.5rem;
            margin-left: -0.5rem;
        }

        .form-col {
            flex: 1;
            padding: 0 0.5rem;
            min-width: 0;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
        }

        .btn:disabled {
            opacity: 0.65;
            pointer-events: none;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .btn-primary {
            color: #fff;
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
        }

        .btn-secondary {
            color: #fff;
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            border-color: #4b5563;
        }

        .btn-success {
            color: #fff;
            background-color: var(--color-success);
            border-color: var(--color-success);
        }

        .btn-success:hover {
            background-color: #15803d;
            border-color: #15803d;
        }

        .btn-danger {
            color: #fff;
            background-color: var(--color-danger);
            border-color: var(--color-danger);
        }

        .btn-danger:hover {
            background-color: #b91c1c;
            border-color: #b91c1c;
        }

        .btn-warning {
            color: #fff;
            background-color: var(--color-warning);
            border-color: var(--color-warning);
        }

        .btn-warning:hover {
            background-color: #d97706;
            border-color: #d97706;
        }

        .btn-outline-primary {
            color: var(--color-primary);
            background-color: transparent;
            border-color: var(--color-primary);
        }

        .btn-outline-primary:hover {
            color: #fff;
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-link {
            font-weight: 500;
            color: var(--color-primary);
            text-decoration: none;
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .btn-link:hover {
            color: var(--color-primary-hover);
            text-decoration: underline;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            margin-bottom: 1rem;
            color: var(--color-text);
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            vertical-align: middle;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .table thead th {
            font-weight: 600;
            border-bottom: 2px solid var(--color-border);
            background-color: var(--color-bg-secondary);
            color: var(--color-text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table tbody tr:hover {
            background-color: var(--color-bg-tertiary);
        }

        .table-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: flex-end;
        }

        /* Badges/Chips */
        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-primary {
            color: #fff;
            background-color: var(--color-primary);
        }

        .badge-secondary {
            color: #fff;
            background-color: var(--color-secondary);
        }

        .badge-success {
            color: #fff;
            background-color: var(--color-success);
        }

        .badge-warning {
            color: #fff;
            background-color: var(--color-warning);
        }

        .badge-danger {
            color: #fff;
            background-color: var(--color-danger);
        }

        .badge-info {
            color: #fff;
            background-color: var(--color-info);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1.25;
            border-radius: 9999px;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .chip-good {
            background-color: rgba(22, 163, 74, 0.15);
            color: var(--color-success);
        }

        .chip-warn {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .chip-bad {
            background-color: rgba(220, 38, 38, 0.15);
            color: var(--color-danger);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .tab:hover {
            color: var(--color-primary);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alerts & Toasts */
        .alert {
            position: relative;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            position: relative;
            max-width: 350px;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            background-color: var(--color-success);
            color: white;
        }

        .toast-warning {
            background-color: var(--color-warning);
            color: white;
        }

        .toast-error {
            background-color: var(--color-danger);
            color: white;
        }

        .toast-info {
            background-color: var(--color-info);
            color: white;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            background-color: var(--color-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 101;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .modal-close {
            border: none;
            background: none;
            color: var(--color-text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--color-danger);
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(90vh - 130px);
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background-color: var(--color-bg-tertiary);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .modal.active,
        .modal-backdrop.active {
            display: flex;
        }

        /* Utilities */
        .d-none {
            display: none !important;
        }

        .d-flex {
            display: flex !important;
        }

        .justify-between {
            justify-content: space-between !important;
        }

        .align-center {
            align-items: center !important;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mt-1 {
            margin-top: 0.25rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mt-3 {
            margin-top: 1rem !important;
        }

        .mt-4 {
            margin-top: 1.5rem !important;
        }

        .mx-auto {
            margin-left: auto !important;
            margin-right: auto !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-right {
            text-align: right !important;
        }

        .font-bold {
            font-weight: 700 !important;
        }

        .text-danger {
            color: var(--color-danger) !important;
        }

        .text-success {
            color: var(--color-success) !important;
        }

        .text-warning {
            color: var(--color-warning) !important;
        }

        .text-primary {
            color: var(--color-primary) !important;
        }

        .w-100 {
            width: 100% !important;
        }

        .h-100 {
            height: 100% !important;
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Mobile Bottom Nav */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--color-bg);
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.05);
            z-index: 50;
            padding: 0.5rem;
            height: 60px;
        }

        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            height: 100%;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary);
            text-decoration: none;
            padding: 0.25rem;
            font-size: 0.625rem;
            flex: 1;
            text-align: center;
            cursor: pointer;
        }

        .bottom-nav-item.active {
            color: var(--color-primary);
        }

        .bottom-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        /* KPIs */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background-color: var(--color-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
        }

        .kpi-title {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text);
        }

        .kpi-change {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .kpi-change.positive {
            color: var(--color-success);
        }

        .kpi-change.negative {
            color: var(--color-danger);
        }

        /* Print styles for PDF */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
                font-size: 12pt;
            }

            .app-container,
            .main-content {
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .sidebar,
            .bottom-nav,
            .toast-container,
            .btn-group {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
            }

            .panel {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            table {
                width: 100% !important;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #ddd !important;
            }

            .print-only {
                display: block !important;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
                z-index: 100;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-bottom: 70px;
            }

            .bottom-nav {
                display: block;
            }

            .grid-3,
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-col {
                padding: 0;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar (Desktop) -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">
                    <i class="bi bi-bus-front me-2"></i>
                    VOY 15
                </div>
            </div>
            <div class="nav-items">
                <div class="nav-item" data-tab="operacion">
                    <i class="bi bi-speedometer2"></i>
                    <span>Operación</span>
                </div>
                <div class="nav-item" data-tab="despachos">
                    <i class="bi bi-send"></i>
                    <span>Despachos</span>
                </div>
                <div class="nav-item" data-tab="incidencias">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>Incidencias</span>
                </div>
                <div class="nav-item" data-tab="activos">
                    <i class="bi bi-phone"></i>
                    <span>Activos</span>
                </div>
                <div class="nav-item" data-tab="dashboard">
                    <i class="bi bi-graph-up"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-tab="informes">
                    <i class="bi bi-file-text"></i>
                    <span>Informes de Turnos</span>
                </div>
                <div class="nav-item" data-tab="catalogos">
                    <i class="bi bi-gear"></i>
                    <span>Catálogos y Config</span>
                </div>
                <div class="nav-item" data-tab="excel">
                    <i class="bi bi-file-earmark-excel"></i>
                    <span>Excel (Import/Export)</span>
                </div>
                <div class="nav-item" data-tab="ayuda">
                    <i class="bi bi-question-circle"></i>
                    <span>Ayuda</span>
                </div>
            </div>
        </div>
        <!-- Bottom Navigation (Mobile) -->
        <div class="bottom-nav">
            <div class="bottom-nav-items">
                <div class="bottom-nav-item" data-tab="operacion">
                    <i class="bi bi-speedometer2"></i>
                    <span>Operación</span>
                </div>
                <div class="bottom-nav-item" data-tab="despachos">
                    <i class="bi bi-send"></i>
                    <span>Despachos</span>
                </div>
                <div class="bottom-nav-item" data-tab="incidencias">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>Incidencias</span>
                </div>
                <div class="bottom-nav-item" data-tab="activos">
                    <i class="bi bi-phone"></i>
                    <span>Activos</span>
                </div>
                <div class="bottom-nav-item" data-tab="menu-more">
                    <i class="bi bi-three-dots"></i>
                    <span>Más</span>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Operación Tab -->
            <div class="tab-content" id="operacion-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-speedometer2"></i> Operación de Turno
                    </h2>
                    <div id="turno-activo-badge">
                        <span class="badge badge-warning">Sin turno activo</span>
                    </div>
                </div>

                <!-- Form Inicio de Turno -->
                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Inicio de Turno</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="fecha">Fecha</label>
                                    <input type="date" id="fecha" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="turno">Turno</label>
                                    <select id="turno" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Noche">Noche</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="despachador">Despachador</label>
                                    <input type="text" id="despachador" class="form-control" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="tel-inicio">Estado Teléfono Inicial</label>
                                    <select id="tel-inicio" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Buen estado">Buen estado</option>
                                        <option value="Mal estado">Mal estado</option>
                                        <option value="No funciona">No funciona</option>
                                        <option value="Accidentado">Accidentado</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="llaves-ini">Llaves Inicio</label>
                                    <input type="number" id="llaves-ini" class="form-control" min="0" value="0"
                                        required>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="op-ini">Buses Operativos (inicio)</label>
                                    <input type="number" id="op-ini" class="form-control" min="0" value="0" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="man-ini">Buses en Mantenimiento (inicio)</label>
                                    <input type="number" id="man-ini" class="form-control" min="0" value="0" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="diff-ini">Diferencia (inicio)</label>
                                    <input type="number" id="diff-ini" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <div class="btn-group">
                            <button id="btn-iniciar-turno" class="btn btn-primary">
                                <i class="bi bi-play-fill"></i> Iniciar Turno
                            </button>
                            <button id="btn-guardar-inicio" class="btn btn-secondary" disabled>
                                <i class="bi bi-save"></i> Guardar Inicio
                            </button>
                            <button id="btn-cancelar-turno" class="btn btn-danger" disabled>
                                <i class="bi bi-x-circle"></i> Cancelar Turno
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Form Cierre de Turno -->
                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Cierre de Turno</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="tel-fin">Estado Teléfono Final</label>
                                    <select id="tel-fin" class="form-control" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Buen estado">Buen estado</option>
                                        <option value="Mal estado">Mal estado</option>
                                        <option value="No funciona">No funciona</option>
                                        <option value="Accidentado">Accidentado</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="llaves-fin">Llaves Final</label>
                                    <input type="number" id="llaves-fin" class="form-control" min="0" value="0"
                                        disabled>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="op-fin">Buses Operativos (fin)</label>
                                    <input type="number" id="op-fin" class="form-control" min="0" value="0" disabled>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="man-fin">Buses en Mantenimiento (fin)</label>
                                    <input type="number" id="man-fin" class="form-control" min="0" value="0" disabled>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="diff-fin">Diferencia (fin)</label>
                                    <input type="number" id="diff-fin" class="form-control" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notas-cierre">Notas de Cierre</label>
                            <textarea id="notas-cierre" class="form-control" rows="3" disabled></textarea>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <div class="btn-group">
                            <button id="btn-cerrar-turno" class="btn btn-warning" disabled>
                                <i class="bi bi-stop-fill"></i> Cerrar Turno
                            </button>
                            <button id="btn-resumen-turno" class="btn btn-info" disabled>
                                <i class="bi bi-printer"></i> Resumen / Imprimir Turno
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Despachos Tab -->
            <div class="tab-content" id="despachos-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-send"></i> Despachos
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Registro de Despachos</h3>
                        <button id="btn-nuevo-despacho" class="btn btn-primary btn-sm" disabled>
                            <i class="bi bi-plus"></i> Nuevo Despacho
                        </button>
                    </div>
                    <div class="panel-body">
                        <form id="form-despacho" class="mb-3">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-fecha">Fecha</label>
                                        <input type="date" id="desp-fecha" class="form-control" required disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-turno">Turno</label>
                                        <select id="desp-turno" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                            <option value="Noche">Noche</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-servicio">Servicio</label>
                                        <input type="text" id="desp-servicio" class="form-control" required disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-tipo-bus">Tipo Bus</label>
                                        <select id="desp-tipo-bus" class="form-control" disabled>
                                            <option value="">Seleccione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-bus-id">Bus ID (PPU)</label>
                                        <input type="text" id="desp-bus-id" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-conductor">Conductor</label>
                                        <input type="text" id="desp-conductor" class="form-control" disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-tipo-evento">Tipo Evento</label>
                                        <select id="desp-tipo-evento" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="PrimeraSalida">Primera Salida</option>
                                            <option value="UltimaSalida">Última Salida</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-hora-prog">Hora Programada</label>
                                        <input type="text" id="desp-hora-prog" class="form-control" placeholder="HH:MM"
                                            required disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="desp-hora-real">Hora Real</label>
                                        <input type="text" id="desp-hora-real" class="form-control" placeholder="HH:MM"
                                            required disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" id="desp-next-day" class="form-check-input" disabled>
                                            <label class="form-check-label" for="desp-next-day">Día siguiente</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="desp-obs">Observaciones</label>
                                <textarea id="desp-obs" class="form-control" rows="2" disabled></textarea>
                            </div>

                            <div class="btn-group">
                                <button type="submit" id="btn-guardar-despacho" class="btn btn-success" disabled>
                                    <i class="bi bi-save"></i> Guardar Despacho
                                </button>
                                <button type="button" id="btn-cancelar-despacho" class="btn btn-secondary" disabled>
                                    <i class="bi bi-x"></i> Cancelar
                                </button>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="table" id="tabla-despachos">
                                <thead>
                                    <tr>
                                        <th>Servicio</th>
                                        <th>Tipo</th>
                                        <th>Bus</th>
                                        <th>Conductor</th>
                                        <th>H. Prog</th>
                                        <th>H. Real</th>
                                        <th>Retraso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Incidencias Tab -->
            <div class="tab-content" id="incidencias-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-exclamation-triangle"></i> Incidencias
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Registro de Incidencias</h3>
                        <button id="btn-nueva-incidencia" class="btn btn-primary btn-sm" disabled>
                            <i class="bi bi-plus"></i> Nueva Incidencia
                        </button>
                    </div>
                    <div class="panel-body">
                        <form id="form-incidencia" class="mb-3">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-fecha">Fecha</label>
                                        <input type="date" id="inc-fecha" class="form-control" required disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-turno">Turno</label>
                                        <select id="inc-turno" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                            <option value="Noche">Noche</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-servicio">Servicio</label>
                                        <input type="text" id="inc-servicio" class="form-control" required disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-bus-id">Bus ID (PPU) (Opcional)</label>
                                        <input type="text" id="inc-bus-id" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-tipo-evento">Tipo Evento</label>
                                        <select id="inc-tipo-evento" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="Cancelación">Cancelación</option>
                                            <option value="Desvío de ruta">Desvío de ruta</option>
                                            <option value="Bus en panne">Bus en panne</option>
                                            <option value="Ausencia de conductor">Ausencia de conductor</option>
                                            <option value="Bus operativo">Bus operativo</option>
                                            <option value="Bus detenido">Bus detenido</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="inc-motivo">Motivo</label>
                                        <select id="inc-motivo" class="form-control" disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="Conductor">Conductor</option>
                                            <option value="Falta de Bus">Falta de Bus</option>
                                            <option value="Mantenimiento">Mantenimiento</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="inc-obs">Observaciones</label>
                                <textarea id="inc-obs" class="form-control" rows="2" disabled></textarea>
                            </div>

                            <div class="btn-group">
                                <button type="submit" id="btn-guardar-incidencia" class="btn btn-success" disabled>
                                    <i class="bi bi-save"></i> Guardar Incidencia
                                </button>
                                <button type="button" id="btn-cancelar-incidencia" class="btn btn-secondary" disabled>
                                    <i class="bi bi-x"></i> Cancelar
                                </button>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="table" id="tabla-incidencias">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Servicio</th>
                                        <th>Bus</th>
                                        <th>Tipo Evento</th>
                                        <th>Motivo</th>
                                        <th>Obs</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activos Tab -->
            <div class="tab-content" id="activos-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-phone"></i> Activos
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Registro de Activos</h3>
                        <button id="btn-nuevo-activo" class="btn btn-primary btn-sm" disabled>
                            <i class="bi bi-plus"></i> Nuevo Activo
                        </button>
                    </div>
                    <div class="panel-body">
                        <form id="form-activo" class="mb-3">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="act-fecha">Fecha</label>
                                        <input type="date" id="act-fecha" class="form-control" required disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="act-turno">Turno</label>
                                        <select id="act-turno" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                            <option value="Noche">Noche</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="act-tipo">Tipo</label>
                                        <select id="act-tipo" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="Celular">Celular</option>
                                            <option value="Documento">Documento</option>
                                            <option value="LlavesBus">Llaves Bus</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="act-bus-id">Bus ID (Obligatorio para
                                            Llaves)</label>
                                        <input type="text" id="act-bus-id" class="form-control" disabled>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="act-estado">Estado</label>
                                        <select id="act-estado" class="form-control" required disabled>
                                            <option value="">Seleccione...</option>
                                            <option value="OK">OK</option>
                                            <option value="Falla">Falla</option>
                                            <option value="Faltante">Faltante</option>
                                            <option value="Entregado">Entregado</option>
                                            <option value="Pendiente">Pendiente</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="act-obs">Observaciones</label>
                                <textarea id="act-obs" class="form-control" rows="2" disabled></textarea>
                            </div>

                            <div class="btn-group">
                                <button type="submit" id="btn-guardar-activo" class="btn btn-success" disabled>
                                    <i class="bi bi-save"></i> Guardar Activo
                                </button>
                                <button type="button" id="btn-cancelar-activo" class="btn btn-secondary" disabled>
                                    <i class="bi bi-x"></i> Cancelar
                                </button>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="table" id="tabla-activos">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Bus</th>
                                        <th>Estado</th>
                                        <th>Obs</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboard-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-graph-up"></i> Dashboard
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Filtros</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="dash-fecha">Fecha</label>
                                    <input type="date" id="dash-fecha" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="dash-tolerancia-atraso">Tolerancia Atraso
                                        (min)</label>
                                    <input type="number" id="dash-tolerancia-atraso" class="form-control" min="0"
                                        value="5">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="dash-tolerancia-anticipo">Tolerancia Anticipo
                                        (min)</label>
                                    <input type="number" id="dash-tolerancia-anticipo" class="form-control" min="0"
                                        value="2">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="btn-aplicar-filtros" class="btn btn-primary w-100">
                                        <i class="bi bi-filter"></i> Aplicar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Cancelaciones</div>
                        <div class="kpi-value" id="kpi-cancelaciones">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Buses Operativos</div>
                        <div class="kpi-value" id="kpi-operativos">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Buses Detenidos/Panne</div>
                        <div class="kpi-value" id="kpi-detenidos">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Ausencias</div>
                        <div class="kpi-value" id="kpi-ausencias">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Puntualidad Primera</div>
                        <div class="kpi-value" id="kpi-puntualidad-primera">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Puntualidad Última</div>
                        <div class="kpi-value" id="kpi-puntualidad-ultima">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Llaves Faltantes</div>
                        <div class="kpi-value" id="kpi-llaves-faltantes">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Total Registros</div>
                        <div class="kpi-value" id="kpi-registros">0</div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-2">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">Registros por Día</h3>
                        </div>
                        <div class="panel-body">
                            <canvas id="chart-registros"></canvas>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">% Puntualidad Primera por Servicio</h3>
                        </div>
                        <div class="panel-body">
                            <canvas id="chart-puntualidad"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informes de Turnos Tab -->
            <div class="tab-content" id="informes-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-file-text"></i> Informes de Turnos
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Filtros</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="inf-fecha-desde">Desde</label>
                                    <input type="date" id="inf-fecha-desde" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="inf-fecha-hasta">Hasta</label>
                                    <input type="date" id="inf-fecha-hasta" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Turno</label>
                                    <div>
                                        <div class="form-check">
                                            <input type="checkbox" id="inf-turno-am" class="form-check-input" checked>
                                            <label class="form-check-label" for="inf-turno-am">AM</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="inf-turno-pm" class="form-check-input" checked>
                                            <label class="form-check-label" for="inf-turno-pm">PM</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="inf-turno-noche" class="form-check-input"
                                                checked>
                                            <label class="form-check-label" for="inf-turno-noche">Noche</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="inf-despachador">Despachador</label>
                                    <select id="inf-despachador" class="form-control">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="inf-estado">Estado</label>
                                    <select id="inf-estado" class="form-control">
                                        <option value="Cerrado" selected>Cerrado</option>
                                        <option value="Activo">Activo</option>
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="btn-buscar-informes" class="btn btn-primary w-100">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Informes de Turnos Cerrados</h3>
                    </div>
                    <div class="panel-body">
                        <div class="table-container">
                            <table class="table" id="tabla-informes">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Turno</th>
                                        <th>Despachador</th>
                                        <th>Operativos</th>
                                        <th>Mantención</th>
                                        <th>Llaves</th>
                                        <th>Hora Cierre</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Catálogos y Config Tab -->
            <div class="tab-content" id="catalogos-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-gear"></i> Catálogos y Config
                    </h2>
                </div>

                <div class="grid grid-2">
                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Turnos</h3>
                            <button id="btn-agregar-turno" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="tabla-cat-turnos">
                                    <thead>
                                        <tr>
                                            <th>Turno</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Servicios</h3>
                            <button id="btn-agregar-servicio" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="tabla-cat-servicios">
                                    <thead>
                                        <tr>
                                            <th>Servicio</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Tipos de Bus</h3>
                            <button id="btn-agregar-tipo-bus" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="tabla-cat-tipos-bus">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Motivos</h3>
                            <button id="btn-agregar-motivo" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="tabla-cat-motivos">
                                    <thead>
                                        <tr>
                                            <th>Motivo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Estados de Teléfono</h3>
                            <button id="btn-agregar-estado-tel" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus"></i> Agregar
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="tabla-cat-estados-tel">
                                    <thead>
                                        <tr>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel mb-4">
                        <div class="panel-header">
                            <h3 class="panel-title">Configuración</h3>
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label class="form-label" for="config-flota-total">Flota Total</label>
                                <input type="number" id="config-flota-total" class="form-control" min="1" value="124">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="config-tolerancia-atraso">Tolerancia Atraso (min)</label>
                                <input type="number" id="config-tolerancia-atraso" class="form-control" min="0"
                                    value="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="config-tolerancia-anticipo">Tolerancia Anticipo
                                    (min)</label>
                                <input type="number" id="config-tolerancia-anticipo" class="form-control" min="0"
                                    value="2">
                            </div>
                            <button id="btn-guardar-config" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar Configuración
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excel Tab -->
            <div class="tab-content" id="excel-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-file-earmark-excel"></i> Excel (Import/Export)
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Importación</h3>
                    </div>
                    <div class="panel-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            Seleccione un archivo Excel (.xlsx) para importar datos. Debe contener hojas con nombres:
                            "Despachos", "Incidencias", "Activos" o "Turnos".
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="excel-import">Seleccionar archivo</label>
                            <input type="file" id="excel-import" class="form-control" accept=".xlsx">
                        </div>

                        <div class="btn-group">
                            <button id="btn-importar-excel" class="btn btn-primary" disabled>
                                <i class="bi bi-upload"></i> Importar
                            </button>
                            <button id="btn-descargar-plantilla" class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> Descargar Plantilla
                            </button>
                        </div>
                    </div>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Exportación</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="excel-fecha-desde">Desde</label>
                                    <input type="date" id="excel-fecha-desde" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="excel-fecha-hasta">Hasta</label>
                                    <input type="date" id="excel-fecha-hasta" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="excel-turno">Turno</label>
                                    <select id="excel-turno" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Noche">Noche</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="btn-exportar-excel" class="btn btn-success w-100">
                                        <i class="bi bi-download"></i> Exportar a Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ayuda Tab -->
            <div class="tab-content" id="ayuda-tab">
                <div class="content-header">
                    <h2 class="content-title">
                        <i class="bi bi-question-circle"></i> Ayuda
                    </h2>
                </div>

                <div class="panel mb-4">
                    <div class="panel-header">
                        <h3 class="panel-title">Manual de Usuario</h3>
                    </div>
                    <div class="panel-body">
                        <h4>Regla de oro: Aislamiento por turno</h4>
                        <p>Todo lo que sucede en un turno, queda en ese turno. Los registros de Despachos, Incidencias y
                            Activos están siempre asociados al turno activo.</p>

                        <h4>Flujo de trabajo</h4>
                        <ol>
                            <li><strong>Iniciar Turno:</strong> En la pestaña "Operación", complete los datos del inicio
                                de turno y presione "Iniciar Turno".</li>
                            <li><strong>Registrar Eventos:</strong> Durante el turno, registre los despachos,
                                incidencias y activos en sus respectivas pestañas.</li>
                            <li><strong>Cerrar Turno:</strong> Al finalizar, complete los datos de cierre y presione
                                "Cerrar Turno". Esto limpiará todos los formularios y bloqueará la edición.</li>
                            <li><strong>Consultar Informes:</strong> Los turnos cerrados pueden consultarse en la
                                pestaña "Informes de Turnos".</li>
                        </ol>

                        <h4>Características principales</h4>
                        <ul>
                            <li><strong>Realtime:</strong> La aplicación se actualiza en tiempo real cuando hay cambios
                                desde otra sesión.</li>
                            <li><strong>Exportación Excel:</strong> Puede exportar e importar datos en formato Excel.
                            </li>
                            <li><strong>Dashboard:</strong> Visualice KPIs y gráficos actualizados con los datos de los
                                turnos.</li>
                            <li><strong>Catálogos:</strong> Gestione turnos, servicios, tipos de bus y otros catálogos.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Detalle Turno -->
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal" id="modal-detalle-turno">
        <div class="modal-header">
            <h3 class="modal-title">Detalle de Turno</h3>
            <button class="modal-close" id="btn-cerrar-modal">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-detalle-content">
            <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
            <button id="btn-imprimir-detalle" class="btn btn-primary">
                <i class="bi bi-printer"></i> Imprimir PDF
            </button>
            <button id="btn-exportar-detalle" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Exportar XLSX
            </button>
            <button id="btn-cerrar-detalle" class="btn btn-secondary">
                <i class="bi bi-x"></i> Cerrar
            </button>
        </div>
    </div>
    <!-- Scripts -->
    <script>
        // Estado global de la aplicación
        const appState = {
            supabase: null,
            isConnected: false,
            turnoActivo: null,
            shiftId: null,
            catalogos: {
                turnos: ["AM", "PM", "Noche"],
                servicios: [],
                tiposBus: [],
                motivos: ["Conductor", "Falta de Bus", "Mantenimiento", "Otro"],
                estadosTelefono: ["Buen estado", "Mal estado", "No funciona", "Accidentado", "Otro"]
            },
            config: {
                flotaTotal: 124,
                toleranciaAtraso: 5,
                toleranciaAnticipo: 2
            },
            despachadores: [],
            currentTab: 'operacion',
            editingId: null,
            // Para realtime
            subscription: null
        };

        // Configuración de Supabase (reemplazar con los valores reales del proyecto)
        const SUPABASE_CONFIG = {
            url: 'https://bclorwyvziffzjgkvlng.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbG9yd3l2emlmZnpqZ2t2bG5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTY3MzQsImV4cCI6MjA3NjI3MjczNH0.cbul1Zfle1Ifi7gSe1JoJ2gOIvFNeIFTy2SheAlTxPU'
        };

        const DEFAULT_KPIS = {
            cancelaciones: 0,
            operativos: 0,
            detenidos: 0,
            ausencias: 0,
            puntualidadPrimera: 0,
            puntualidadUltima: 0,
            llavesFaltantes: 0,
            totalRegistros: 0
        };

        function isSupabaseReady(showToast = false) {
            const ready = Boolean(appState.supabase) && appState.isConnected;
            if (!ready && showToast) {
                mostrarToast('Conéctese a Supabase para acceder a esta sección.', 'warning');
            }
            return ready;
        }

        function setConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (!statusEl) return;
            const badges = {
                connected: '<span class="badge badge-success">Conectado</span>',
                error: '<span class="badge badge-danger">Error de conexión</span>',
                loading: '<span class="badge badge-info">Conectando...</span>',
                idle: '<span class="badge badge-warning">No conectado</span>'
            };
            statusEl.innerHTML = badges[status] || badges.idle;
        }

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function () {
            initTabs();
            setupEventListeners();
            loadConfigFromStorage();
            checkSupabaseConnection();
            initFormValidations();

            // Establecer la fecha actual en todos los datepickers
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
        });

        // Inicialización de pestañas
        function initTabs() {
            // Ocultar todas las pestañas excepto la primera
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Mostrar la primera pestaña
            document.getElementById('operacion-tab').style.display = 'block';

            // Marcar la primera pestaña como activa
            document.querySelector('.nav-item[data-tab="operacion"]').classList.add('active');
            document.querySelector('.bottom-nav-item[data-tab="operacion"]').classList.add('active');
        }

        // Configuración de event listeners
        function setupEventListeners() {
            // Navegación de pestañas (Sidebar y Bottom Nav)
            document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    if (tabId === 'menu-more') {
                        // Mostrar menú adicional en móvil
                        showMoreMenu();
                        return;
                    }

                    // Cambiar de pestaña
                    changeTab(tabId);
                });
            });

            // Operación (Inicio/Cierre de Turno)
            document.getElementById('btn-iniciar-turno').addEventListener('click', iniciarTurno);
            document.getElementById('btn-guardar-inicio').addEventListener('click', guardarInicio);
            document.getElementById('btn-cancelar-turno').addEventListener('click', cancelarTurno);
            document.getElementById('btn-cerrar-turno').addEventListener('click', cerrarTurno);
            document.getElementById('btn-resumen-turno').addEventListener('click', mostrarResumenTurno);

            // Actualización de diferencia en tiempo real
            ['op-ini', 'man-ini'].forEach(id => {
                document.getElementById(id).addEventListener('input', calcularDiferenciaInicial);
            });

            ['op-fin', 'man-fin'].forEach(id => {
                document.getElementById(id).addEventListener('input', calcularDiferenciaFinal);
            });

            // Despachos
            document.getElementById('btn-nuevo-despacho').addEventListener('click', nuevoDespacho);
            document.getElementById('form-despacho').addEventListener('submit', function (e) {
                e.preventDefault();
                guardarDespacho();
            });
            document.getElementById('btn-cancelar-despacho').addEventListener('click', cancelarDespacho);

            // Validación de formato de hora para despachos
            ['desp-hora-prog', 'desp-hora-real'].forEach(id => {
                document.getElementById(id).addEventListener('input', function (e) {
                    formatearHora(e.target);
                });

                document.getElementById(id).addEventListener('blur', function (e) {
                    validarHora(e.target);
                });
            });

            // Incidencias
            document.getElementById('btn-nueva-incidencia').addEventListener('click', nuevaIncidencia);
            document.getElementById('form-incidencia').addEventListener('submit', function (e) {
                e.preventDefault();
                guardarIncidencia();
            });
            document.getElementById('btn-cancelar-incidencia').addEventListener('click', cancelarIncidencia);

            // Validación condicional para incidencias
            document.getElementById('inc-tipo-evento').addEventListener('change', function () {
                const tipoEvento = this.value;
                const motivoSelect = document.getElementById('inc-motivo');

                if (tipoEvento === 'Cancelación') {
                    motivoSelect.setAttribute('required', '');
                    motivoSelect.parentElement.querySelector('label').textContent = 'Motivo (Obligatorio)';
                } else {
                    motivoSelect.removeAttribute('required');
                    motivoSelect.parentElement.querySelector('label').textContent = 'Motivo';
                }
            });

            // Activos
            document.getElementById('btn-nuevo-activo').addEventListener('click', nuevoActivo);
            document.getElementById('form-activo').addEventListener('submit', function (e) {
                e.preventDefault();
                guardarActivo();
            });
            document.getElementById('btn-cancelar-activo').addEventListener('click', cancelarActivo);

            // Validación condicional para activos
            document.getElementById('act-tipo').addEventListener('change', function () {
                const tipo = this.value;
                const busIdInput = document.getElementById('act-bus-id');

                if (tipo === 'LlavesBus') {
                    busIdInput.setAttribute('required', '');
                    busIdInput.parentElement.querySelector('label').textContent = 'Bus ID (Obligatorio)';
                } else {
                    busIdInput.removeAttribute('required');
                    busIdInput.parentElement.querySelector('label').textContent = 'Bus ID (Opcional)';
                }
            });

            // Dashboard
            document.getElementById('btn-aplicar-filtros').addEventListener('click', actualizarDashboard);

            // Informes
            document.getElementById('btn-buscar-informes').addEventListener('click', buscarInformes);

            // Catálogos
            document.getElementById('btn-guardar-config').addEventListener('click', guardarConfiguracion);
            document.getElementById('btn-agregar-turno').addEventListener('click', () => agregarCatalogo('turnos'));
            document.getElementById('btn-agregar-servicio').addEventListener('click', () => agregarCatalogo('servicios'));
            document.getElementById('btn-agregar-tipo-bus').addEventListener('click', () => agregarCatalogo('tiposBus'));
            document.getElementById('btn-agregar-motivo').addEventListener('click', () => agregarCatalogo('motivos'));
            document.getElementById('btn-agregar-estado-tel').addEventListener('click', () => agregarCatalogo('estadosTelefono'));

            // Excel
            document.getElementById('excel-import').addEventListener('change', habilitarImportacion);
            document.getElementById('btn-importar-excel').addEventListener('click', importarExcel);
            document.getElementById('btn-descargar-plantilla').addEventListener('click', descargarPlantilla);
            document.getElementById('btn-exportar-excel').addEventListener('click', exportarExcel);

            // Modal
            document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
            document.getElementById('btn-cerrar-detalle').addEventListener('click', cerrarModal);
            document.getElementById('modal-backdrop').addEventListener('click', cerrarModal);
            document.getElementById('btn-imprimir-detalle').addEventListener('click', imprimirDetalle);
            document.getElementById('btn-exportar-detalle').addEventListener('click', exportarDetalleXLSX);
        }

        // Función para cambiar de pestaña
        function changeTab(tabId) {
            // Guardar la pestaña actual
            appState.currentTab = tabId;

            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Desactivar todas las opciones del menú
            document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Mostrar la pestaña seleccionada
            const tabElement = document.getElementById(`${tabId}-tab`);
            if (tabElement) {
                tabElement.style.display = 'block';
            }

            // Activar la opción del menú correspondiente
            document.querySelectorAll(`.nav-item[data-tab="${tabId}"], .bottom-nav-item[data-tab="${tabId}"]`).forEach(item => {
                item.classList.add('active');
            });

            // Acciones adicionales al cambiar de pestaña
            if (tabId === 'dashboard') {
                actualizarDashboard();
            } else if (tabId === 'informes') {
                buscarInformes();
            } else if (tabId === 'catalogos') {
                cargarCatalogos();
            }
        }

        // Función para mostrar menú adicional en móvil
        function showMoreMenu() {
            const bottomNavItems = [
                { id: 'dashboard', icon: 'bi-graph-up', text: 'Dashboard' },
                { id: 'informes', icon: 'bi-file-text', text: 'Informes' },
                { id: 'catalogos', icon: 'bi-gear', text: 'Catálogos' },
                { id: 'excel', icon: 'bi-file-earmark-excel', text: 'Excel' },
                { id: 'ayuda', icon: 'bi-question-circle', text: 'Ayuda' }
            ];

            // Crear elemento modal
            const moreMenu = document.createElement('div');
            moreMenu.className = 'modal active';
            moreMenu.id = 'more-menu-modal';
            moreMenu.style.width = '80%';
            moreMenu.style.maxWidth = '300px';

            // Crear header
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.innerHTML = `
            <h3 class="modal-title">Menú</h3>
            <button class="modal-close" id="close-more-menu">
              <i class="bi bi-x"></i>
            </button>
          `;
            moreMenu.appendChild(header);

            // Crear body
            const body = document.createElement('div');
            body.className = 'modal-body';

            // Crear items
            bottomNavItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'nav-item';
                menuItem.setAttribute('data-tab', item.id);
                menuItem.innerHTML = `
              <i class="bi ${item.icon}"></i>
              <span>${item.text}</span>
            `;
                body.appendChild(menuItem);
            });

            moreMenu.appendChild(body);

            // Crear backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop active';
            backdrop.id = 'more-menu-backdrop';

            // Agregar al DOM
            document.body.appendChild(backdrop);
            document.body.appendChild(moreMenu);

            // Agregar event listeners
            document.getElementById('close-more-menu').addEventListener('click', closeMoreMenu);
            backdrop.addEventListener('click', closeMoreMenu);

            // Agregar event listeners a los items
            document.querySelectorAll('#more-menu-modal .nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    changeTab(tabId);
                    closeMoreMenu();
                });
            });
            // Función para cerrar el menú adicional
            function closeMoreMenu() {
                document.getElementById('more-menu-modal').remove();
                document.getElementById('more-menu-backdrop').remove();
            }
        }
            // Cargar configuración desde localStorage
            function loadConfigFromStorage() {
                // Catálogos
                if (localStorage.getItem('catalogos')) {
                    try {
                        appState.catalogos = JSON.parse(localStorage.getItem('catalogos'));
                    } catch (e) {
                        console.error('Error al cargar catálogos:', e);
                    }
                }
                // Configuración
                if (localStorage.getItem('config')) {
                    try {
                        appState.config = JSON.parse(localStorage.getItem('config'));
                        // Actualizar inputs de configuración
                        document.getElementById('config-flota-total').value = appState.config.flotaTotal;
                        document.getElementById('config-tolerancia-atraso').value = appState.config.toleranciaAtraso;
                        document.getElementById('config-tolerancia-anticipo').value = appState.config.toleranciaAnticipo;

                        // Actualizar inputs del dashboard
                        document.getElementById('dash-tolerancia-atraso').value = appState.config.toleranciaAtraso;
                        document.getElementById('dash-tolerancia-anticipo').value = appState.config.toleranciaAnticipo;
                    } catch (e) {
                        console.error('Error al cargar configuración:', e);
                    }
                }
            }
            // Verificar conexión a Supabase
            function checkSupabaseConnection() {
                if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                    connectToSupabase();
                } else {
                    console.warn('Supabase config incompleta. Actualice SUPABASE_CONFIG con sus credenciales.');
                }
            }
            // Conexión a Supabase
            async function connectToSupabase() {
                const { url, anonKey } = SUPABASE_CONFIG;
                if (!url || !anonKey) {
                    mostrarToast('Configure SUPABASE_CONFIG.url y SUPABASE_CONFIG.anonKey antes de conectar.', 'error');
                    return;
                }
                try {
                    setConnectionStatus('loading');
                    // Crear cliente Supabase
                    appState.supabase = supabase.createClient(url, anonKey);
                    // Verificar conexión realizando una consulta simple
                    const { data, error } = await appState.supabase
                        .from('turnos')
                        .select('id')
                        .limit(1);

                    if (error) throw error;

                    // Actualizar estado de la aplicación
                    appState.isConnected = true;
                    setConnectionStatus('connected');

                    // Habilitar funcionalidades
                    habilitarFuncionalidades();

                    // Cargar datos iniciales
                    await cargarDatosIniciales();

                    // Verificar si hay un turno activo
                    await verificarTurnoActivo();

                    // Configurar suscripción realtime
                    setupRealtimeSubscription();

                    mostrarToast('Conexión a Supabase establecida correctamente.', 'success');
                } catch (error) {
                    console.error('Error al conectar con Supabase:', error);
                    mostrarToast('Error al conectar con Supabase: ' + error.message, 'error');
                    // Actualizar estado de la aplicación
                    appState.isConnected = false;
                    setConnectionStatus('error');
                }
            }
            // Configurar suscripción realtime
            function setupRealtimeSubscription() {
                // Cancelar suscripción previa si existe
                if (appState.subscription) {
                    appState.subscription.unsubscribe();
                }
                // Crear nueva suscripción
                appState.subscription = appState.supabase
                    .channel('db-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'turnos' }, handleTurnosChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'registros' }, handleRegistrosChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'activos' }, handleActivosChange)
                    .subscribe();
            }
            // Manejadores de eventos realtime
            function handleTurnosChange(payload) {
                console.log('Cambio en turnos:', payload);
                mostrarToast(`Tabla turnos: ${payload.eventType}`, 'info');
                // Si se cerró un turno desde otra sesión y coincide con el turno activo actual
                if (payload.eventType === 'UPDATE' &&
                    payload.new.estado === 'Cerrado' &&
                    appState.turnoActivo &&
                    payload.new.id === appState.turnoActivo.id) {
                    mostrarToast('El turno ha sido cerrado desde otra sesión.', 'warning');
                    resetearEstadoAplicacion();
                }
                // Actualizar lista de informes si estamos en esa pestaña
                if (appState.currentTab === 'informes') {
                    buscarInformes();
                }
                // Verificar si hay un turno activo
                verificarTurnoActivo();
            }
            function handleRegistrosChange(payload) {
                console.log('Cambio en registros:', payload);
                mostrarToast(`Tabla registros: ${payload.eventType}`, 'info');
                // Actualizar tablas y dashboard si es necesario
                if (appState.currentTab === 'despachos') {
                    cargarDespachos();
                } else if (appState.currentTab === 'incidencias') {
                    cargarIncidencias();
                } else if (appState.currentTab === 'dashboard') {
                    actualizarDashboard();
                }
            }
        function handleActivosChange(payload) {
            console.log('Cambio en activos:', payload);
            mostrarToast(`Tabla activos: ${payload.eventType}`, 'info');
            // Actualizar tabla de activos si es necesario
            if (appState.currentTab === 'activos') {
                cargarActivos();
            } else if (appState.currentTab === 'dashboard') {
                actualizarDashboard();
            }
        }
        // Habilitar funcionalidades tras conexión exitosa
        function habilitarFuncionalidades() {
            // Desplegar formularios y vistas
            const operacionTab = document.getElementById('operacion-tab');
            if (operacionTab) {
                operacionTab.classList.remove('d-none');
            }
        }
            // Cargar datos iniciales
            async function cargarDatosIniciales() {
                try {
                    // Cargar despachadores (para filtros)
                    const { data: despachadores, error: errorDespachadores } = await appState.supabase
                        .from('turnos')
                        .select('despachador')
                        .not('despachador', 'is', null)
                        .neq('despachador', '')
                        .order('despachador');
                    if (errorDespachadores) throw errorDespachadores;

                    if (despachadores) {
                        // Filtrar valores únicos
                        appState.despachadores = [...new Set(despachadores.map(d => d.despachador))];

                        // Actualizar select de despachadores en informes
                        const selectDespachador = document.getElementById('inf-despachador');
                        selectDespachador.innerHTML = '<option value="">Todos</option>';

                        appState.despachadores.forEach(despachador => {
                            const option = document.createElement('option');
                            option.value = despachador;
                            option.textContent = despachador;
                            selectDespachador.appendChild(option);
                        });
                    }

                    // Cargar catálogos
                    cargarCatalogos();
                } catch (error) {
                    console.error('Error al cargar datos iniciales:', error);
                    mostrarToast('Error al cargar datos iniciales: ' + error.message, 'error');
                }
            }
            // Verificar si hay un turno activo
            async function verificarTurnoActivo() {
                try {
                    const { data: turnos, error } = await appState.supabase
                        .from('turnos')
                        .select('*')
                        .eq('estado', 'Activo')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    if (error) throw error;

                    if (turnos && turnos.length > 0) {
                        // Hay un turno activo
                        appState.turnoActivo = turnos[0];
                        appState.shiftId = turnos[0].id;

                        // Actualizar UI
                        actualizarUIConTurnoActivo();

                        // Cargar datos del turno
                        cargarDatosTurno();
                    } else {
                        // No hay turno activo
                        appState.turnoActivo = null;
                        appState.shiftId = null;

                        // Actualizar UI para "Sin turno activo"
                        actualizarUISinTurnoActivo();
                    }
                } catch (error) {
                    console.error('Error al verificar turno activo:', error);
                    mostrarToast('Error al verificar turno activo: ' + error.message, 'error');
                }
            }
            // Actualizar UI con turno activo
            function actualizarUIConTurnoActivo() {
                // Actualizar badge
                document.getElementById('turno-activo-badge').innerHTML = `<span class="badge badge-success">Turno Activo: ${appState.turnoActivo.fecha} - ${appState.turnoActivo.turno} - ${appState.turnoActivo.despachador}</span>`;
                // Habilitar formularios y botones
                document.getElementById('btn-iniciar-turno').disabled = true;
                document.getElementById('btn-guardar-inicio').disabled = false;
                document.getElementById('btn-cancelar-turno').disabled = false;
                document.getElementById('btn-cerrar-turno').disabled = false;
                document.getElementById('btn-resumen-turno').disabled = false;
                // Habilitar campos de cierre
                document.getElementById('tel-fin').disabled = false;
                document.getElementById('llaves-fin').disabled = false;
                document.getElementById('op-fin').disabled = false;
                document.getElementById('man-fin').disabled = false;
                document.getElementById('notas-cierre').disabled = false;
                // Habilitar botones de Despachos, Incidencias y Activos
                document.getElementById('btn-nuevo-despacho').disabled = false;
                document.getElementById('btn-nueva-incidencia').disabled = false;
                document.getElementById('btn-nuevo-activo').disabled = false;
                // Completar formulario de inicio
                document.getElementById('fecha').value = appState.turnoActivo.fecha;
                document.getElementById('turno').value = appState.turnoActivo.turno;
                document.getElementById('despachador').value = appState.turnoActivo.despachador;
                document.getElementById('tel-inicio').value = appState.turnoActivo.tel_inicio || '';
                document.getElementById('llaves-ini').value = appState.turnoActivo.llaves_ini;
                document.getElementById('op-ini').value = appState.turnoActivo.op_ini;
                document.getElementById('man-ini').value = appState.turnoActivo.man_ini;
                document.getElementById('diff-ini').value = appState.turnoActivo.diff_ini;
                // Deshabilitar campos de inicio
                document.getElementById('fecha').disabled = true;
                document.getElementById('turno').disabled = true;
                document.getElementById('despachador').disabled = true;
                document.getElementById('tel-inicio').disabled = true;
                document.getElementById('llaves-ini').disabled = true;
                document.getElementById('op-ini').disabled = true;
                document.getElementById('man-ini').disabled = true;
            }
            // Actualizar UI sin turno activo
            function actualizarUISinTurnoActivo() {
                // Actualizar badge
                document.getElementById('turno-activo-badge').innerHTML = '<span class="badge badge-warning">Sin turno activo</span>';
                // Habilitar/deshabilitar formularios y botones
                document.getElementById('btn-iniciar-turno').disabled = false;
                document.getElementById('btn-guardar-inicio').disabled = true;
                document.getElementById('btn-cancelar-turno').disabled = true;
                document.getElementById('btn-cerrar-turno').disabled = true;
                document.getElementById('btn-resumen-turno').disabled = true;
                // Habilitar campos de inicio
                document.getElementById('fecha').disabled = false;
                document.getElementById('turno').disabled = false;
                document.getElementById('despachador').disabled = false;
                document.getElementById('tel-inicio').disabled = false;
                document.getElementById('llaves-ini').disabled = false;
                document.getElementById('op-ini').disabled = false;
                document.getElementById('man-ini').disabled = false;
                // Deshabilitar campos de cierre
                document.getElementById('tel-fin').disabled = true;
                document.getElementById('llaves-fin').disabled = true;
                document.getElementById('op-fin').disabled = true;
                document.getElementById('man-fin').disabled = true;
                document.getElementById('notas-cierre').disabled = true;
                // Deshabilitar botones de Despachos, Incidencias y Activos
                document.getElementById('btn-nuevo-despacho').disabled = true;
                document.getElementById('btn-nueva-incidencia').disabled = true;
                document.getElementById('btn-nuevo-activo').disabled = true;
                // Limpiar tablas
                limpiarTablas();
            }
            // Cargar datos del turno
            async function cargarDatosTurno() {
                if (!appState.shiftId) return;
                try {
                    // Cargar despachos
                    cargarDespachos();
                    // Cargar incidencias
                    cargarIncidencias();

                    // Cargar activos
                    cargarActivos();
                } catch (error) {
                    console.error('Error al cargar datos del turno:', error);
                    mostrarToast('Error al cargar datos del turno: ' + error.message, 'error');
                }
            }
            // Iniciar turno
            async function iniciarTurno() {
                if (!appState.supabase) {
                    mostrarToast('Conéctese a Supabase antes de iniciar un turno.', 'warning');
                    return;
                }
                // Validar formulario
                const fecha = document.getElementById('fecha').value;
                const turno = document.getElementById('turno').value;
                const despachador = document.getElementById('despachador').value;
                const telInicio = document.getElementById('tel-inicio').value;
                const llavesIni = parseInt(document.getElementById('llaves-ini').value) || 0;
                const opIni = parseInt(document.getElementById('op-ini').value) || 0;
                const manIni = parseInt(document.getElementById('man-ini').value) || 0;
                if (!fecha || !turno || !despachador || !telInicio) {
                    mostrarToast('Por favor, complete todos los campos obligatorios.', 'warning');
                    return;
                }
                // Calcular diferencia
                const diffIni = appState.config.flotaTotal - (opIni + manIni);
                // Validar que no sea negativo
                if (diffIni < 0) {
                    mostrarToast(`La suma de buses operativos y en mantenimiento (${opIni + manIni}) no puede superar la flota total (${appState.config.flotaTotal}).`, 'error');
                    return;
                }
                try {
                    // Verificar si ya hay un turno activo
                    const { data: turnosActivos, error: errorTurnos } = await appState.supabase
                        .from('turnos')
                        .select('id')
                        .eq('estado', 'Activo')
                        .limit(1);
                    if (errorTurnos) {
                        mostrarToast('Error al verificar turnos activos: ' + errorTurnos.message, 'error');
                        return;
                    }
                    if (turnosActivos && turnosActivos.length > 0) {
                        mostrarToast('Ya existe un turno activo. No se puede iniciar otro.', 'warning');
                        return;
                    }

                    // Crear turno
                    const { data, error } = await appState.supabase
                        .from('turnos')
                        .insert([
                            {
                                fecha,
                                turno,
                                despachador,
                                tel_inicio: telInicio,
                                llaves_ini: llavesIni,
                                op_ini: opIni,
                                man_ini: manIni,
                                diff_ini: diffIni,
                                estado: 'Activo'
                            }
                        ])
                        .select()
                        .single();

                    if (error) throw error;

                    appState.turnoActivo = data;
                    appState.shiftId = data.id;

                    mostrarToast('Turno iniciado correctamente.', 'success');

                    // Actualizar UI
                    actualizarUIConTurnoActivo();
                } catch (error) {
                    console.error('Error al iniciar turno:', error);
                    mostrarToast('Error al iniciar turno: ' + error.message, 'error');
                }
            }
        // Guardar cambios en inicio de turno
        async function guardarInicio() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Obtener valores actualizados
            const telInicio = document.getElementById('tel-inicio').value;
            const llavesIni = parseInt(document.getElementById('llaves-ini').value) || 0;
            const opIni = parseInt(document.getElementById('op-ini').value) || 0;
            const manIni = parseInt(document.getElementById('man-ini').value) || 0;
            // Calcular diferencia
            const diffIni = appState.config.flotaTotal - (opIni + manIni);
            // Validar que no sea negativo
            if (diffIni < 0) {
                mostrarToast(`La suma de buses operativos y en mantenimiento (${opIni + manIni}) no puede superar la flota total (${appState.config.flotaTotal}).`, 'error');
                return;
            }
            try {
                const { error } = await appState.supabase
                    .from('turnos')
                    .update({
                        tel_inicio: telInicio,
                        llaves_ini: llavesIni,
                        op_ini: opIni,
                        man_ini: manIni,
                        diff_ini: diffIni
                    })
                    .eq('id', appState.shiftId)
                    .eq('estado', 'Activo');
                if (error) throw error;

                mostrarToast('Datos de inicio actualizados correctamente.', 'success');

                // Actualizar estado local
                appState.turnoActivo.tel_inicio = telInicio;
                appState.turnoActivo.llaves_ini = llavesIni;
                appState.turnoActivo.op_ini = opIni;
                appState.turnoActivo.man_ini = manIni;
                appState.turnoActivo.diff_ini = diffIni;
            } catch (error) {
                console.error('Error al guardar datos de inicio:', error);
                mostrarToast('Error al guardar datos de inicio: ' + error.message, 'error');
            }
        }
        // Cancelar turno
        async function cancelarTurno() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            if (!confirm('¿Está seguro de cancelar el turno actual? Esta acción eliminará todos los registros asociados.')) {
                return;
            }
            try {
                // Eliminar turno (las políticas RLS en Supabase se encargan de eliminar los registros en cascada)
                const { error } = await appState.supabase
                    .from('turnos')
                    .delete()
                    .eq('id', appState.shiftId)
                    .eq('estado', 'Activo');
                if (error) throw error;

                mostrarToast('Turno cancelado correctamente.', 'success');

                // Resetear estado
                resetearEstadoAplicacion();
            } catch (error) {
                console.error('Error al cancelar turno:', error);
                mostrarToast('Error al cancelar turno: ' + error.message, 'error');
            }
        }
        // Cerrar turno
        async function cerrarTurno() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Validar formulario de cierre
            const telFin = document.getElementById('tel-fin').value;
            const llavesFin = parseInt(document.getElementById('llaves-fin').value) || 0;
            const opFin = parseInt(document.getElementById('op-fin').value) || 0;
            const manFin = parseInt(document.getElementById('man-fin').value) || 0;
            const notasCierre = document.getElementById('notas-cierre').value;
            if (!telFin) {
                mostrarToast('Por favor, complete el estado del teléfono al cierre.', 'warning');
                return;
            }
            // Calcular diferencia
            const diffFin = appState.config.flotaTotal - (opFin + manFin);
            // Validar que no sea negativo
            if (diffFin < 0) {
                mostrarToast(`La suma de buses operativos y en mantenimiento (${opFin + manFin}) no puede superar la flota total (${appState.config.flotaTotal}).`, 'error');
                return;
            }
            if (!confirm('¿Está seguro de cerrar el turno actual? Ya no podrá realizar cambios en los registros asociados.')) {
                return;
            }
            try {
                const { error } = await appState.supabase
                    .from('turnos')
                    .update({
                        tel_fin: telFin,
                        llaves_fin: llavesFin,
                        op_fin: opFin,
                        man_fin: manFin,
                        diff_fin: diffFin,
                        notas_cierre: notasCierre,
                        estado: 'Cerrado',
                        closed_at: new Date().toISOString()
                    })
                    .eq('id', appState.shiftId)
                    .eq('estado', 'Activo');
                if (error) throw error;

                mostrarToast('Turno cerrado correctamente.', 'success');

                // Resetear estado
                resetearEstadoAplicacion();

                // Cambiar a pestaña de informes
                changeTab('informes');
            } catch (error) {
                console.error('Error al cerrar turno:', error);
                mostrarToast('Error al cerrar turno: ' + error.message, 'error');
            }
        }
        // Resetear estado de la aplicación
        function resetearEstadoAplicacion() {
            // Resetear estado
            appState.turnoActivo = null;
            appState.shiftId = null;
            // Limpiar formularios
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('turno').value = '';
            document.getElementById('despachador').value = '';
            document.getElementById('tel-inicio').value = '';
            document.getElementById('llaves-ini').value = '0';
            document.getElementById('op-ini').value = '0';
            document.getElementById('man-ini').value = '0';
            document.getElementById('diff-ini').value = '';
            document.getElementById('tel-fin').value = '';
            document.getElementById('llaves-fin').value = '0';
            document.getElementById('op-fin').value = '0';
            document.getElementById('man-fin').value = '0';
            document.getElementById('diff-fin').value = '';
            document.getElementById('notas-cierre').value = '';
            // Actualizar UI
            actualizarUISinTurnoActivo();
            // Limpiar tablas
            limpiarTablas();
        }
        // Limpiar tablas
        function limpiarTablas() {
            document.querySelector('#tabla-despachos tbody').innerHTML = '';
            document.querySelector('#tabla-incidencias tbody').innerHTML = '';
            document.querySelector('#tabla-activos tbody').innerHTML = '';
        }
        // Mostrar resumen de turno
        function mostrarResumenTurno() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Cargar detalle del turno
            cargarDetalleTurno(appState.shiftId);
        }
        // Calcular diferencia inicial
        function calcularDiferenciaInicial() {
            const opIni = parseInt(document.getElementById('op-ini').value) || 0;
            const manIni = parseInt(document.getElementById('man-ini').value) || 0;
            const diffIni = appState.config.flotaTotal - (opIni + manIni);
            document.getElementById('diff-ini').value = diffIni;
            // Validar que no sea negativo
            if (diffIni < 0) {
                document.getElementById('diff-ini').classList.add('text-danger');
            } else {
                document.getElementById('diff-ini').classList.remove('text-danger');
            }
        }
        // Calcular diferencia final
        function calcularDiferenciaFinal() {
            const opFin = parseInt(document.getElementById('op-fin').value) || 0;
            const manFin = parseInt(document.getElementById('man-fin').value) || 0;
            const diffFin = appState.config.flotaTotal - (opFin + manFin);
            document.getElementById('diff-fin').value = diffFin;
            // Validar que no sea negativo
            if (diffFin < 0) {
                document.getElementById('diff-fin').classList.add('text-danger');
            } else {
                document.getElementById('diff-fin').classList.remove('text-danger');
            }
        }
            // Mostrar toast de notificación
            function mostrarToast(mensaje, tipo) {
                const toastContainer = document.querySelector('.toast-container');
                // Crear elemento toast
                const toast = document.createElement('div');
                toast.className = `toast toast-${tipo}`;
                toast.innerHTML = mensaje;
            // Agregar al container
            toastContainer.appendChild(toast);
            // Eliminar después de 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        // ===== DESPACHOS =====
        // Cargar despachos
        async function cargarDespachos() {
            if (!appState.shiftId) return;
            try {
                const { data, error } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('shift_id', appState.shiftId)
                    .eq('categoria', 'Despacho')
                    .order('created_at', { ascending: false });
                if (error) throw error;

                // Limpiar tabla
                const tbody = document.querySelector('#tabla-despachos tbody');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Llenar tabla
                    data.forEach(despacho => {
                        const tr = document.createElement('tr');

                        // Calcular retraso
                        const retrasoMin = despacho.retraso_min || 0;
                        const retrasoClass = despacho.on_time ? 'chip-good' : (Math.abs(retrasoMin) <= 10 ? 'chip-warn' : 'chip-bad');
                        const retrasoPrefix = retrasoMin < 0 ? '-' : '+';

                        tr.innerHTML = `
      <td>${despacho.servicio}</td>
      <td>${despacho.tipo_evento === 'PrimeraSalida' ? 'Primera' : 'Última'}</td>
      <td>${despacho.bus_id || '-'}</td>
      <td>${despacho.conductor || '-'}</td>
      <td>${despacho.hora_prog}${despacho.next_day ? ' (+1)' : ''}</td>
      <td>${despacho.hora_real}${despacho.next_day ? ' (+1)' : ''}</td>
      <td><span class="chip ${retrasoClass}">Δ ${retrasoPrefix}${Math.abs(retrasoMin)} min</span></td>
      <td>
        <div class="table-actions">
          <button class="btn btn-sm btn-outline-primary btn-editar-despacho" data-id="${despacho.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-eliminar-despacho" data-id="${despacho.id}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    `;

                        tbody.appendChild(tr);
                    });

                    // Agregar event listeners para edición y eliminación
                    document.querySelectorAll('.btn-editar-despacho').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            editarDespacho(id);
                        });
                    });

                    document.querySelectorAll('.btn-eliminar-despacho').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            eliminarDespacho(id);
                        });
                    });
                }
            } catch (error) {
                console.error('Error al cargar despachos:', error);
                mostrarToast('Error al cargar despachos: ' + error.message, 'error');
            }
        }
        // Nuevo despacho
        function nuevoDespacho() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Resetear formulario
            document.getElementById('form-despacho').reset();
            // Establecer valores por defecto
            document.getElementById('desp-fecha').value = appState.turnoActivo.fecha;
            document.getElementById('desp-turno').value = appState.turnoActivo.turno;
            const despachadorInput = document.getElementById('desp-despachador');
            if (despachadorInput) {
                despachadorInput.value = appState.turnoActivo.despachador || '';
            }
            // Habilitar campos
            const inputs = document.getElementById('form-despacho').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            // Habilitar botones
            document.getElementById('btn-guardar-despacho').disabled = false;
            document.getElementById('btn-cancelar-despacho').disabled = false;
            // Resetear ID de edición
            appState.editingId = null;
            // Cambiar texto del botón
            document.getElementById('btn-guardar-despacho').innerHTML = '<i class="bi bi-save"></i> Guardar Despacho';
        }
        // Guardar despacho
        async function guardarDespacho() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Validar formulario
            const fecha = document.getElementById('desp-fecha').value;
            const turno = document.getElementById('desp-turno').value;
            const servicio = document.getElementById('desp-servicio').value;
            const tipoBus = document.getElementById('desp-tipo-bus').value;
            const busId = document.getElementById('desp-bus-id').value;
            const conductor = document.getElementById('desp-conductor').value;
            const tipoEvento = document.getElementById('desp-tipo-evento').value;
            const horaProg = document.getElementById('desp-hora-prog').value;
            const horaReal = document.getElementById('desp-hora-real').value;
            const nextDay = document.getElementById('desp-next-day').checked;
            const obs = document.getElementById('desp-obs').value;
            if (!fecha || !turno || !servicio || !tipoEvento || !horaProg || !horaReal) {
                mostrarToast('Por favor, complete todos los campos obligatorios.', 'warning');
                return;
            }
            // Validar formato de hora
            const horaProgValida = /^([01]\d|2[0-3]):([0-5]\d)$/.test(horaProg);
            const horaRealValida = /^([01]\d|2[0-3]):([0-5]\d)$/.test(horaReal);
            if (!horaProgValida || !horaRealValida) {
                mostrarToast('Formato de hora incorrecto. Use el formato HH:MM.', 'warning');
                return;
            }
            // Calcular retraso en minutos
            const retrasoMin = calcularRetrasoMinutos(horaProg, horaReal, nextDay);
            // Determinar si está a tiempo según tolerancias
            const onTime = Math.abs(retrasoMin) <=
                (retrasoMin > 0 ? appState.config.toleranciaAtraso : appState.config.toleranciaAnticipo);
            // Preparar datos
            const despachoData = {
                shift_id: appState.shiftId,
                categoria: 'Despacho',
                fecha,
                turno,
                servicio,
                tipo_bus: tipoBus,
                bus_id: busId,
                conductor,
                despachador: appState.turnoActivo.despachador,
                tipo_evento: tipoEvento,
                hora_prog: horaProg,
                hora_real: horaReal,
                next_day: nextDay,
                obs,
                retraso_min: retrasoMin,
                on_time: onTime
            };
            try {
                let error;
                if (appState.editingId) {
                    // Actualizar despacho existente
                    const { error: updateError } = await appState.supabase
                        .from('registros')
                        .update(despachoData)
                        .eq('id', appState.editingId)
                        .eq('categoria', 'Despacho');

                    error = updateError;
                    if (!error) mostrarToast('Despacho actualizado correctamente.', 'success');
                } else {
                    // Insertar nuevo despacho
                    const { error: insertError } = await appState.supabase
                        .from('registros')
                        .insert([despachoData]);

                    error = insertError;
                    if (!error) mostrarToast('Despacho registrado correctamente.', 'success');
                }

                if (error) throw error;

                // Resetear formulario y estado
                document.getElementById('form-despacho').reset();
                appState.editingId = null;

                // Deshabilitar campos
                const inputs = document.getElementById('form-despacho').querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                });

                // Deshabilitar botones
                document.getElementById('btn-guardar-despacho').disabled = true;
                document.getElementById('btn-cancelar-despacho').disabled = true;

                // Recargar tabla
                cargarDespachos();
            } catch (error) {
                console.error('Error al guardar despacho:', error);
                mostrarToast('Error al guardar despacho: ' + error.message, 'error');
            }
        }
        // Editar despacho
        async function editarDespacho(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            try {
                const { data, error } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('id', id)
                    .eq('categoria', 'Despacho')
                    .single();
                if (error) throw error;

                if (data) {
                    // Guardar ID de edición
                    appState.editingId = id;

                    // Llenar formulario
                    document.getElementById('desp-fecha').value = data.fecha;
                    document.getElementById('desp-turno').value = data.turno;
                    document.getElementById('desp-servicio').value = data.servicio;
                    document.getElementById('desp-tipo-bus').value = data.tipo_bus || '';
                    document.getElementById('desp-bus-id').value = data.bus_id || '';
                    document.getElementById('desp-conductor').value = data.conductor || '';
                    document.getElementById('desp-tipo-evento').value = data.tipo_evento;
                    document.getElementById('desp-hora-prog').value = data.hora_prog;
                    document.getElementById('desp-hora-real').value = data.hora_real;
                    document.getElementById('desp-next-day').checked = data.next_day;
                    document.getElementById('desp-obs').value = data.obs || '';

                    // Habilitar campos
                    const inputs = document.getElementById('form-despacho').querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                    });

                    // Habilitar botones
                    document.getElementById('btn-guardar-despacho').disabled = false;
                    document.getElementById('btn-cancelar-despacho').disabled = false;

                    // Cambiar texto del botón
                    document.getElementById('btn-guardar-despacho').innerHTML = '<i class="bi bi-save"></i> Actualizar Despacho';
                }
            } catch (error) {
                console.error('Error al cargar despacho para edición:', error);
                mostrarToast('Error al cargar despacho: ' + error.message, 'error');
            }
        }
        // Eliminar despacho
        async function eliminarDespacho(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            if (!confirm('¿Está seguro de eliminar este despacho? Esta acción no se puede deshacer.')) {
                return;
            }
            try {
                const { error } = await appState.supabase
                    .from('registros')
                    .delete()
                    .eq('id', id)
                    .eq('categoria', 'Despacho');
                if (error) throw error;

                mostrarToast('Despacho eliminado correctamente.', 'success');

                // Recargar tabla
                cargarDespachos();
            } catch (error) {
                console.error('Error al eliminar despacho:', error);
                mostrarToast('Error al eliminar despacho: ' + error.message, 'error');
            }
        }
        // Cancelar edición de despacho
        function cancelarDespacho() {
            // Resetear formulario
            document.getElementById('form-despacho').reset();
            // Deshabilitar campos
            const inputs = document.getElementById('form-despacho').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            // Deshabilitar botones
            document.getElementById('btn-guardar-despacho').disabled = true;
            document.getElementById('btn-cancelar-despacho').disabled = true;
            // Resetear ID de edición
            appState.editingId = null;
        }
        // ===== INCIDENCIAS =====
        // Cargar incidencias
        async function cargarIncidencias() {
            if (!appState.shiftId) return;
            try {
                const { data, error } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('shift_id', appState.shiftId)
                    .eq('categoria', 'Incidencia')
                    .order('created_at', { ascending: false });
                if (error) throw error;

                // Limpiar tabla
                const tbody = document.querySelector('#tabla-incidencias tbody');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Llenar tabla
                    data.forEach(incidencia => {
                        const tr = document.createElement('tr');

                        tr.innerHTML = `
      <td>${incidencia.fecha}</td>
      <td>${incidencia.servicio}</td>
      <td>${incidencia.bus_id || '-'}</td>
      <td>${incidencia.tipo_evento}</td>
      <td>${incidencia.motivo || '-'}</td>
      <td>${incidencia.obs || '-'}</td>
      <td>
        <div class="table-actions">
          <button class="btn btn-sm btn-outline-primary btn-editar-incidencia" data-id="${incidencia.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-eliminar-incidencia" data-id="${incidencia.id}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    `;

                        tbody.appendChild(tr);
                    });

                    // Agregar event listeners para edición y eliminación
                    document.querySelectorAll('.btn-editar-incidencia').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            editarIncidencia(id);
                        });
                    });

                    document.querySelectorAll('.btn-eliminar-incidencia').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            eliminarIncidencia(id);
                        });
                    });
                }
            } catch (error) {
                console.error('Error al cargar incidencias:', error);
                mostrarToast('Error al cargar incidencias: ' + error.message, 'error');
            }
        }
        // Nueva incidencia
        function nuevaIncidencia() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Resetear formulario
            document.getElementById('form-incidencia').reset();
            // Establecer valores por defecto
            document.getElementById('inc-fecha').value = appState.turnoActivo.fecha;
            document.getElementById('inc-turno').value = appState.turnoActivo.turno;
            // Habilitar campos
            const inputs = document.getElementById('form-incidencia').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            // Habilitar botones
            document.getElementById('btn-guardar-incidencia').disabled = false;
            document.getElementById('btn-cancelar-incidencia').disabled = false;
            // Resetear ID de edición
            appState.editingId = null;
            // Cambiar texto del botón
            document.getElementById('btn-guardar-incidencia').innerHTML = '<i class="bi bi-save"></i> Guardar Incidencia';
        }
        // Guardar incidencia
        async function guardarIncidencia() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Validar formulario
            const fecha = document.getElementById('inc-fecha').value;
            const turno = document.getElementById('inc-turno').value;
            const servicio = document.getElementById('inc-servicio').value;
            const busId = document.getElementById('inc-bus-id').value;
            const tipoEvento = document.getElementById('inc-tipo-evento').value;
            const motivo = document.getElementById('inc-motivo').value;
            const obs = document.getElementById('inc-obs').value;
            if (!fecha || !turno || !servicio || !tipoEvento) {
                mostrarToast('Por favor, complete todos los campos obligatorios.', 'warning');
                return;
            }
            // Validar motivo obligatorio para cancelaciones
            if (tipoEvento === 'Cancelación' && !motivo) {
                mostrarToast('El motivo es obligatorio para las cancelaciones.', 'warning');
                return;
            }
            // Preparar datos
            const incidenciaData = {
                shift_id: appState.shiftId,
                categoria: 'Incidencia',
                fecha,
                turno,
                servicio,
                bus_id: busId,
                despachador: appState.turnoActivo.despachador,
                tipo_evento: tipoEvento,
                motivo,
                obs
            };
            try {
                let error;
                if (appState.editingId) {
                    // Actualizar incidencia existente
                    const { error: updateError } = await appState.supabase
                        .from('registros')
                        .update(incidenciaData)
                        .eq('id', appState.editingId)
                        .eq('categoria', 'Incidencia');

                    error = updateError;
                    if (!error) mostrarToast('Incidencia actualizada correctamente.', 'success');
                } else {
                    // Insertar nueva incidencia
                    const { error: insertError } = await appState.supabase
                        .from('registros')
                        .insert([incidenciaData]);

                    error = insertError;
                    if (!error) mostrarToast('Incidencia registrada correctamente.', 'success');
                }

                if (error) throw error;

                // Resetear formulario y estado
                document.getElementById('form-incidencia').reset();
                appState.editingId = null;

                // Deshabilitar campos
                const inputs = document.getElementById('form-incidencia').querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                });

                // Deshabilitar botones
                document.getElementById('btn-guardar-incidencia').disabled = true;
                document.getElementById('btn-cancelar-incidencia').disabled = true;

                // Recargar tabla
                cargarIncidencias();
            } catch (error) {
                console.error('Error al guardar incidencia:', error);
                mostrarToast('Error al guardar incidencia: ' + error.message, 'error');
            }
        }
        // Editar incidencia
        async function editarIncidencia(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            try {
                const { data, error } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('id', id)
                    .eq('categoria', 'Incidencia')
                    .single();
                if (error) throw error;

                if (data) {
                    // Guardar ID de edición
                    appState.editingId = id;

                    // Llenar formulario
                    document.getElementById('inc-fecha').value = data.fecha;
                    document.getElementById('inc-turno').value = data.turno;
                    document.getElementById('inc-servicio').value = data.servicio;
                    document.getElementById('inc-bus-id').value = data.bus_id || '';
                    document.getElementById('inc-tipo-evento').value = data.tipo_evento;
                    document.getElementById('inc-motivo').value = data.motivo || '';
                    document.getElementById('inc-obs').value = data.obs || '';

                    // Actualizar validación condicional
                    if (data.tipo_evento === 'Cancelación') {
                        document.getElementById('inc-motivo').setAttribute('required', '');
                        document.getElementById('inc-motivo').parentElement.querySelector('label').textContent = 'Motivo (Obligatorio)';
                    } else {
                        document.getElementById('inc-motivo').removeAttribute('required');
                        document.getElementById('inc-motivo').parentElement.querySelector('label').textContent = 'Motivo';
                    }

                    // Habilitar campos
                    const inputs = document.getElementById('form-incidencia').querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                    });

                    // Habilitar botones
                    document.getElementById('btn-guardar-incidencia').disabled = false;
                    document.getElementById('btn-cancelar-incidencia').disabled = false;

                    // Cambiar texto del botón
                    document.getElementById('btn-guardar-incidencia').innerHTML = '<i class="bi bi-save"></i> Actualizar Incidencia';
                }
            } catch (error) {
                console.error('Error al cargar incidencia para edición:', error);
                mostrarToast('Error al cargar incidencia: ' + error.message, 'error');
            }
        }
        // Eliminar incidencia
        async function eliminarIncidencia(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            if (!confirm('¿Está seguro de eliminar esta incidencia? Esta acción no se puede deshacer.')) {
                return;
            }
            try {
                const { error } = await appState.supabase
                    .from('registros')
                    .delete()
                    .eq('id', id)
                    .eq('categoria', 'Incidencia');
                if (error) throw error;

                mostrarToast('Incidencia eliminada correctamente.', 'success');

                // Recargar tabla
                cargarIncidencias();
            } catch (error) {
                console.error('Error al eliminar incidencia:', error);
                mostrarToast('Error al eliminar incidencia: ' + error.message, 'error');
            }
        }
        // Cancelar edición de incidencia
        function cancelarIncidencia() {
            // Resetear formulario
            document.getElementById('form-incidencia').reset();
            // Deshabilitar campos
            const inputs = document.getElementById('form-incidencia').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            // Deshabilitar botones
            document.getElementById('btn-guardar-incidencia').disabled = true;
            document.getElementById('btn-cancelar-incidencia').disabled = true;
            // Resetear ID de edición
            appState.editingId = null;
        }
        // ===== ACTIVOS =====
        // Cargar activos
        async function cargarActivos() {
            if (!appState.shiftId) return;
            try {
                const { data, error } = await appState.supabase
                    .from('activos')
                    .select('*')
                    .eq('shift_id', appState.shiftId)
                    .order('created_at', { ascending: false });
                if (error) throw error;

                // Limpiar tabla
                const tbody = document.querySelector('#tabla-activos tbody');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Llenar tabla
                    data.forEach(activo => {
                        const tr = document.createElement('tr');

                        // Determinar clase para estado
                        let estadoClass;
                        switch (activo.estado) {
                            case 'OK':
                                estadoClass = 'badge-success';
                                break;
                            case 'Falla':
                                estadoClass = 'badge-warning';
                                break;
                            case 'Faltante':
                                estadoClass = 'badge-danger';
                                break;
                            case 'Entregado':
                                estadoClass = 'badge-info';
                                break;
                            case 'Pendiente':
                                estadoClass = 'badge-secondary';
                                break;
                            default:
                                estadoClass = 'badge-secondary';
                        }

                        tr.innerHTML = `
      <td>${activo.tipo}</td>
      <td>${activo.bus_id || '-'}</td>
      <td><span class="badge ${estadoClass}">${activo.estado}</span></td>
      <td>${activo.obs || '-'}</td>
      <td>
        <div class="table-actions">
          <button class="btn btn-sm btn-outline-primary btn-editar-activo" data-id="${activo.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger btn-eliminar-activo" data-id="${activo.id}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    `;

                        tbody.appendChild(tr);
                    });

                    // Agregar event listeners para edición y eliminación
                    document.querySelectorAll('.btn-editar-activo').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            editarActivo(id);
                        });
                    });

                    document.querySelectorAll('.btn-eliminar-activo').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            eliminarActivo(id);
                        });
                    });
                }
            } catch (error) {
                console.error('Error al cargar activos:', error);
                mostrarToast('Error al cargar activos: ' + error.message, 'error');
            }
        }
        // Nuevo activo
        function nuevoActivo() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Resetear formulario
            document.getElementById('form-activo').reset();
            // Establecer valores por defecto
            document.getElementById('act-fecha').value = appState.turnoActivo.fecha;
            document.getElementById('act-turno').value = appState.turnoActivo.turno;
            // Habilitar campos
            const inputs = document.getElementById('form-activo').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            // Habilitar botones
            document.getElementById('btn-guardar-activo').disabled = false;
            document.getElementById('btn-cancelar-activo').disabled = false;
            // Resetear ID de edición
            appState.editingId = null;
            // Cambiar texto del botón
            document.getElementById('btn-guardar-activo').innerHTML = '<i class="bi bi-save"></i> Guardar Activo';
        }
        // Guardar activo
        async function guardarActivo() {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            // Validar formulario
            const fecha = document.getElementById('act-fecha').value;
            const turno = document.getElementById('act-turno').value;
            const tipo = document.getElementById('act-tipo').value;
            const busId = document.getElementById('act-bus-id').value;
            const estado = document.getElementById('act-estado').value;
            const obs = document.getElementById('act-obs').value;
            if (!fecha || !turno || !tipo || !estado) {
                mostrarToast('Por favor, complete todos los campos obligatorios.', 'warning');
                return;
            }
            // Validar bus ID obligatorio para llaves
            if (tipo === 'LlavesBus' && !busId) {
                mostrarToast('El ID del bus es obligatorio para los activos de tipo Llaves.', 'warning');
                return;
            }
            // Preparar datos
            const activoData = {
                shift_id: appState.shiftId,
                fecha,
                turno,
                tipo,
                bus_id: busId,
                estado,
                obs
            };
            try {
                let error;
                if (appState.editingId) {
                    // Actualizar activo existente
                    const { error: updateError } = await appState.supabase
                        .from('activos')
                        .update(activoData)
                        .eq('id', appState.editingId);

                    error = updateError;
                    if (!error) mostrarToast('Activo actualizado correctamente.', 'success');
                } else {
                    // Insertar nuevo activo
                    const { error: insertError } = await appState.supabase
                        .from('activos')
                        .insert([activoData]);

                    error = insertError;
                    if (!error) mostrarToast('Activo registrado correctamente.', 'success');
                }

                if (error) throw error;

                // Resetear formulario y estado
                document.getElementById('form-activo').reset();
                appState.editingId = null;

                // Deshabilitar campos
                const inputs = document.getElementById('form-activo').querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                });

                // Deshabilitar botones
                document.getElementById('btn-guardar-activo').disabled = true;
                document.getElementById('btn-cancelar-activo').disabled = true;

                // Recargar tabla
                cargarActivos();
            } catch (error) {
                console.error('Error al guardar activo:', error);
                mostrarToast('Error al guardar activo: ' + error.message, 'error');
            }
        }
        // Editar activo
        async function editarActivo(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            try {
                const { data, error } = await appState.supabase
                    .from('activos')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) throw error;

                if (data) {
                    // Guardar ID de edición
                    appState.editingId = id;

                    // Llenar formulario
                    document.getElementById('act-fecha').value = data.fecha;
                    document.getElementById('act-turno').value = data.turno;
                    document.getElementById('act-tipo').value = data.tipo;
                    document.getElementById('act-bus-id').value = data.bus_id || '';
                    document.getElementById('act-estado').value = data.estado;
                    document.getElementById('act-obs').value = data.obs || '';

                    // Actualizar validación condicional
                    if (data.tipo === 'LlavesBus') {
                        document.getElementById('act-bus-id').setAttribute('required', '');
                        document.getElementById('act-bus-id').parentElement.querySelector('label').textContent = 'Bus ID (Obligatorio)';
                    } else {
                        document.getElementById('act-bus-id').removeAttribute('required');
                        document.getElementById('act-bus-id').parentElement.querySelector('label').textContent = 'Bus ID (Opcional)';
                    }

                    // Habilitar campos
                    const inputs = document.getElementById('form-activo').querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                    });

                    // Habilitar botones
                    document.getElementById('btn-guardar-activo').disabled = false;
                    document.getElementById('btn-cancelar-activo').disabled = false;

                    // Cambiar texto del botón
                    document.getElementById('btn-guardar-activo').innerHTML = '<i class="bi bi-save"></i> Actualizar Activo';
                }
            } catch (error) {
                console.error('Error al cargar activo para edición:', error);
                mostrarToast('Error al cargar activo: ' + error.message, 'error');
            }
        }
        // Eliminar activo
        async function eliminarActivo(id) {
            if (!appState.shiftId) {
                mostrarToast('No hay un turno activo.', 'warning');
                return;
            }
            if (!confirm('¿Está seguro de eliminar este activo? Esta acción no se puede deshacer.')) {
                return;
            }
            try {
                const { error } = await appState.supabase
                    .from('activos')
                    .delete()
                    .eq('id', id);
                if (error) throw error;

                mostrarToast('Activo eliminado correctamente.', 'success');

                // Recargar tabla
                cargarActivos();
            } catch (error) {
                console.error('Error al eliminar activo:', error);
                mostrarToast('Error al eliminar activo: ' + error.message, 'error');
            }
        }
        // Cancelar edición de activo
        function cancelarActivo() {
            // Resetear formulario
            document.getElementById('form-activo').reset();
            // Deshabilitar campos
            const inputs = document.getElementById('form-activo').querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            // Deshabilitar botones
            document.getElementById('btn-guardar-activo').disabled = true;
            document.getElementById('btn-cancelar-activo').disabled = true;
            // Resetear ID de edición
            appState.editingId = null;
        }
        // ===== DASHBOARD =====
        // Actualizar dashboard
        async function actualizarDashboard() {
            try {
                if (!isSupabaseReady()) {
                    renderKpis(DEFAULT_KPIS);
                    return;
                }
                const fecha = document.getElementById('dash-fecha').value;
                const toleranciaAtraso = parseInt(document.getElementById('dash-tolerancia-atraso').value) || 5;
                const toleranciaAnticipo = parseInt(document.getElementById('dash-tolerancia-anticipo').value) || 2;
                // Cargar KPIs
                const kpis = await calcularKPIs(fecha, toleranciaAtraso, toleranciaAnticipo);

                // Actualizar valores en la UI
                renderKpis(kpis);

                // Actualizar gráficos
                actualizarGraficoRegistros(fecha);
                actualizarGraficoPuntualidad(fecha);
            } catch (error) {
                console.error('Error al actualizar dashboard:', error);
                mostrarToast('Error al actualizar dashboard: ' + error.message, 'error');
                renderKpis(DEFAULT_KPIS);
            }
        }
        function renderKpis(kpis) {
            document.getElementById('kpi-cancelaciones').textContent = kpis.cancelaciones;
            document.getElementById('kpi-operativos').textContent = kpis.operativos;
            document.getElementById('kpi-detenidos').textContent = kpis.detenidos;
            document.getElementById('kpi-ausencias').textContent = kpis.ausencias;
            document.getElementById('kpi-puntualidad-primera').textContent = `${kpis.puntualidadPrimera}%`;
            document.getElementById('kpi-puntualidad-ultima').textContent = `${kpis.puntualidadUltima}%`;
            document.getElementById('kpi-llaves-faltantes').textContent = kpis.llavesFaltantes;
            document.getElementById('kpi-registros').textContent = kpis.totalRegistros;
        }
        // Calcular KPIs
        async function calcularKPIs(fecha, toleranciaAtraso, toleranciaAnticipo) {
            try {
                if (!isSupabaseReady()) {
                    return { ...DEFAULT_KPIS };
                }
                // Filtrar por fecha si se proporciona
                let query = appState.supabase.from('registros').select('*');
                if (fecha) {
                    query = query.eq('fecha', fecha);
                }

                // Obtener todos los registros
                const { data: registros, error } = await query;

                if (error) throw error;

                // Filtrar por categoría
                const despachos = registros.filter(r => r.categoria === 'Despacho');
                const incidencias = registros.filter(r => r.categoria === 'Incidencia');

                // Obtener activos
                let queryActivos = appState.supabase.from('activos').select('*');

                if (fecha) {
                    queryActivos = queryActivos.eq('fecha', fecha);
                }

                const { data: activos, error: errorActivos } = await queryActivos;

                if (errorActivos) throw errorActivos;

                // Calcular KPIs
                const cancelaciones = incidencias.filter(i => i.tipo_evento === 'Cancelación').length;
                const operativos = incidencias.filter(i => i.tipo_evento === 'Bus operativo').length;
                const detenidos = incidencias.filter(i => i.tipo_evento === 'Bus en panne' || i.tipo_evento === 'Bus detenido').length;
                const ausencias = incidencias.filter(i => i.tipo_evento === 'Ausencia de conductor').length;

                // Puntualidad
                const despachosPrimera = despachos.filter(d => d.tipo_evento === 'PrimeraSalida');
                const despachosUltima = despachos.filter(d => d.tipo_evento === 'UltimaSalida');

                // Recalcular puntualidad con tolerancias
                despachosPrimera.forEach(d => {
                    d.on_time = Math.abs(d.retraso_min || 0) <= (d.retraso_min > 0 ? toleranciaAtraso : toleranciaAnticipo);
                });

                despachosUltima.forEach(d => {
                    d.on_time = Math.abs(d.retraso_min || 0) <= (d.retraso_min > 0 ? toleranciaAtraso : toleranciaAnticipo);
                });

                const puntualidadPrimera = despachosPrimera.length > 0
                    ? Math.round((despachosPrimera.filter(d => d.on_time).length / despachosPrimera.length) * 100)
                    : 0;

                const puntualidadUltima = despachosUltima.length > 0
                    ? Math.round((despachosUltima.filter(d => d.on_time).length / despachosUltima.length) * 100)
                    : 0;

                // Llaves faltantes
                const llavesFaltantes = activos.filter(a => a.tipo === 'LlavesBus' && a.estado === 'Faltante').length;

                return {
                    cancelaciones,
                    operativos,
                    detenidos,
                    ausencias,
                    puntualidadPrimera,
                    puntualidadUltima,
                    llavesFaltantes,
                    totalRegistros: registros.length + activos.length
                };
            } catch (error) {
                console.error('Error al calcular KPIs:', error);
                return { ...DEFAULT_KPIS };
            }
        }
        // Actualizar gráfico de registros por día
        async function actualizarGraficoRegistros(fecha) {
            try {
                if (!isSupabaseReady()) {
                    if (window.chartRegistros) {
                        window.chartRegistros.destroy();
                        window.chartRegistros = null;
                    }
                    return;
                }
                // Calcular rango de fechas (última semana por defecto)
                const fechaFin = fecha ? new Date(fecha) : new Date();
                const fechaInicio = new Date(fechaFin);
                fechaInicio.setDate(fechaInicio.getDate() - 6);
                // Generar array de fechas para el rango
                const fechas = [];
                for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
                    fechas.push(d.toISOString().split('T')[0]);
                }

                // Consultar registros y activos para el rango
                const { data: registros, error } = await appState.supabase
                    .from('registros')
                    .select('fecha, categoria')
                    .gte('fecha', fechaInicio.toISOString().split('T')[0])
                    .lte('fecha', fechaFin.toISOString().split('T')[0]);

                if (error) throw error;

                const { data: activos, error: errorActivos } = await appState.supabase
                    .from('activos')
                    .select('fecha')
                    .gte('fecha', fechaInicio.toISOString().split('T')[0])
                    .lte('fecha', fechaFin.toISOString().split('T')[0]);

                if (errorActivos) throw errorActivos;

                // Contar registros por día
                const despachosPorDia = {};
                const incidenciasPorDia = {};
                const activosPorDia = {};

                fechas.forEach(fecha => {
                    despachosPorDia[fecha] = 0;
                    incidenciasPorDia[fecha] = 0;
                    activosPorDia[fecha] = 0;
                });

                registros.forEach(registro => {
                    if (registro.categoria === 'Despacho') {
                        despachosPorDia[registro.fecha] = (despachosPorDia[registro.fecha] || 0) + 1;
                    } else if (registro.categoria === 'Incidencia') {
                        incidenciasPorDia[registro.fecha] = (incidenciasPorDia[registro.fecha] || 0) + 1;
                    }
                });

                activos.forEach(activo => {
                    activosPorDia[activo.fecha] = (activosPorDia[activo.fecha] || 0) + 1;
                });

                // Preparar datos para el gráfico
                const labels = fechas.map(fecha => {
                    const d = new Date(fecha);
                    return `${d.getDate()}/${d.getMonth() + 1}`;
                });

                const dataDespachos = fechas.map(fecha => despachosPorDia[fecha] || 0);
                const dataIncidencias = fechas.map(fecha => incidenciasPorDia[fecha] || 0);
                const dataActivos = fechas.map(fecha => activosPorDia[fecha] || 0);

                // Crear gráfico
                const ctx = document.getElementById('chart-registros').getContext('2d');

                // Destruir gráfico anterior si existe
                if (window.chartRegistros) {
                    window.chartRegistros.destroy();
                }

                window.chartRegistros = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Despachos',
                                data: dataDespachos,
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Incidencias',
                                data: dataIncidencias,
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Activos',
                                data: dataActivos,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al actualizar gráfico de registros:', error);
                mostrarToast('Error al actualizar gráfico de registros: ' + error.message, 'error');
            }
        }
        // Actualizar gráfico de puntualidad por servicio
        async function actualizarGraficoPuntualidad(fecha) {
            try {
                if (!isSupabaseReady()) {
                    if (window.chartPuntualidad) {
                        window.chartPuntualidad.destroy();
                        window.chartPuntualidad = null;
                    }
                    return;
                }
                // Consultar despachos por servicio
                let query = appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('categoria', 'Despacho')
                    .eq('tipo_evento', 'PrimeraSalida');
                if (fecha) {
                    query = query.eq('fecha', fecha);
                }

                const { data: despachos, error } = await query;

                if (error) throw error;

                // Agrupar por servicio
                const servicios = {};

                despachos.forEach(despacho => {
                    if (!servicios[despacho.servicio]) {
                        servicios[despacho.servicio] = {
                            total: 0,
                            puntuales: 0
                        };
                    }

                    servicios[despacho.servicio].total++;

                    if (despacho.on_time) {
                        servicios[despacho.servicio].puntuales++;
                    }
                });

                // Calcular porcentajes de puntualidad
                const labels = Object.keys(servicios);
                const data = labels.map(servicio => {
                    const { total, puntuales } = servicios[servicio];
                    return total > 0 ? Math.round((puntuales / total) * 100) : 0;
                });

                // Colores
                const backgroundColors = labels.map((_, i) => {
                    const hue = (i * 137.5) % 360;
                    return `hsla(${hue}, 70%, 50%, 0.7)`;
                });

                // Crear gráfico
                const ctx = document.getElementById('chart-puntualidad').getContext('2d');

                // Destruir gráfico anterior si existe
                if (window.chartPuntualidad) {
                    window.chartPuntualidad.destroy();
                }

                window.chartPuntualidad = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: '% Puntualidad Primera Salida',
                                data,
                                backgroundColor: backgroundColors
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const servicio = context.label;
                                        const { total, puntuales } = servicios[servicio];
                                        return `${context.raw}% (${puntuales}/${total})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Porcentaje (%)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al actualizar gráfico de puntualidad:', error);
                mostrarToast('Error al actualizar gráfico de puntualidad: ' + error.message, 'error');
            }
        }
        // ===== INFORMES =====
        // Buscar informes
        async function buscarInformes() {
            try {
                if (!isSupabaseReady(true)) {
                    const tbody = document.querySelector('#tabla-informes tbody');
                    if (tbody) {
                        tbody.innerHTML = `
    <tr>
      <td colspan="8" class="text-center">Conéctese a Supabase para consultar informes.</td>
    </tr>
  `;
                    }
                    return;
                }
                const fechaDesde = document.getElementById('inf-fecha-desde').value;
                const fechaHasta = document.getElementById('inf-fecha-hasta').value;
                const turnoAM = document.getElementById('inf-turno-am').checked;
                const turnoPM = document.getElementById('inf-turno-pm').checked;
                const turnoNoche = document.getElementById('inf-turno-noche').checked;
                const despachador = document.getElementById('inf-despachador').value;
                const estado = document.getElementById('inf-estado').value;
                // Construir consulta
                let query = appState.supabase
                    .from('turnos')
                    .select('*')
                    .order('fecha', { ascending: false });

                // Aplicar filtros
                if (fechaDesde) {
                    query = query.gte('fecha', fechaDesde);
                }

                if (fechaHasta) {
                    query = query.lte('fecha', fechaHasta);
                }

                // Filtrar por turnos seleccionados
                const turnosSeleccionados = [];
                if (turnoAM) turnosSeleccionados.push('AM');
                if (turnoPM) turnosSeleccionados.push('PM');
                if (turnoNoche) turnosSeleccionados.push('Noche');

                if (turnosSeleccionados.length > 0) {
                    query = query.in('turno', turnosSeleccionados);
                }

                // Filtrar por despachador
                if (despachador) {
                    query = query.eq('despachador', despachador);
                }

                // Filtrar por estado
                if (estado) {
                    query = query.eq('estado', estado);
                }

                // Ejecutar consulta
                const { data, error } = await query;

                if (error) throw error;

                // Limpiar tabla
                const tbody = document.querySelector('#tabla-informes tbody');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Llenar tabla
                    data.forEach(turno => {
                        const tr = document.createElement('tr');

                        // Formatear fecha y hora de cierre
                        const fechaFormateada = new Date(turno.fecha).toLocaleDateString('es-ES');
                        const horaCierre = turno.closed_at ? new Date(turno.closed_at).toLocaleTimeString('es-ES') : '-';

                        tr.innerHTML = `
      <td>${fechaFormateada}</td>
      <td>${turno.turno}</td>
      <td>${turno.despachador}</td>
      <td>${turno.op_ini} → ${turno.op_fin || '-'}</td>
      <td>${turno.man_ini} → ${turno.man_fin || '-'}</td>
      <td>${turno.llaves_ini} → ${turno.llaves_fin || '-'}</td>
      <td>${turno.estado === 'Cerrado' ? horaCierre : '-'}</td>
      <td>
        <div class="table-actions">
          <button class="btn btn-sm btn-outline-primary btn-ver-detalle" data-id="${turno.id}">
            <i class="bi bi-eye"></i> Ver detalle
          </button>
        </div>
      </td>
    `;

                        tbody.appendChild(tr);
                    });

                    // Agregar event listeners para ver detalle
                    document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            cargarDetalleTurno(id);
                        });
                    });
                } else {
                    // Mostrar mensaje de no hay resultados
                    tbody.innerHTML = `
    <tr>
      <td colspan="8" class="text-center">No se encontraron registros con los filtros seleccionados.</td>
    </tr>
  `;
                }
            } catch (error) {
                console.error('Error al buscar informes:', error);
                mostrarToast('Error al buscar informes: ' + error.message, 'error');
            }
        }
        // Cargar detalle de turno
        async function cargarDetalleTurno(id) {
            try {
                // Obtener datos del turno
                const { data: turno, error } = await appState.supabase
                    .from('turnos')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) throw error;

                // Obtener registros asociados
                const { data: registros, error: errorRegistros } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('shift_id', id)
                    .order('created_at', { ascending: false });

                if (errorRegistros) throw errorRegistros;

                // Obtener activos asociados
                const { data: activos, error: errorActivos } = await appState.supabase
                    .from('activos')
                    .select('*')
                    .eq('shift_id', id)
                    .order('created_at', { ascending: false });

                if (errorActivos) throw errorActivos;

                // Filtrar por categoría
                const despachos = registros.filter(r => r.categoria === 'Despacho');
                const incidencias = registros.filter(r => r.categoria === 'Incidencia');

                // Calcular estadísticas
                const cancelaciones = incidencias.filter(i => i.tipo_evento === 'Cancelación').length;
                const operativos = incidencias.filter(i => i.tipo_evento === 'Bus operativo').length;
                const detenidos = incidencias.filter(i => i.tipo_evento === 'Bus en panne' || i.tipo_evento === 'Bus detenido').length;
                const ausencias = incidencias.filter(i => i.tipo_evento === 'Ausencia de conductor').length;

                // Puntualidad
                const despachosPrimera = despachos.filter(d => d.tipo_evento === 'PrimeraSalida');
                const despachosUltima = despachos.filter(d => d.tipo_evento === 'UltimaSalida');

                const puntualidadPrimera = despachosPrimera.length > 0
                    ? Math.round((despachosPrimera.filter(d => d.on_time).length / despachosPrimera.length) * 100)
                    : 0;

                const puntualidadUltima = despachosUltima.length > 0
                    ? Math.round((despachosUltima.filter(d => d.on_time).length / despachosUltima.length) * 100)
                    : 0;

                // Llaves faltantes
                const llavesFaltantes = activos.filter(a => a.tipo === 'LlavesBus' && a.estado === 'Faltante').length;

                // Crear contenido modal
                const fechaFormateada = new Date(turno.fecha).toLocaleDateString('es-ES');
                const horaCierre = turno.closed_at ? new Date(turno.closed_at).toLocaleTimeString('es-ES') : '-';

                const modalContent = `
  <div class="print-header">
    <h2 class="text-center">Resumen de Turno</h2>
    <div class="d-flex justify-between">
      <div><strong>Fecha:</strong> ${fechaFormateada}</div>
      <div><strong>Turno:</strong> ${turno.turno}</div>
      <div><strong>Despachador:</strong> ${turno.despachador}</div>
    </div>
    <div class="d-flex justify-between">
      <div><strong>Estado:</strong> ${turno.estado}</div>
      ${turno.estado === 'Cerrado' ? `<div><strong>Hora de cierre:</strong> ${horaCierre}</div>` : ''}
    </div>
  </div>
  
  <div class="mb-3">
    <h3>Resumen</h3>
    <div class="grid grid-4 mb-2">
      <div class="kpi-card">
        <div class="kpi-title">Operativos Inicio → Fin</div>
        <div class="kpi-value">${turno.op_ini} → ${turno.op_fin || '-'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Mantenimiento Inicio → Fin</div>
        <div class="kpi-value">${turno.man_ini} → ${turno.man_fin || '-'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Diferencia Inicio → Fin</div>
        <div class="kpi-value">${turno.diff_ini} → ${turno.diff_fin || '-'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Llaves Inicio → Fin</div>
        <div class="kpi-value">${turno.llaves_ini} → ${turno.llaves_fin || '-'}</div>
      </div>
    </div>
    
    <div class="grid grid-4">
      <div class="kpi-card">
        <div class="kpi-title">Cancelaciones</div>
        <div class="kpi-value">${cancelaciones}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Buses Operativos</div>
        <div class="kpi-value">${operativos}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Buses Detenidos/Panne</div>
        <div class="kpi-value">${detenidos}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Ausencias</div>
        <div class="kpi-value">${ausencias}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Puntualidad Primera</div>
        <div class="kpi-value">${puntualidadPrimera}%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Puntualidad Última</div>
        <div class="kpi-value">${puntualidadUltima}%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Llaves Faltantes</div>
        <div class="kpi-value">${llavesFaltantes}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Total Registros</div>
        <div class="kpi-value">${registros.length + activos.length}</div>
      </div>
    </div>
  </div>
  
  <div class="mb-3">
    ${turno.notas_cierre ? `
      <h3>Notas de Cierre</h3>
      <div class="panel panel-body mb-3">
        ${turno.notas_cierre || 'Sin notas'}
      </div>
    ` : ''}
  </div>
  
  <div class="mb-3">
    <h3>Despachos (${despachos.length})</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Tipo</th>
            <th>Bus</th>
            <th>Conductor</th>
            <th>H. Prog</th>
            <th>H. Real</th>
            <th>Retraso</th>
          </tr>
        </thead>
        <tbody>
          ${despachos.length > 0 ? despachos.map(despacho => {
                    const retrasoMin = despacho.retraso_min || 0;
                    const retrasoClass = despacho.on_time ? 'chip-good' : (Math.abs(retrasoMin) <= 10 ? 'chip-warn' : 'chip-bad');
                    const retrasoPrefix = retrasoMin < 0 ? '-' : '+';

                    return `
              <tr>
                <td>${despacho.servicio}</td>
                <td>${despacho.tipo_evento === 'PrimeraSalida' ? 'Primera' : 'Última'}</td>
                <td>${despacho.bus_id || '-'}</td>
                <td>${despacho.conductor || '-'}</td>
                <td>${despacho.hora_prog}${despacho.next_day ? ' (+1)' : ''}</td>
                <td>${despacho.hora_real}${despacho.next_day ? ' (+1)' : ''}</td>
                <td><span class="chip ${retrasoClass}">Δ ${retrasoPrefix}${Math.abs(retrasoMin)} min</span></td>
              </tr>
            `;
                }).join('') : `
            <tr>
              <td colspan="7" class="text-center">No hay despachos registrados</td>
            </tr>
          `}
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="mb-3">
    <h3>Incidencias (${incidencias.length})</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Bus</th>
            <th>Tipo Evento</th>
            <th>Motivo</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          ${incidencias.length > 0 ? incidencias.map(incidencia => `
            <tr>
              <td>${incidencia.servicio}</td>
              <td>${incidencia.bus_id || '-'}</td>
              <td>${incidencia.tipo_evento}</td>
              <td>${incidencia.motivo || '-'}</td>
              <td>${incidencia.obs || '-'}</td>
            </tr>
          <artifact type="application/vnd.ant.code" id="voy15-app-continuation2" language="javascript">
`).join('') : `
                <tr>
                  <td colspan="5" class="text-center">No hay incidencias registradas</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
  <div class="mb-3">
    <h3>Activos (${activos.length})</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Bus</th>
            <th>Estado</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          ${activos.length > 0 ? activos.map(activo => {
                    // Determinar clase para estado
                    let estadoClass;
                    switch (activo.estado) {
                        case 'OK':
                            estadoClass = 'badge-success';
                            break;
                        case 'Falla':
                            estadoClass = 'badge-warning';
                            break;
                        case 'Faltante':
                            estadoClass = 'badge-danger';
                            break;
                        case 'Entregado':
                            estadoClass = 'badge-info';
                            break;
                        case 'Pendiente':
                            estadoClass = 'badge-secondary';
                            break;
                        default:
                            estadoClass = 'badge-secondary';
                    }

                    return `
              <tr>
                <td>${activo.tipo}</td>
                <td>${activo.bus_id || '-'}</td>
                <td><span class="badge ${estadoClass}">${activo.estado}</span></td>
                <td>${activo.obs || '-'}</td>
              </tr>
            `;
                }).join('') : `
            <tr>
              <td colspan="4" class="text-center">No hay activos registrados</td>
            </tr>
          `}
        </tbody>
      </table>
    </div>
  </div>
`;

                // Actualizar título del modal
                document.querySelector('.modal-title').textContent = `Detalle de Turno - ${fechaFormateada} - ${turno.turno}`;

                // Actualizar contenido del modal
                document.getElementById('modal-detalle-content').innerHTML = modalContent;

                // Guardar ID para exportación
                document.getElementById('btn-exportar-detalle').setAttribute('data-id', id);

                // Mostrar modal
                document.getElementById('modal-backdrop').classList.add('active');
                document.getElementById('modal-detalle-turno').classList.add('active');
            } catch (error) {
                console.error('Error al cargar detalle de turno:', error);
                mostrarToast('Error al cargar detalle de turno: ' + error.message, 'error');
            }
        }
        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modal-backdrop').classList.remove('active');
            document.getElementById('modal-detalle-turno').classList.remove('active');
        }
        // Imprimir detalle
        function imprimirDetalle() {
            window.print();
        }
        // Exportar detalle a XLSX
        async function exportarDetalleXLSX() {
            try {
                const id = document.getElementById('btn-exportar-detalle').getAttribute('data-id');
                // Obtener datos del turno
                const { data: turno, error } = await appState.supabase
                    .from('turnos')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Obtener registros asociados
                const { data: registros, error: errorRegistros } = await appState.supabase
                    .from('registros')
                    .select('*')
                    .eq('shift_id', id);

                if (errorRegistros) throw errorRegistros;

                // Obtener activos asociados
                const { data: activos, error: errorActivos } = await appState.supabase
                    .from('activos')
                    .select('*')
                    .eq('shift_id', id);

                if (errorActivos) throw errorActivos;

                // Filtrar por categoría
                const despachos = registros.filter(r => r.categoria === 'Despacho');
                const incidencias = registros.filter(r => r.categoria === 'Incidencia');

                // Crear libro de Excel
                const wb = XLSX.utils.book_new();

                // Hoja de resumen
                const resumenData = [
                    ['RESUMEN DE TURNO'],
                    [''],
                    ['Fecha', turno.fecha],
                    ['Turno', turno.turno],
                    ['Despachador', turno.despachador],
                    ['Estado', turno.estado],
                    ['Hora de cierre', turno.closed_at ? new Date(turno.closed_at).toLocaleTimeString() : '-'],
                    [''],
                    ['OPERACIÓN'],
                    ['Buses Operativos Inicio', turno.op_ini],
                    ['Buses Operativos Fin', turno.op_fin || '-'],
                    ['Buses Mantenimiento Inicio', turno.man_ini],
                    ['Buses Mantenimiento Fin', turno.man_fin || '-'],
                    ['Diferencia Inicio', turno.diff_ini],
                    ['Diferencia Fin', turno.diff_fin || '-'],
                    ['Llaves Inicio', turno.llaves_ini],
                    ['Llaves Fin', turno.llaves_fin || '-'],
                    [''],
                    ['Notas de cierre', turno.notas_cierre || '-']
                ];

                const resumenWs = XLSX.utils.aoa_to_sheet(resumenData);
                XLSX.utils.book_append_sheet(wb, resumenWs, 'Resumen');

                // Hoja de despachos
                if (despachos.length > 0) {
                    const despachoData = [
                        ['Servicio', 'Tipo', 'Bus', 'Conductor', 'Hora Prog', 'Hora Real', 'Retraso', 'A tiempo']
                    ];

                    despachos.forEach(despacho => {
                        despachoData.push([
                            despacho.servicio,
                            despacho.tipo_evento === 'PrimeraSalida' ? 'Primera' : 'Última',
                            despacho.bus_id || '',
                            despacho.conductor || '',
                            despacho.hora_prog + (despacho.next_day ? ' (+1)' : ''),
                            despacho.hora_real + (despacho.next_day ? ' (+1)' : ''),
                            despacho.retraso_min || 0,
                            despacho.on_time ? 'Sí' : 'No'
                        ]);
                    });

                    const despachoWs = XLSX.utils.aoa_to_sheet(despachoData);
                    XLSX.utils.book_append_sheet(wb, despachoWs, 'Despachos');
                }

                // Hoja de incidencias
                if (incidencias.length > 0) {
                    const incidenciaData = [
                        ['Servicio', 'Bus', 'Tipo Evento', 'Motivo', 'Observaciones']
                    ];

                    incidencias.forEach(incidencia => {
                        incidenciaData.push([
                            incidencia.servicio,
                            incidencia.bus_id || '',
                            incidencia.tipo_evento,
                            incidencia.motivo || '',
                            incidencia.obs || ''
                        ]);
                    });

                    const incidenciaWs = XLSX.utils.aoa_to_sheet(incidenciaData);
                    XLSX.utils.book_append_sheet(wb, incidenciaWs, 'Incidencias');
                }

                // Hoja de activos
                if (activos.length > 0) {
                    const activoData = [
                        ['Tipo', 'Bus', 'Estado', 'Observaciones']
                    ];

                    activos.forEach(activo => {
                        activoData.push([
                            activo.tipo,
                            activo.bus_id || '',
                            activo.estado,
                            activo.obs || ''
                        ]);
                    });

                    const activoWs = XLSX.utils.aoa_to_sheet(activoData);
                    XLSX.utils.book_append_sheet(wb, activoWs, 'Activos');
                }

                // Descargar archivo
                const nombreArchivo = `Turno_${turno.fecha}_${turno.turno}_${turno.despachador}.xlsx`;
                XLSX.writeFile(wb, nombreArchivo);

                mostrarToast(`Archivo "${nombreArchivo}" generado correctamente.`, 'success');
            } catch (error) {
                console.error('Error al exportar detalle:', error);
                mostrarToast('Error al exportar detalle: ' + error.message, 'error');
            }
        }
        // ===== CATALOGOS Y CONFIGURACIÓN =====
        // Cargar catálogos
        async function cargarCatalogos() {
            try {
                // Llenar tablas de catálogos
                llenarTablaCatalogo('turnos', 'tabla-cat-turnos');
                llenarTablaCatalogo('servicios', 'tabla-cat-servicios');
                llenarTablaCatalogo('tiposBus', 'tabla-cat-tipos-bus');
                llenarTablaCatalogo('motivos', 'tabla-cat-motivos');
                llenarTablaCatalogo('estadosTelefono', 'tabla-cat-estados-tel');
                // Llenar selects en formularios
                llenarSelect('turno', appState.catalogos.turnos);
                llenarSelect('desp-turno', appState.catalogos.turnos);
                llenarSelect('inc-turno', appState.catalogos.turnos);
                llenarSelect('act-turno', appState.catalogos.turnos);

                llenarSelect('desp-tipo-bus', appState.catalogos.tiposBus);
                llenarSelect('inc-motivo', appState.catalogos.motivos);
                llenarSelect('tel-inicio', appState.catalogos.estadosTelefono);
                llenarSelect('tel-fin', appState.catalogos.estadosTelefono);

                // Actualizar config
                document.getElementById('config-flota-total').value = appState.config.flotaTotal;
                document.getElementById('config-tolerancia-atraso').value = appState.config.toleranciaAtraso;
                document.getElementById('config-tolerancia-anticipo').value = appState.config.toleranciaAnticipo;
            } catch (error) {
                console.error('Error al cargar catálogos:', error);
                mostrarToast('Error al cargar catálogos: ' + error.message, 'error');
            }
        }
        // Llenar tabla de catálogo
        function llenarTablaCatalogo(catalogo, tablaId) {
            const items = appState.catalogos[catalogo] || [];
            const tbody = document.querySelector(`#${tablaId} tbody`);
            if (!tbody) return;
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
  <td>${item}</td>
  <td>
    <div class="table-actions">
      <button class="btn btn-sm btn-outline-primary btn-editar-catalogo" data-catalogo="${catalogo}" data-index="${index}">
        <i class="bi bi-pencil"></i>
      </button>
      <button class="btn btn-sm btn-outline-danger btn-eliminar-catalogo" data-catalogo="${catalogo}" data-index="${index}">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  </td>
`;

                tbody.appendChild(tr);
            });
            // Agregar event listeners
            document.querySelectorAll(`#${tablaId} .btn-editar-catalogo`).forEach(btn => {
                btn.addEventListener('click', function () {
                    const catalogoAttr = this.getAttribute('data-catalogo');
                    const indexAttr = parseInt(this.getAttribute('data-index'), 10);
                    editarCatalogo(catalogoAttr, indexAttr);
                });
            });
            document.querySelectorAll(`#${tablaId} .btn-eliminar-catalogo`).forEach(btn => {
                btn.addEventListener('click', function () {
                    const catalogoAttr = this.getAttribute('data-catalogo');
                    const indexAttr = parseInt(this.getAttribute('data-index'), 10);
                    eliminarCatalogo(catalogoAttr, indexAttr);
                });
            });
        }
        // Llenar select con opciones de catálogo
        function llenarSelect(selectId, opciones) {
            const select = document.getElementById(selectId);
            if (!select) return;
            // Guardar opción seleccionada actualmente
            const valorActual = select.value;
            // Mantener primera opción si existe (placeholder)
            let primeraOpcion = null;
            if (select.options.length > 0 && select.options[0].value === '') {
                primeraOpcion = select.options[0].outerHTML;
            }
            // Limpiar select
            select.innerHTML = '';
            // Restaurar primera opción si existe
            if (primeraOpcion) {
                select.innerHTML = primeraOpcion;
            }
            // Agregar opciones
            opciones.forEach(opcion => {
                const option = document.createElement('option');
                option.value = opcion;
                option.textContent = opcion;
                select.appendChild(option);
            });
            // Restaurar valor seleccionado si sigue existiendo
            if (opciones.includes(valorActual)) {
                select.value = valorActual;
            }
        }
        // Agregar elemento a catálogo
        function agregarCatalogo(catalogo) {
            const titulo = {
                turnos: 'Nuevo Turno',
                servicios: 'Nuevo Servicio',
                tiposBus: 'Nuevo Tipo de Bus',
                motivos: 'Nuevo Motivo',
                estadosTelefono: 'Nuevo Estado de Teléfono'
            }[catalogo];
            const valor = prompt(`${titulo}:`, '');
            if (valor && valor.trim()) {
                // Verificar si ya existe
                const valorTrim = valor.trim();
                if (appState.catalogos[catalogo].includes(valorTrim)) {
                    mostrarToast(`El valor "${valorTrim}" ya existe en el catálogo.`, 'warning');
                    return;
                }
                // Agregar al catálogo
                appState.catalogos[catalogo].push(valorTrim);

                // Guardar en localStorage
                localStorage.setItem('catalogos', JSON.stringify(appState.catalogos));

                // Actualizar tabla
                const tablaId = {
                    turnos: 'tabla-cat-turnos',
                    servicios: 'tabla-cat-servicios',
                    tiposBus: 'tabla-cat-tipos-bus',
                    motivos: 'tabla-cat-motivos',
                    estadosTelefono: 'tabla-cat-estados-tel'
                }[catalogo];

                llenarTablaCatalogo(catalogo, tablaId);

                // Actualizar selects
                cargarCatalogos();

                mostrarToast(`${titulo} agregado correctamente.`, 'success');
            }
        }
        // Editar elemento de catálogo
        function editarCatalogo(catalogo, index) {
            const titulo = {
                turnos: 'Editar Turno',
                servicios: 'Editar Servicio',
                tiposBus: 'Editar Tipo de Bus',
                motivos: 'Editar Motivo',
                estadosTelefono: 'Editar Estado de Teléfono'
            }[catalogo];
            const valorActual = appState.catalogos[catalogo][index];
            const nuevoValor = prompt(`${titulo}:`, valorActual);
            if (nuevoValor !== null && nuevoValor.trim()) {
                // Verificar si ya existe
                const valorNormalizado = nuevoValor.trim();
                if (valorNormalizado !== valorActual && appState.catalogos[catalogo].includes(valorNormalizado)) {
                    mostrarToast(`El valor "${valorNormalizado}" ya existe en el catálogo.`, 'warning');
                    return;
                }
                // Actualizar catálogo
                appState.catalogos[catalogo][index] = valorNormalizado;

                // Guardar en localStorage
                localStorage.setItem('catalogos', JSON.stringify(appState.catalogos));

                // Actualizar tabla
                const tablaId = {
                    turnos: 'tabla-cat-turnos',
                    servicios: 'tabla-cat-servicios',
                    tiposBus: 'tabla-cat-tipos-bus',
                    motivos: 'tabla-cat-motivos',
                    estadosTelefono: 'tabla-cat-estados-tel'
                }[catalogo];

                llenarTablaCatalogo(catalogo, tablaId);

                // Actualizar selects
                cargarCatalogos();

                mostrarToast(`${titulo.replace('Editar', 'Actualizado')} correctamente.`, 'success');
            }
        }
        // Eliminar elemento de catálogo
        function eliminarCatalogo(catalogo, index) {
            const titulo = {
                turnos: 'Turno',
                servicios: 'Servicio',
                tiposBus: 'Tipo de Bus',
                motivos: 'Motivo',
                estadosTelefono: 'Estado de Teléfono'
            }[catalogo];
            const valor = appState.catalogos[catalogo][index];
            if (confirm(`¿Está seguro de eliminar el ${titulo} "${valor}"?`)) {
                // Eliminar del catálogo
                appState.catalogos[catalogo].splice(index, 1);
                // Guardar en localStorage
                localStorage.setItem('catalogos', JSON.stringify(appState.catalogos));

                // Actualizar tabla
                const tablaId = {
                    turnos: 'tabla-cat-turnos',
                    servicios: 'tabla-cat-servicios',
                    tiposBus: 'tabla-cat-tipos-bus',
                    motivos: 'tabla-cat-motivos',
                    estadosTelefono: 'tabla-cat-estados-tel'
                }[catalogo];

                llenarTablaCatalogo(catalogo, tablaId);

                // Actualizar selects
                cargarCatalogos();

                mostrarToast(`${titulo} eliminado correctamente.`, 'success');
            }
        }
        // Guardar configuración
        function guardarConfiguracion() {
            const flotaTotal = parseInt(document.getElementById('config-flota-total').value) || 124;
            const toleranciaAtraso = parseInt(document.getElementById('config-tolerancia-atraso').value) || 5;
            const toleranciaAnticipo = parseInt(document.getElementById('config-tolerancia-anticipo').value) || 2;
            // Validar valores
            if (flotaTotal <= 0) {
                mostrarToast('La flota total debe ser mayor a 0.', 'warning');
                return;
            }
            if (toleranciaAtraso < 0 || toleranciaAnticipo < 0) {
                mostrarToast('Las tolerancias no pueden ser negativas.', 'warning');
                return;
            }
            // Actualizar estado
            appState.config.flotaTotal = flotaTotal;
            appState.config.toleranciaAtraso = toleranciaAtraso;
            appState.config.toleranciaAnticipo = toleranciaAnticipo;
            // Guardar en localStorage
            localStorage.setItem('config', JSON.stringify(appState.config));
            // Actualizar inputs del dashboard
            document.getElementById('dash-tolerancia-atraso').value = toleranciaAtraso;
            document.getElementById('dash-tolerancia-anticipo').value = toleranciaAnticipo;
            mostrarToast('Configuración guardada correctamente.', 'success');
        }
        // ===== EXCEL =====
        // Habilitar botón de importación al seleccionar archivo
        function habilitarImportacion() {
            const fileInput = document.getElementById('excel-import');
            const importBtn = document.getElementById('btn-importar-excel');
            if (fileInput.files.length > 0) {
                importBtn.disabled = false;
            } else {
                importBtn.disabled = true;
            }
        }
        // Importar Excel
        async function importarExcel() {
            try {
                const fileInput = document.getElementById('excel-import');
                if (fileInput.files.length === 0) {
                    mostrarToast('Por favor, seleccione un archivo.', 'warning');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = async function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Verificar si hay un turno activo
                        if (!appState.shiftId) {
                            const { data: turnos, error } = await appState.supabase
                                .from('turnos')
                                .select('id, fecha, turno, despachador')
                                .eq('estado', 'Activo')
                                .limit(1);

                            if (error) throw error;

                            if (!turnos || turnos.length === 0) {
                                mostrarToast('No hay un turno activo. Inicie un turno antes de importar datos.', 'warning');
                                return;
                            }

                            appState.shiftId = turnos[0].id;
                            appState.turnoActivo = turnos[0];
                        }

                        // Resultados
                        let importados = 0;
                        let errores = 0;

                        // Procesar hoja de despachos
                        if (workbook.SheetNames.includes('Despachos')) {
                            const despachos = XLSX.utils.sheet_to_json(workbook.Sheets['Despachos']);

                            for (const despacho of despachos) {
                                try {
                                    // Determinar shift_id
                                    let shiftId = despacho.shift_id || appState.shiftId;

                                    // Si no hay shift_id, intentar asociar por fecha, turno y despachador
                                    if (!shiftId && despacho.fecha && despacho.turno && despacho.despachador) {
                                        const { data: turnos, error } = await appState.supabase
                                            .from('turnos')
                                            .select('id')
                                            .eq('fecha', despacho.fecha)
                                            .eq('turno', despacho.turno)
                                            .eq('despachador', despacho.despachador)
                                            .eq('estado', 'Activo')
                                            .limit(1);

                                        if (error) throw error;

                                        if (turnos && turnos.length > 0) {
                                            shiftId = turnos[0].id;
                                        }
                                    }

                                    if (!shiftId) {
                                        console.warn('No se pudo determinar el turno para:', despacho);
                                        errores++;
                                        continue;
                                    }

                                    // Validar campos obligatorios
                                    if (!despacho.fecha || !despacho.turno || !despacho.servicio ||
                                        !despacho.tipo_evento || !despacho.hora_prog || !despacho.hora_real) {
                                        console.warn('Faltan campos obligatorios:', despacho);
                                        errores++;
                                        continue;
                                    }

                                    // Calcular retraso
                                    const retrasoMin = calcularRetrasoMinutos(
                                        despacho.hora_prog,
                                        despacho.hora_real,
                                        despacho.next_day
                                    );

                                    // Determinar on_time
                                    const onTime = Math.abs(retrasoMin) <=
                                        (retrasoMin > 0 ? appState.config.toleranciaAtraso : appState.config.toleranciaAnticipo);

                                    // Datos para insertar
                                    const despachoData = {
                                        shift_id: shiftId,
                                        categoria: 'Despacho',
                                        fecha: despacho.fecha,
                                        turno: despacho.turno,
                                        servicio: despacho.servicio,
                                        tipo_bus: despacho.tipo_bus || null,
                                        bus_id: despacho.bus_id || null,
                                        conductor: despacho.conductor || null,
                                        despachador: despacho.despachador || (appState.turnoActivo ? appState.turnoActivo.despachador : null),
                                        tipo_evento: despacho.tipo_evento,
                                        hora_prog: despacho.hora_prog,
                                        hora_real: despacho.hora_real,
                                        next_day: despacho.next_day || false,
                                        obs: despacho.obs || null,
                                        retraso_min: retrasoMin,
                                        on_time: onTime
                                    };

                                    // Insertar o actualizar
                                    const { error } = await appState.supabase
                                        .from('registros')
                                        .insert([despachoData]);

                                    if (error) throw error;

                                    importados++;
                                } catch (err) {
                                    console.error('Error al importar despacho:', err, despacho);
                                    errores++;
                                }
                            }
                        }

                        // Procesar hoja de incidencias
                        if (workbook.SheetNames.includes('Incidencias')) {
                            const incidencias = XLSX.utils.sheet_to_json(workbook.Sheets['Incidencias']);

                            for (const incidencia of incidencias) {
                                try {
                                    // Determinar shift_id
                                    let shiftId = incidencia.shift_id || appState.shiftId;

                                    // Si no hay shift_id, intentar asociar por fecha, turno y despachador
                                    if (!shiftId && incidencia.fecha && incidencia.turno && incidencia.despachador) {
                                        const { data: turnos, error } = await appState.supabase
                                            .from('turnos')
                                            .select('id')
                                            .eq('fecha', incidencia.fecha)
                                            .eq('turno', incidencia.turno)
                                            .eq('despachador', incidencia.despachador)
                                            .eq('estado', 'Activo')
                                            .limit(1);

                                        if (error) throw error;

                                        if (turnos && turnos.length > 0) {
                                            shiftId = turnos[0].id;
                                        }
                                    }

                                    if (!shiftId) {
                                        console.warn('No se pudo determinar el turno para:', incidencia);
                                        errores++;
                                        continue;
                                    }

                                    // Validar campos obligatorios
                                    if (!incidencia.fecha || !incidencia.turno || !incidencia.servicio || !incidencia.tipo_evento) {
                                        console.warn('Faltan campos obligatorios:', incidencia);
                                        errores++;
                                        continue;
                                    }

                                    // Validar motivo obligatorio para cancelaciones
                                    if (incidencia.tipo_evento === 'Cancelación' && !incidencia.motivo) {
                                        console.warn('Falta motivo obligatorio para cancelación:', incidencia);
                                        errores++;
                                        continue;
                                    }

                                    // Datos para insertar
                                    const incidenciaData = {
                                        shift_id: shiftId,
                                        categoria: 'Incidencia',
                                        fecha: incidencia.fecha,
                                        turno: incidencia.turno,
                                        servicio: incidencia.servicio,
                                        bus_id: incidencia.bus_id || null,
                                        despachador: incidencia.despachador || (appState.turnoActivo ? appState.turnoActivo.despachador : null),
                                        tipo_evento: incidencia.tipo_evento,
                                        motivo: incidencia.motivo || null,
                                        obs: incidencia.obs || null
                                    };

                                    // Insertar o actualizar
                                    const { error } = await appState.supabase
                                        .from('registros')
                                        .insert([incidenciaData]);

                                    if (error) throw error;

                                    importados++;
                                } catch (err) {
                                    console.error('Error al importar incidencia:', err, incidencia);
                                    errores++;
                                }
                            }
                        }

                        // Procesar hoja de activos
                        if (workbook.SheetNames.includes('Activos')) {
                            const activos = XLSX.utils.sheet_to_json(workbook.Sheets['Activos']);

                            for (const activo of activos) {
                                try {
                                    // Determinar shift_id
                                    let shiftId = activo.shift_id || appState.shiftId;

                                    // Si no hay shift_id, intentar asociar por fecha y turno
                                    if (!shiftId && activo.fecha && activo.turno) {
                                        const { data: turnos, error } = await appState.supabase
                                            .from('turnos')
                                            .select('id')
                                            .eq('fecha', activo.fecha)
                                            .eq('turno', activo.turno)
                                            .eq('estado', 'Activo')
                                            .limit(1);

                                        if (error) throw error;

                                        if (turnos && turnos.length > 0) {
                                            shiftId = turnos[0].id;
                                        }
                                    }

                                    if (!shiftId) {
                                        console.warn('No se pudo determinar el turno para:', activo);
                                        errores++;
                                        continue;
                                    }

                                    // Validar campos obligatorios
                                    if (!activo.fecha || !activo.turno || !activo.tipo || !activo.estado) {
                                        console.warn('Faltan campos obligatorios:', activo);
                                        errores++;
                                        continue;
                                    }

                                    // Validar bus_id obligatorio para LlavesBus
                                    if (activo.tipo === 'LlavesBus' && !activo.bus_id) {
                                        console.warn('Falta bus_id obligatorio para llaves:', activo);
                                        errores++;
                                        continue;
                                    }

                                    // Datos para insertar
                                    const activoData = {
                                        shift_id: shiftId,
                                        fecha: activo.fecha,
                                        turno: activo.turno,
                                        tipo: activo.tipo,
                                        bus_id: activo.bus_id || null,
                                        estado: activo.estado,
                                        obs: activo.obs || null
                                    };

                                    // Insertar o actualizar
                                    const { error } = await appState.supabase
                                        .from('activos')
                                        .insert([activoData]);

                                    if (error) throw error;

                                    importados++;
                                } catch (err) {
                                    console.error('Error al importar activo:', err, activo);
                                    errores++;
                                }
                            }
                        }

                        // Mostrar resultados
                        if (importados > 0) {
                            mostrarToast(`Importación completada: ${importados} registros importados, ${errores} errores.`, 'success');

                            // Recargar datos
                            cargarDatosTurno();

                            // Limpiar input
                            fileInput.value = '';
                            document.getElementById('btn-importar-excel').disabled = true;
                        } else {
                            mostrarToast(`No se importaron registros. Revise el formato del archivo.`, 'warning');
                        }
                    } catch (error) {
                        console.error('Error al procesar Excel:', error);
                        mostrarToast('Error al procesar el archivo Excel: ' + error.message, 'error');
                    }
                };

                reader.onerror = function (e) {
                    console.error('Error al leer el archivo:', e);
                    mostrarToast('Error al leer el archivo.', 'error');
                };

                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error al importar Excel:', error);
                mostrarToast('Error al importar Excel: ' + error.message, 'error');
            }
        }
        // Descargar plantilla Excel
        function descargarPlantilla() {
            try {
                // Crear libro
                const wb = XLSX.utils.book_new();
                // Hoja de despachos
                const despachoHeaders = [
                    'shift_id', 'fecha', 'turno', 'servicio', 'tipo_bus', 'bus_id', 'conductor',
                    'despachador', 'tipo_evento', 'hora_prog', 'hora_real', 'next_day', 'obs'
                ];

                const despachoSample = [
                    {
                        'shift_id': '',
                        'fecha': new Date().toISOString().split('T')[0],
                        'turno': 'AM',
                        'servicio': 'B01',
                        'tipo_bus': 'Articulado',
                        'bus_id': 'ABCD12',
                        'conductor': 'Juan Pérez',
                        'despachador': 'Pedro García',
                        'tipo_evento': 'PrimeraSalida',
                        'hora_prog': '06:30',
                        'hora_real': '06:35',
                        'next_day': false,
                        'obs': 'Observación de ejemplo'
                    }
                ];

                const despachoWs = XLSX.utils.json_to_sheet(despachoSample, { header: despachoHeaders });
                XLSX.utils.book_append_sheet(wb, despachoWs, 'Despachos');

                // Hoja de incidencias
                const incidenciaHeaders = [
                    'shift_id', 'fecha', 'turno', 'servicio', 'bus_id', 'despachador',
                    'tipo_evento', 'motivo', 'obs'
                ];

                const incidenciaSample = [
                    {
                        'shift_id': '',
                        'fecha': new Date().toISOString().split('T')[0],
                        'turno': 'PM',
                        'servicio': 'A12',
                        'bus_id': 'EFGH34',
                        'despachador': 'Pedro García',
                        'tipo_evento': 'Cancelación',
                        'motivo': 'Falta de Bus',
                        'obs': 'Observación de ejemplo'
                    }
                ];

                const incidenciaWs = XLSX.utils.json_to_sheet(incidenciaSample, { header: incidenciaHeaders });
                XLSX.utils.book_append_sheet(wb, incidenciaWs, 'Incidencias');

                // Hoja de activos
                const activoHeaders = [
                    'shift_id', 'fecha', 'turno', 'tipo', 'bus_id', 'estado', 'obs'
                ];

                const activoSample = [
                    {
                        'shift_id': '',
                        'fecha': new Date().toISOString().split('T')[0],
                        'turno': 'Noche',
                        'tipo': 'Celular',
                        'bus_id': '',
                        'estado': 'OK',
                        'obs': 'Observación de ejemplo'
                    }
                ];

                const activoWs = XLSX.utils.json_to_sheet(activoSample, { header: activoHeaders });
                XLSX.utils.book_append_sheet(wb, activoWs, 'Activos');

                // Descargar
                XLSX.writeFile(wb, 'Plantilla_VOY15.xlsx');

                mostrarToast('Plantilla descargada correctamente.', 'success');
            } catch (error) {
                console.error('Error al descargar plantilla:', error);
                mostrarToast('Error al descargar plantilla: ' + error.message, 'error');
            }
        }
        // Exportar a Excel
        async function exportarExcel() {
            try {
                const fechaDesde = document.getElementById('excel-fecha-desde').value;
                const fechaHasta = document.getElementById('excel-fecha-hasta').value;
                const turno = document.getElementById('excel-turno').value;
                // Validar fechas
                if (!fechaDesde && !fechaHasta) {
                    mostrarToast('Por favor, especifique al menos una fecha.', 'warning');
                    return;
                }

                // Crear libro
                const wb = XLSX.utils.book_new();

                // Consultar turnos
                let queryTurnos = appState.supabase.from('turnos').select('*');

                if (fechaDesde) {
                    queryTurnos = queryTurnos.gte('fecha', fechaDesde);
                }

                if (fechaHasta) {
                    queryTurnos = queryTurnos.lte('fecha', fechaHasta);
                }

                if (turno) {
                    queryTurnos = queryTurnos.eq('turno', turno);
                }

                const { data: turnos, error: errorTurnos } = await queryTurnos;

                if (errorTurnos) throw errorTurnos;

                // Si hay turnos, exportar
                if (turnos && turnos.length > 0) {
                    // Hoja de turnos
                    const turnosWs = XLSX.utils.json_to_sheet(turnos);
                    XLSX.utils.book_append_sheet(wb, turnosWs, 'Turnos');

                    // Obtener IDs de turnos
                    const shiftIds = turnos.map(t => t.id);

                    // Consultar registros
                    const { data: registros, error: errorRegistros } = await appState.supabase
                        .from('registros')
                        .select('*')
                        .in('shift_id', shiftIds);

                    if (errorRegistros) throw errorRegistros;

                    if (registros && registros.length > 0) {
                        // Filtrar por categoría
                        const despachos = registros.filter(r => r.categoria === 'Despacho');
                        const incidencias = registros.filter(r => r.categoria === 'Incidencia');

                        // Hoja de despachos
                        if (despachos.length > 0) {
                            const despachosWs = XLSX.utils.json_to_sheet(despachos);
                            XLSX.utils.book_append_sheet(wb, despachosWs, 'Despachos');
                        }

                        // Hoja de incidencias
                        if (incidencias.length > 0) {
                            const incidenciasWs = XLSX.utils.json_to_sheet(incidencias);
                            XLSX.utils.book_append_sheet(wb, incidenciasWs, 'Incidencias');
                        }
                    }

                    // Consultar activos
                    const { data: activos, error: errorActivos } = await appState.supabase
                        .from('activos')
                        .select('*')
                        .in('shift_id', shiftIds);

                    if (errorActivos) throw errorActivos;

                    if (activos && activos.length > 0) {
                        const activosWs = XLSX.utils.json_to_sheet(activos);
                        XLSX.utils.book_append_sheet(wb, activosWs, 'Activos');
                    }

                    // Generar nombre de archivo
                    let nombreArchivo = 'VOY15_Export';

                    if (fechaDesde && fechaHasta) {
                        nombreArchivo += `_${fechaDesde}_a_${fechaHasta}`;
                    } else if (fechaDesde) {
                        nombreArchivo += `_desde_${fechaDesde}`;
                    } else if (fechaHasta) {
                        nombreArchivo += `_hasta_${fechaHasta}`;
                    }

                    if (turno) {
                        nombreArchivo += `_${turno}`;
                    }

                    nombreArchivo += '.xlsx';

                    // Descargar
                    XLSX.writeFile(wb, nombreArchivo);

                    mostrarToast(`Archivo "${nombreArchivo}" generado correctamente.`, 'success');
                } else {
                    mostrarToast('No se encontraron datos para exportar.', 'warning');
                }
            } catch (error) {
                console.error('Error al exportar a Excel:', error);
                mostrarToast('Error al exportar a Excel: ' + error.message, 'error');
            }
        }
        // ===== UTILIDADES =====
        // Inicializar validaciones de formularios
        function initFormValidations() {
            // Validación de formato de hora para despachos
            ['desp-hora-prog', 'desp-hora-real'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function (e) {
                    formatearHora(e.target);
                });

                input.addEventListener('blur', function (e) {
                    validarHora(e.target);
                });
            });
        }
        // Formatear input de hora
        function formatearHora(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 0) {
                // Limitar a 4 dígitos
                value = value.substring(0, 4);
                // Agregar dos puntos después de las primeras 2 cifras si hay más de 2 dígitos
                if (value.length > 2) {
                    value = value.substring(0, 2) + ':' + value.substring(2);
                }
            }
            input.value = value;
        }
        // Validar formato de hora
        function validarHora(input) {
            const value = input.value;
            // Si está vacío, no validar
            if (!value) return;
            // Validar formato HH:MM
            if (!/^([01]?[0-9]|2[0-3]):([0-5][0-9])$/.test(value)) {
                // Intentar corregir
                let horas = 0;
                let minutos = 0;
                const parts = value.split(':');

                if (parts.length === 2) {
                    horas = parseInt(parts[0]) || 0;
                    minutos = parseInt(parts[1]) || 0;
                } else {
                    // Sin dos puntos, intentar dividir
                    if (value.length === 1 || value.length === 2) {
                        horas = parseInt(value) || 0;
                        minutos = 0;
                    } else if (value.length === 3) {
                        horas = parseInt(value.substring(0, 1)) || 0;
                        minutos = parseInt(value.substring(1, 3)) || 0;
                    } else {
                        horas = parseInt(value.substring(0, 2)) || 0;
                        minutos = parseInt(value.substring(2, 4)) || 0;
                    }
                }

                // Limitar valores
                horas = Math.min(23, Math.max(0, horas));
                minutos = Math.min(59, Math.max(0, minutos));

                // Formatear resultado
                input.value = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
            }
        }
        // Calcular retraso en minutos entre dos horas
        function calcularRetrasoMinutos(horaProg, horaReal, nextDay = false) {
            const horaRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!horaRegex.test(horaProg) || !horaRegex.test(horaReal)) {
                return 0;
            }

            const [progHoras, progMinutos] = horaProg.split(':').map(Number);
            const [realHoras, realMinutos] = horaReal.split(':').map(Number);

            let minutosProg = progHoras * 60 + progMinutos;
            let minutosReal = realHoras * 60 + realMinutos;

            if (nextDay && minutosReal < minutosProg) {
                minutosReal += 1440;
            }

            let retrasoMin = minutosReal - minutosProg;

            if (!nextDay) {
                if (retrasoMin < -720) {
                    retrasoMin += 1440;
                } else if (retrasoMin > 720) {
                    retrasoMin -= 1440;
                }
            }

            return retrasoMin;
        }
</script>
</body>
</html>
