<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOY15 - Sistema de Control Operacional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0056b3;
            --primary-dark: #003d7a;
            --primary-light: #e6f0fa;
            --secondary: #ff7800;
            --secondary-dark: #cc6000;
            --secondary-light: #fff4e6;
            --success: #198754;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #f8f9fa;
            --text-dark: #333;
            --text-light: #f8f9fa;
            --box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 5px 25px rgba(0, 0, 0, 0.12);
            --border-radius-sm: 6px;
            --border-radius: 10px;
            --border-radius-lg: 15px;
            --transition: all 0.3s ease;
            --navbar-height: 65px;
            --sidebar-width: 270px;
            --sidebar-collapsed: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #f5f7fb;
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-dark);
            font-weight: 600;
            line-height: 1.4;
        }

        a {
            text-decoration: none;
            color: var(--primary);
            transition: var(--transition);
        }

        a:hover {
            color: var(--primary-dark);
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--primary-dark) 0%, #001f3f 100%);
            color: var(--text-light);
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-header {
            height: var(--navbar-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar-logo {
            color: white;
            font-size: 28px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
            white-space: nowrap;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sidebar-logo span {
            color: var(--secondary);
        }

        .sidebar-toggle {
            margin-left: auto;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background-color: var(--secondary);
            transform: scale(1.1);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
            padding: 20px 24px 8px;
            font-weight: 600;
        }

        .sidebar.collapsed .sidebar-menu-title {
            display: none;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.8);
            transition: var(--transition);
            cursor: pointer;
            margin: 3px 12px;
            border-radius: var(--border-radius-sm);
            position: relative;
        }

        .sidebar-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar-menu-item.active {
            background: linear-gradient(90deg, var(--secondary) 0%, #ff9533 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 120, 0, 0.4);
        }

        .sidebar-menu-icon {
            width: 22px;
            text-align: center;
            margin-right: 14px;
            font-size: 18px;
        }

        .sidebar.collapsed .sidebar-menu-item {
            padding: 14px;
            margin: 8px auto;
            width: 45px;
            justify-content: center;
        }

        .sidebar.collapsed .sidebar-menu-icon {
            margin-right: 0;
        }

        .sidebar.collapsed .sidebar-menu-text {
            display: none;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            padding: 25px 35px;
            transition: var(--transition);
            background-color: #f5f7fb;
        }

        .main-content.expanded {
            margin-left: var(--sidebar-collapsed);
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaecf0;
        }

        .page-title {
            font-size: 28px;
            margin: 0;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--primary);
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .notification-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--danger) 0%, #c41e3a 100%);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .sync-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .sync-btn:hover {
            background-color: var(--success);
            color: white;
            transform: rotate(180deg);
        }

        .sync-btn.loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-dropdown {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .user-dropdown:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }

        .user-info {
            margin-right: 10px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .user-role {
            font-size: 12px;
            color: var(--gray);
        }

        .mobile-menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: var(--text-dark);
            cursor: pointer;
            transition: var(--transition);
            margin-right: 15px;
            border: 1px solid #e5e7eb;
        }

        /* CARDS */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            border: none;
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 2px solid #eaecf0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-action-btn {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            background-color: transparent;
            border: none;
        }

        .card-action-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
            transform: scale(1.1);
        }

        .card-body {
            padding: 24px;
        }

        /* KPI CARDS */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .kpi-card {
            padding: 24px;
            text-align: center;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border-top: 4px solid var(--primary);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .kpi-card.success::before {
            background: linear-gradient(90deg, var(--success) 0%, #146c43 100%);
        }

        .kpi-card.warning::before {
            background: linear-gradient(90deg, var(--warning) 0%, #cc9a06 100%);
        }

        .kpi-card.danger::before {
            background: linear-gradient(90deg, var(--danger) 0%, #b02a37 100%);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            margin: 0 auto 18px;
            transition: var(--transition);
        }

        .kpi-card:hover .kpi-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .kpi-card.success .kpi-icon {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--success);
        }

        .kpi-card.warning .kpi-icon {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .kpi-card.danger .kpi-icon {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .kpi-title {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .kpi-subtitle {
            font-size: 13px;
            color: var(--gray);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* TABLES */
        .custom-table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .custom-table {
            width: 100%;
            margin-bottom: 0;
        }

        .custom-table thead {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .custom-table th {
            padding: 16px 20px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .custom-table td {
            padding: 16px 20px;
            vertical-align: middle;
            border-bottom: 1px solid #eaecf0;
            color: var(--text-dark);
            font-size: 14px;
        }

        .custom-table tr:last-child td {
            border-bottom: none;
        }

        .custom-table tbody tr {
            transition: var(--transition);
        }

        .custom-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 90px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-abierto {
            background: linear-gradient(135deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.25) 100%);
            color: var(--success);
            border: 1px solid rgba(25, 135, 84, 0.3);
        }

        .status-cerrado {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.15) 0%, rgba(108, 117, 125, 0.25) 100%);
            color: var(--gray);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        .status-ok {
            background: linear-gradient(135deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.25) 100%);
            color: var(--success);
            border: 1px solid rgba(25, 135, 84, 0.3);
        }

        .status-falla {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(220, 53, 69, 0.25) 100%);
            color: var(--danger);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .action-buttons .btn {
            padding: 6px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin-right: 6px;
            transition: var(--transition);
        }

        .action-buttons .btn:hover {
            transform: scale(1.1);
        }

        /* FORM CONTROLS */
        .form-control, .form-select {
            height: auto;
            padding: 11px 16px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 14px;
            transition: var(--transition);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.1);
        }

        .form-label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .input-group {
            border-radius: 8px;
            overflow: hidden;
        }

        .input-group .input-group-text {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: var(--gray);
            font-weight: 500;
        }

        /* BUTTONS */
        .btn {
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.3);
        }

        .btn-primary:hover, .btn-primary:focus {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #002855 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 86, 179, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border-color: var(--secondary);
            box-shadow: 0 4px 12px rgba(255, 120, 0, 0.3);
        }

        .btn-secondary:hover, .btn-secondary:focus {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, #994800 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 120, 0, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #146c43 100%);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 135, 84, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #b02a37 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4);
        }

        .btn-light {
            background-color: white;
            border: 1px solid #d1d5db;
            color: var(--text-dark);
        }

        .btn-light:hover {
            background-color: #f9fafb;
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon.btn-sm {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }

        /* TABS */
        .nav-tabs {
            border-bottom: 2px solid #eaecf0;
            margin-bottom: 24px;
        }

        .nav-tabs .nav-item {
            margin-right: 10px;
        }

        .nav-tabs .nav-link {
            color: var(--gray);
            border: none;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            border-radius: 0;
            position: relative;
            transition: var(--transition);
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background-color: rgba(0, 86, 179, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: transparent;
        }

        .nav-tabs .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            border-radius: 3px 3px 0 0;
            transition: var(--transition);
        }

        .nav-tabs .nav-link.active::after {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        /* MODALS */
        .modal-content {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: 2px solid #eaecf0;
            background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: var(--primary);
        }

        .modal-body {
            padding: 28px;
        }

        .modal-footer {
            border-top: 2px solid #eaecf0;
            padding: 18px 28px;
            background-color: #f8f9fa;
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            width: 360px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            overflow: hidden;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-header {
            background-color: white;
            color: var(--text-dark);
            border-bottom: 1px solid #eaecf0;
            padding: 14px 16px;
            font-weight: 600;
        }

        .toast-body {
            padding: 14px 16px;
            background-color: white;
        }

        .toast-success .toast-header {
            background: linear-gradient(90deg, rgba(25, 135, 84, 0.15) 0%, rgba(25, 135, 84, 0.25) 100%);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .toast-error .toast-header {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.15) 0%, rgba(220, 53, 69, 0.25) 100%);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .toast-warning .toast-header {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.25) 100%);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        .toast-info .toast-header {
            background: linear-gradient(90deg, rgba(0, 86, 179, 0.15) 0%, rgba(0, 86, 179, 0.25) 100%);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        /* LOADING SCREEN */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #001f3f 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        /* PAGINATION */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: #f9fafb;
            border-top: 2px solid #eaecf0;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        .pagination {
            margin-bottom: 0;
        }

        .pagination .page-link {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin: 0 4px;
            border: 1px solid #d1d5db;
            color: var(--text-dark);
            font-size: 14px;
            padding: 0;
            font-weight: 600;
            transition: var(--transition);
        }

        .pagination .page-link:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, #cce0f5 100%);
            border-color: var(--primary);
            color: var(--primary);
            transform: scale(1.05);
        }

        .pagination .page-link:focus {
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.15);
        }

        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.3);
        }

        .pagination .page-item.disabled .page-link {
            color: #9ca3af;
            background-color: #f5f5f5;
            border-color: #e5e7eb;
        }

        /* ACTIVITY FEED */
        .activity-feed {
            max-height: 450px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 16px;
            border-bottom: 1px solid #eaecf0;
            display: flex;
            transition: var(--transition);
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light) 0%, #cce0f5 100%);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
            font-size: 18px;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--text-dark);
        }

        .activity-time {
            font-size: 12px;
            color: var(--gray);
        }

        /* ON-TIME / DELAY STYLES */
        .ontime {
            color: var(--success);
            font-weight: 600;
        }

        .delay {
            color: var(--danger);
            font-weight: 600;
        }

        .ontime::before, .delay::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 6px;
        }

        .ontime::before {
            content: "\f058";
        }

        .delay::before {
            content: "\f071";
        }

        /* STATUS DOTS */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.green {
            background-color: var(--success);
            box-shadow: 0 0 8px rgba(25, 135, 84, 0.5);
        }

        .status-dot.red {
            background-color: var(--danger);
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
        }

        .status-dot.yellow {
            background-color: var(--warning);
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }

        .status-dot.gray {
            background-color: var(--gray);
        }

        /* EXPORT DROPDOWN */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            min-width: 180px;
            background-color: white;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1;
            border: 1px solid #eaecf0;
            overflow: hidden;
            margin-top: 8px;
        }

        .export-dropdown-content a {
            display: block;
            padding: 12px 16px;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 14px;
            transition: var(--transition);
            font-weight: 500;
        }

        .export-dropdown-content a:hover {
            background: linear-gradient(90deg, var(--primary-light) 0%, #cce0f5 100%);
            color: var(--primary);
            transform: translateX(4px);
        }

        .export-dropdown-content a i {
            margin-right: 10px;
            color: var(--gray);
            width: 20px;
        }

        .export-dropdown:hover .export-dropdown-content {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark) 0%, #002855 100%);
        }

        /* UTILITY CLASSES */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .fw-medium {
            font-weight: 500;
        }

        .fw-semibold {
            font-weight: 600;
        }

        .small-text {
            font-size: 13px;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .border-dashed {
            border-style: dashed !important;
        }

        /* ALERTS */
        .alert {
            border-radius: 10px;
            border: none;
            padding: 16px 20px;
        }

        .alert-info {
            background: linear-gradient(90deg, rgba(0, 86, 179, 0.1) 0%, rgba(0, 86, 179, 0.15) 100%);
            border-left: 4px solid var(--primary);
            color: var(--primary-dark);
        }

        .alert-success {
            background: linear-gradient(90deg, rgba(25, 135, 84, 0.1) 0%, rgba(25, 135, 84, 0.15) 100%);
            border-left: 4px solid var(--success);
            color: #0f5132;
        }

        .alert-warning {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.15) 100%);
            border-left: 4px solid var(--warning);
            color: #997404;
        }

        .alert-danger {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.15) 100%);
            border-left: 4px solid var(--danger);
            color: #842029;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 260px;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .top-bar {
                flex-wrap: wrap;
            }
            
            .page-title {
                width: 100%;
                margin-bottom: 15px;
                font-size: 24px;
            }
        }

        @media (max-width: 576px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                display: none;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-title {
                margin-bottom: 10px;
            }
            
            .card-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            color: var(--gray);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-state-text {
            color: var(--gray);
            margin-bottom: 20px;
        }

        /* SPINNER */
        .spinner-border {
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-container" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Cargando VOY15...</div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-logo">VOY<span>15</span></h1>
            <div class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        
        <div class="sidebar-menu">
            <div class="sidebar-menu-title">PRINCIPAL</div>
            <div class="sidebar-menu-item active" id="dashboardLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="sidebar-menu-text">Dashboard</div>
            </div>
            
            <div class="sidebar-menu-item" id="turnosLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="sidebar-menu-text">Control de Turnos</div>
            </div>
            
            <div class="sidebar-menu-item" id="registrosLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="sidebar-menu-text">Registros</div>
            </div>
            
            <div class="sidebar-menu-title">ANÁLISIS</div>
            
            <div class="sidebar-menu-item" id="informesLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="sidebar-menu-text">Informes</div>
            </div>
            
            <div class="sidebar-menu-item" id="kpisLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="sidebar-menu-text">KPI's</div>
            </div>
            
            <div class="sidebar-menu-title">CONFIGURACIÓN</div>
            
            <div class="sidebar-menu-item" id="catalogosLink">
                <div class="sidebar-menu-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="sidebar-menu-text">Catálogos</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Mobile Menu Toggle -->
        <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </div>
        
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="page-title">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard Operacional
            </h1>
            
            <div class="top-bar-actions">
                <div class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
                
                <div class="sync-btn" id="syncButton">
                    <i class="fas fa-sync-alt"></i>
                </div>
                
                <div class="user-dropdown">
                    <div class="user-avatar">D</div>
                    <div class="user-info">
                        <div class="user-name">Despachador</div>
                        <div class="user-role">Operaciones</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="row mb-4">
                <div class="col-md-8 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        <input type="date" class="form-control" id="dashboardDateFilter">
                        <button class="btn btn-primary" id="applyDateFilterBtn">
                            <i class="fas fa-filter"></i> Aplicar
                        </button>
                    </div>
                </div>
                <div class="col-md-4 mb-3 text-md-end">
                    <button class="btn btn-primary me-2" id="newTurnoBtn">
                        <i class="fas fa-plus-circle"></i> Nuevo Turno
                    </button>
                    <div class="export-dropdown d-inline-block">
                        <button class="btn btn-light">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <div class="export-dropdown-content">
                            <a href="#" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Excel</a>
                            <a href="#" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> PDF</a>
                            <a href="#" id="exportCsvBtn"><i class="fas fa-file-csv"></i> CSV</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-bus"></i>
                    </div>
                    <div class="kpi-title">Buses Operativos</div>
                    <div class="kpi-value" id="kpiBusesOperativos">0</div>
                    <div class="kpi-subtitle">de <span id="kpiFlotaTotal">0</span> buses en flota</div>
                </div>
                
                <div class="kpi-card warning">
                    <div class="kpi-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <div class="kpi-title">Buses en Mantención</div>
                    <div class="kpi-value" id="kpiBusesMantencion">0</div>
                    <div class="kpi-subtitle"><span id="kpiPorcentajeMantencion">0</span>% de la flota</div>
                </div>
                
                <div class="kpi-card success">
                    <div class="kpi-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="kpi-title">Puntualidad Primera</div>
                    <div class="kpi-value" id="kpiPuntualidadPrimera">0%</div>
                    <div class="kpi-subtitle">Salidas a tiempo</div>
                </div>
                
                <div class="kpi-card success">
                    <div class="kpi-icon">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <div class="kpi-title">Puntualidad Última</div>
                    <div class="kpi-value" id="kpiPuntualidadUltima">0%</div>
                    <div class="kpi-subtitle">Salidas a tiempo</div>
                </div>
                
                <div class="kpi-card danger">
                    <div class="kpi-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="kpi-title">Cancelaciones</div>
                    <div class="kpi-value" id="kpiCancelaciones">0</div>
                    <div class="kpi-subtitle">servicios cancelados</div>
                </div>
                
                <div class="kpi-card danger">
                    <div class="kpi-icon">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="kpi-title">Ausencias</div>
                    <div class="kpi-value" id="kpiAusencias">0</div>
                    <div class="kpi-subtitle">conductores ausentes</div>
                </div>
                
                <div class="kpi-card warning">
                    <div class="kpi-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="kpi-title">Llaves Faltantes</div>
                    <div class="kpi-value" id="kpiLlavesFaltantes">0</div>
                    <div class="kpi-subtitle">pendientes de entrega</div>
                </div>
                
                <div class="kpi-card danger">
                    <div class="kpi-icon">
                        <i class="fas fa-phone-slash"></i>
                    </div>
                    <div class="kpi-title">Teléfonos con Falla</div>
                    <div class="kpi-value" id="kpiTelefonosFalla">0</div>
                    <div class="kpi-subtitle">equipos reportados</div>
                </div>
            </div>

            <!-- Content Cards -->
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Tendencia de Puntualidad
                            </h5>
                            <div class="card-actions">
                                <button class="card-action-btn" id="refreshChartBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="card-action-btn" id="expandChartBtn">
                                    <i class="fas fa-expand-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="puntualidadChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <!-- Current Shift Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-clock"></i>
                                Turno Actual
                            </h5>
                            <div class="card-actions">
                                <button class="card-action-btn" id="refreshTurnoBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="currentShiftLoader" style="display: none;">
                                <div class="d-flex justify-content-center my-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noCurrentShiftMessage" style="display: none;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <h6 class="empty-state-title">No hay turno abierto</h6>
                                    <p class="empty-state-text">No hay turno abierto para la fecha seleccionada</p>
                                    <button class="btn btn-primary" id="createTurnoBtn">
                                        <i class="fas fa-plus-circle"></i> Crear Nuevo Turno
                                    </button>
                                </div>
                            </div>
                            
                            <div id="currentShiftData">
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <h6 class="mb-1">Turno: <span id="currentShiftTurno" class="fw-normal">AM</span></h6>
                                        <div class="text-muted small">Fecha: <span id="currentShiftFecha">17/10/2025</span></div>
                                    </div>
                                    <div class="text-end">
                                        <span class="status-badge status-abierto">Abierto</span>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <div class="fw-medium small">Despachador:</div>
                                        <div id="currentShiftDespachador">-</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-medium small">Estado Teléfono:</div>
                                        <div><span id="currentShiftTelStatus" class="status-badge status-ok">OK</span></div>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <div class="fw-medium small">Operativos:</div>
                                        <div id="currentShiftOperativos" class="fw-bold text-success">0</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-medium small">Mantención:</div>
                                        <div id="currentShiftMantencion" class="fw-bold text-warning">0</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-medium small">Diferencia:</div>
                                        <div id="currentShiftDiferencia" class="fw-bold">0</div>
                                    </div>
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="closeCurrentShiftBtn">
                                        <i class="fas fa-check-circle"></i> Cerrar Turno
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-history"></i>
                                Actividad Reciente
                            </h5>
                            <div class="card-actions">
                                <button class="card-action-btn" id="refreshActivityBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="activityLoader" style="display: none;">
                                <div class="d-flex justify-content-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noActivityMessage" style="display: none;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <p class="empty-state-text mb-0">No hay actividad reciente para mostrar.</p>
                                </div>
                            </div>
                            
                            <div class="activity-feed" id="activityFeed">
                                <!-- Activity items will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Turnos View -->
        <div id="turnosView" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-8 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        <input type="date" class="form-control" id="turnosDateFilter">
                        <button class="btn btn-primary" id="turnosApplyFilterBtn">
                            <i class="fas fa-filter"></i> Aplicar
                        </button>
                    </div>
                </div>
                <div class="col-md-4 mb-3 text-md-end">
                    <button class="btn btn-primary" id="turnosNuevoBtn">
                        <i class="fas fa-plus-circle"></i> Nuevo Turno
                    </button>
                </div>
            </div>

            <!-- Tabs & Content -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-clock"></i>
                        Control de Turnos
                    </h5>
                </div>
                <div class="card-body p-0">
                    <ul class="nav nav-tabs" id="turnosTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="turnos-abiertos-tab" data-bs-toggle="tab" data-bs-target="#turnos-abiertos" type="button" role="tab">
                                <i class="fas fa-folder-open"></i> Turnos Abiertos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="turnos-cerrados-tab" data-bs-toggle="tab" data-bs-target="#turnos-cerrados" type="button" role="tab">
                                <i class="fas fa-folder"></i> Turnos Cerrados
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="turnosTabsContent">
                        <!-- Turnos Abiertos Tab -->
                        <div class="tab-pane fade show active" id="turnos-abiertos" role="tabpanel">
                            <div id="turnosAbiertosLoader" style="display: none;">
                                <div class="d-flex justify-content-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noTurnosAbiertosMessage" style="display: none;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-clipboard-list"></i>
                                    </div>
                                    <h6 class="empty-state-title">No hay turnos abiertos</h6>
                                    <p class="empty-state-text">No hay turnos abiertos para la fecha seleccionada</p>
                                    <button class="btn btn-primary" id="createTurnoFromListBtn">
                                        <i class="fas fa-plus-circle"></i> Crear Nuevo Turno
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="custom-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Turno</th>
                                            <th>Despachador</th>
                                            <th>Tel. Inicio</th>
                                            <th>Op. Inicio</th>
                                            <th>Mant. Inicio</th>
                                            <th>Diferencia</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="turnosAbiertosTableBody">
                                        <!-- Turnos abiertos will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Turnos Cerrados Tab -->
                        <div class="tab-pane fade" id="turnos-cerrados" role="tabpanel">
                            <div id="turnosCerradosLoader" style="display: none;">
                                <div class="d-flex justify-content-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="noTurnosCerradosMessage" style="display: none;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <p class="empty-state-text mb-0">No hay turnos cerrados para la fecha seleccionada.</p>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="custom-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Turno</th>
                                            <th>Despachador</th>
                                            <th>Op. Inicio</th>
                                            <th>Mant. Inicio</th>
                                            <th>Op. Cierre</th>
                                            <th>Mant. Cierre</th>
                                            <th>Fecha Cierre</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="turnosCerradosTableBody">
                                        <!-- Turnos cerrados will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination-container">
                                <div class="pagination-info" id="turnosCerradosPaginationInfo">
                                    Mostrando 0 de 0 turnos
                                </div>
                                <nav aria-label="Paginación de turnos">
                                    <ul class="pagination" id="turnosCerradosPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registros View -->
        <div id="registrosView" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-8 mb-3">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                <input type="date" class="form-control" id="registrosDateFilter">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="registrosTurnoFilter">
                                <option value="">Todos los turnos</option>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                                <option value="Noche">Noche</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="registrosEventoFilter">
                                <option value="">Todos los eventos</option>
                                <option value="PrimeraSalida">Primera Salida</option>
                                <option value="UltimaSalida">Última Salida</option>
                                <option value="Cancelación">Cancelación</option>
                                <option value="BusOperativo">Bus Operativo</option>
                                <option value="BusDetenido">Bus Detenido</option>
                                <option value="AusenciaConductor">Ausencia Conductor</option>
                                <option value="LlavesFaltantes">Llaves Faltantes</option>
                                <option value="TelefonoOK">Teléfono OK</option>
                                <option value="TelefonoFalla">Teléfono Falla</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="row g-2">
                        <div class="col-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="registrosSearchInput" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <button class="btn btn-primary w-100" id="registrosNuevoBtn">
                                <i class="fas fa-plus-circle"></i> Nuevo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros Content -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-clipboard-list"></i>
                        Registro de Eventos
                    </h5>
                    <div class="card-actions">
                        <div class="export-dropdown">
                            <button class="btn btn-light btn-sm">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <div class="export-dropdown-content">
                                <a href="#" id="registrosExportExcelBtn"><i class="fas fa-file-excel"></i> Excel</a>
                                <a href="#" id="registrosExportPdfBtn"><i class="fas fa-file-pdf"></i> PDF</a>
                                <a href="#" id="registrosExportCsvBtn"><i class="fas fa-file-csv"></i> CSV</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="registrosLoader" style="display: none;">
                        <div class="d-flex justify-content-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noRegistrosMessage" style="display: none;">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <p class="empty-state-text mb-0">No hay registros para mostrar.</p>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Turno</th>
                                    <th>Servicio</th>
                                    <th>PPU</th>
                                    <th>Conductor</th>
                                    <th>Tipo Evento</th>
                                    <th>Hora Prog.</th>
                                    <th>Hora Real</th>
                                    <th>Retraso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="registrosTableBody">
                                <!-- Registros will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination-container">
                        <div class="pagination-info" id="registrosPaginationInfo">
                            Mostrando 0 de 0 registros
                        </div>
                        <nav aria-label="Paginación de registros">
                            <ul class="pagination" id="registrosPagination">
                                <!-- Pagination buttons will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informes View -->
        <div id="informesView" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Generación de Informes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3 mb-3">
                                    <label for="tipoInformeSelect" class="form-label">Tipo de Informe</label>
                                    <select class="form-select" id="tipoInformeSelect">
                                        <option value="diario">Informe Diario</option>
                                        <option value="semanal">Informe Semanal</option>
                                        <option value="mensual">Informe Mensual</option>
                                        <option value="servicios">Por Servicios</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="fechaInicioInforme" class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="fechaInicioInforme">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="fechaFinInforme" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="fechaFinInforme">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label d-block">&nbsp;</label>
                                    <button class="btn btn-primary w-100" id="generarInformeBtn">
                                        <i class="fas fa-chart-line"></i> Generar Informe
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="informeResultadosContainer" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title" id="informeTitulo">
                            <i class="fas fa-file-alt"></i>
                            Resultados del Informe
                        </h5>
                        <div class="card-actions">
                            <div class="export-dropdown">
                                <button class="btn btn-light btn-sm">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <div class="export-dropdown-content">
                                    <a href="#" id="informeExportExcelBtn"><i class="fas fa-file-excel"></i> Excel</a>
                                    <a href="#" id="informeExportPdfBtn"><i class="fas fa-file-pdf"></i> PDF</a>
                                    <a href="#" id="informeExportCsvBtn"><i class="fas fa-file-csv"></i> CSV</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <canvas id="informeChart1"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <canvas id="informeChart2"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="custom-table" id="informeTablaResultados">
                                <thead>
                                    <tr id="informeTableHeader">
                                        <!-- Header columns will be generated dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="informeTableBody">
                                    <!-- Table content will be generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs View -->
        <div id="kpisView" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-8 mb-3">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                <input type="date" class="form-control" id="kpisDesdeFilter" placeholder="Desde">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                <input type="date" class="form-control" id="kpisHastaFilter" placeholder="Hasta">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" id="kpisApplyFilterBtn">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3 text-md-end">
                    <div class="export-dropdown d-inline-block">
                        <button class="btn btn-light">
                            <i class="fas fa-download"></i> Exportar Datos
                        </button>
                        <div class="export-dropdown-content">
                            <a href="#" id="kpisExportExcelBtn"><i class="fas fa-file-excel"></i> Excel</a>
                            <a href="#" id="kpisExportPdfBtn"><i class="fas fa-file-pdf"></i> PDF</a>
                            <a href="#" id="kpisExportCsvBtn"><i class="fas fa-file-csv"></i> CSV</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-clock"></i>
                                Puntualidad
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="puntualidadKpiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-ban"></i>
                                Cancelaciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="cancelacionesKpiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-bus"></i>
                                Estado de Flota
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="flotaKpiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-route"></i>
                                Tendencia por Servicio
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="serviciosKpiChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-list-check"></i>
                                Resumen Operacional
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless">
                                    <tbody>
                                        <tr>
                                            <td>Puntualidad Primera Salida:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenPuntualidadPrimera">-</td>
                                        </tr>
                                        <tr>
                                            <td>Puntualidad Última Salida:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenPuntualidadUltima">-</td>
                                        </tr>
                                        <tr>
                                            <td>Flota Operativa Promedio:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenFlotaOperativa">-</td>
                                        </tr>
                                        <tr>
                                            <td>Promedio Cancelaciones:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenCancelaciones">-</td>
                                        </tr>
                                        <tr>
                                            <td>Retraso Promedio:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenRetrasoPromedio">-</td>
                                        </tr>
                                        <tr>
                                            <td>Tasa de Ausencia:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenTasaAusencia">-</td>
                                        </tr>
                                        <tr>
                                            <td>Fallas de Equipo:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenFallasEquipo">-</td>
                                        </tr>
                                        <tr>
                                            <td>Índice de Cumplimiento:</td>
                                            <td class="text-end fw-semibold" id="kpiResumenCumplimiento">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catálogos View -->
        <div id="catalogosView" style="display: none;">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-user-tie"></i>
                                Despachadores
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="nuevoDespachadorInput" placeholder="Nombre del despachador">
                                    <button class="btn btn-primary" id="agregarDespachadorBtn">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="despachadorLoader" style="display: none;" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            
                            <div class="list-group" id="despachadorList" style="max-height: 350px; overflow-y: auto;">
                                <!-- Despachadores will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-route"></i>
                                Servicios
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="nuevoServicioInput" placeholder="Número de servicio">
                                    <button class="btn btn-primary" id="agregarServicioBtn">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="serviciosLoader" style="display: none;" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            
                            <div class="list-group" id="serviciosList" style="max-height: 350px; overflow-y: auto;">
                                <!-- Servicios will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-id-card"></i>
                                Conductores
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="nuevoConductorInput" placeholder="Nombre del conductor">
                                    <button class="btn btn-primary" id="agregarConductorBtn">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="conductoresLoader" style="display: none;" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            
                            <div class="list-group" id="conductoresList" style="max-height: 350px; overflow-y: auto;">
                                <!-- Conductores will be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-bus"></i>
                                Buses
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-5">
                                        <input type="text" class="form-control" id="nuevoBusPPUInput" placeholder="PPU (Patente)">
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" id="nuevoBusTipoInput">
                                            <option value="">Tipo de Bus</option>
                                            <option value="B">B</option>
                                            <option value="C">C</option>
                                        </select>
                                    </div>
                                    <div class="col-3">
                                        <button class="btn btn-primary w-100" id="agregarBusBtn">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="busesLoader" style="display: none;" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                                <table class="custom-table">
                                    <thead>
                                        <tr>
                                            <th>PPU</th>
                                            <th>Tipo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="busesTableBody">
                                        <!-- Buses will be loaded here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-cog"></i>
                                Parámetros del Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="parametrosForm">
                                <div class="row g-3">
                                    <div class="col-md-4 mb-3">
                                        <label for="flotaTotal" class="form-label">Flota Total</label>
                                        <input type="number" class="form-control" id="flotaTotal" min="1" required>
                                        <div class="form-text">Número total de buses en la flota</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="toleranciaAtraso" class="form-label">Tolerancia de Atraso (min)</label>
                                        <input type="number" class="form-control" id="toleranciaAtraso" min="0" required>
                                        <div class="form-text">Minutos de atraso permitidos</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="toleranciaAnticipo" class="form-label">Tolerancia de Anticipo (min)</label>
                                        <input type="number" class="form-control" id="toleranciaAnticipo" min="0" required>
                                        <div class="form-text">Minutos de anticipo permitidos</div>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="submit" class="btn btn-success" id="guardarParametrosBtn">
                                        <i class="fas fa-save"></i> Guardar Parámetros
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Nuevo Turno Modal -->
    <div class="modal fade" id="nuevoTurnoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevoTurnoModalLabel">
                        <i class="fas fa-plus-circle"></i>
                        Nuevo Turno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevoTurnoForm">
                        <input type="hidden" id="turnoIdInput" value="">
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="turnoFechaInput" class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="turnoFechaInput" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="turnoTurnoInput" class="form-label">Turno</label>
                                <select class="form-select" id="turnoTurnoInput" required>
                                    <option value="">Seleccione...</option>
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                    <option value="Noche">Noche</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="turnoDespachadorInput" class="form-label">Despachador</label>
                            <select class="form-select" id="turnoDespachadorInput" required>
                                <option value="">Seleccione un despachador...</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="turnoTelInicioInput" class="form-label">Estado Teléfono</label>
                                <select class="form-select" id="turnoTelInicioInput">
                                    <option value="">Seleccione...</option>
                                    <option value="OK">OK</option>
                                    <option value="Falla">Falla</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="turnoLlavesIniInput" class="form-label">Llaves Inicio</label>
                                <input type="number" class="form-control" id="turnoLlavesIniInput" min="0" value="0">
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="turnoOpIniInput" class="form-label">Buses Operativos</label>
                                <input type="number" class="form-control" id="turnoOpIniInput" min="0" required value="0">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="turnoManIniInput" class="form-label">Buses en Mantención</label>
                                <input type="number" class="form-control" id="turnoManIniInput" min="0" required value="0">
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-center" id="turnoDiferenciaAlert">
                            <i class="fas fa-info-circle me-3 fa-lg"></i>
                            <div>
                                <strong>Diferencia:</strong> <span id="turnoDiffIniValue">0</span>
                                <div class="small">Basado en flota total de <span id="turnoFlotaTotal">0</span> buses</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="guardarTurnoBtn">
                        <i class="fas fa-save"></i> Guardar Turno
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cerrar Turno Modal -->
    <div class="modal fade" id="cerrarTurnoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i>
                        Cerrar Turno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cerrarTurnoForm">
                        <input type="hidden" id="cerrarTurnoIdInput" value="">
                        
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="small fw-medium">Fecha:</div>
                                        <div id="cerrarTurnoFechaText"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="small fw-medium">Turno:</div>
                                        <div id="cerrarTurnoTurnoText"></div>
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-md-6">
                                        <div class="small fw-medium">Despachador:</div>
                                        <div id="cerrarTurnoDespachadorText"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="small fw-medium">Estado Inicial:</div>
                                        <div id="cerrarTurnoEstadoInicialText"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Información de Cierre</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="cerrarTurnoTelFinInput" class="form-label">Estado Teléfono</label>
                                <select class="form-select" id="cerrarTurnoTelFinInput" required>
                                    <option value="">Seleccione...</option>
                                    <option value="OK">OK</option>
                                    <option value="Falla">Falla</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="cerrarTurnoLlavesFinInput" class="form-label">Llaves Fin</label>
                                <input type="number" class="form-control" id="cerrarTurnoLlavesFinInput" min="0" value="0">
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="cerrarTurnoOpFinInput" class="form-label">Buses Operativos</label>
                                <input type="number" class="form-control" id="cerrarTurnoOpFinInput" min="0" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="cerrarTurnoManFinInput" class="form-label">Buses en Mantención</label>
                                <input type="number" class="form-control" id="cerrarTurnoManFinInput" min="0" required>
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-center" id="cerrarTurnoDiferenciaAlert">
                            <i class="fas fa-info-circle me-3 fa-lg"></i>
                            <div>
                                <strong>Diferencia:</strong> <span id="cerrarTurnoDiffFinValue">0</span>
                                <div class="small">Basado en flota total de <span id="cerrarTurnoFlotaTotal">0</span> buses</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cerrarTurnoNotasInput" class="form-label">Notas de Cierre</label>
                            <textarea class="form-control" id="cerrarTurnoNotasInput" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="confirmarCerrarTurnoBtn">
                        <i class="fas fa-check-circle"></i> Confirmar Cierre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nuevo Registro Modal -->
    <div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevoRegistroModalLabel">
                        <i class="fas fa-plus-circle"></i>
                        Nuevo Registro
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevoRegistroForm">
                        <input type="hidden" id="registroIdInput" value="">
                        
                        <div class="row g-3">
                            <div class="col-md-4 mb-3">
                                <label for="registroFechaInput" class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="registroFechaInput" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="registroTurnoInput" class="form-label">Turno</label>
                                <select class="form-select" id="registroTurnoInput" required>
                                    <option value="">Seleccione...</option>
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                    <option value="Noche">Noche</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="registroTipoEventoInput" class="form-label">Tipo de Evento</label>
                                <select class="form-select" id="registroTipoEventoInput" required>
                                    <option value="">Seleccione...</option>
                                    <option value="PrimeraSalida">Primera Salida</option>
                                    <option value="UltimaSalida">Última Salida</option>
                                    <option value="Cancelación">Cancelación</option>
                                    <option value="BusOperativo">Bus Operativo</option>
                                    <option value="BusDetenido">Bus Detenido</option>
                                    <option value="AusenciaConductor">Ausencia Conductor</option>
                                    <option value="LlavesFaltantes">Llaves Faltantes</option>
                                    <option value="TelefonoOK">Teléfono OK</option>
                                    <option value="TelefonoFalla">Teléfono Falla</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="registroDetallesContainer">
                            <div class="row g-3">
                                <div class="col-md-4 mb-3">
                                    <label for="registroServicioInput" class="form-label">Servicio</label>
                                    <select class="form-select" id="registroServicioInput">
                                        <option value="">Seleccione...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="registroTipoBusInput" class="form-label">Tipo Bus</label>
                                    <select class="form-select" id="registroTipoBusInput">
                                        <option value="">Seleccione...</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="registroPPUInput" class="form-label">PPU</label>
                                    <select class="form-select" id="registroPPUInput">
                                        <option value="">Seleccione...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4 mb-3">
                                    <label for="registroConductorInput" class="form-label">Conductor</label>
                                    <select class="form-select" id="registroConductorInput">
                                        <option value="">Seleccione...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="registroDespachadorInput" class="form-label">Despachador</label>
                                    <select class="form-select" id="registroDespachadorInput">
                                        <option value="">Seleccione...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div class="col-md-4 mb-3" id="registroMotivoContainer" style="display: none;">
                                    <label for="registroMotivoInput" class="form-label">Motivo</label>
                                    <select class="form-select" id="registroMotivoInput">
                                        <option value="">Seleccione...</option>
                                        <option value="Conductor">Conductor</option>
                                        <option value="Falta de Bus">Falta de Bus</option>
                                        <option value="Mantenimiento">Mantenimiento</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-3" id="registroHorariosContainer" style="display: none;">
                                <div class="col-md-4 mb-3">
                                    <label for="registroHoraProgInput" class="form-label">Hora Programada</label>
                                    <input type="text" class="form-control" id="registroHoraProgInput" placeholder="HH:MM" maxlength="5">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="registroHoraRealInput" class="form-label">Hora Real</label>
                                    <input type="text" class="form-control" id="registroHoraRealInput" placeholder="HH:MM" maxlength="5">
                                </div>
                                
                                <div class="col-md-4 mb-3 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="registroNextDayInput">
                                        <label class="form-check-label" for="registroNextDayInput">
                                            Cruza medianoche
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3" id="registroTelefonoContainer" style="display: none;">
                                <div class="col-md-4 mb-3">
                                    <label for="registroTelInput" class="form-label">Estado Teléfono</label>
                                    <select class="form-select" id="registroTelInput">
                                        <option value="OK">OK</option>
                                        <option value="Falla">Falla</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="registroObsInput" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="registroObsInput" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="guardarRegistroBtn">
                        <i class="fas fa-save"></i> Guardar Registro
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ver Registro Modal -->
    <div class="modal fade" id="verRegistroModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i>
                        Detalles del Registro
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-borderless">
                        <tbody id="verRegistroDetalles">
                            <!-- Details will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="editarRegistroBtn">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">¿Está seguro que desea eliminar este elemento?</p>
                    <input type="hidden" id="deleteItemId" value="">
                    <input type="hidden" id="deleteItemType" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN GLOBAL
        // ============================================
        const CONFIG = {
            FLOTA_TOTAL: 124,
            TOL_ATRASO_MIN: 5,
            TOL_ANTICIPO_MIN: 1,
            API_TURNOS: '/api/turnos',
            API_REGISTROS: '/api/registros',
            API_CATALOGS: '/api/catalogos',
            SUPABASE_URL: 'https://bclorwyvziffzjgkvlng.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbG9yd3l2emlmZnpqZ2t2bG5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTY3MzQsImV4cCI6MjA3NjI3MjczNH0.cbul1Zfle1Ifi7gSe1JoJ2gOIvFNeIFTy2SheAlTxPU',
            DEBUG: true
        };

        const SERVICIO_HORARIOS = {
            '505': { primera: '05:10', ultima: '23:40' },
            '513': { primera: '00:00', ultima: '23:40' },
            '517': { primera: '05:51', ultima: '22:20' }
        };

        // Inicializar Supabase
        let supabaseClient = null;
        if (window.supabase && CONFIG.SUPABASE_URL && CONFIG.SUPABASE_KEY) {
            try {
                supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                console.log('✅ Supabase inicializado correctamente');
            } catch (error) {
                console.error('❌ Error al inicializar Supabase:', error);
            }
        }

        // ============================================
        // API CONTROLLER
        // ============================================
        const API = {
            async request(endpoint, options = {}) {
                const method = (options.method || 'GET').toUpperCase();
                
                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase no está disponible');
                    }

                    if (endpoint.startsWith(CONFIG.API_TURNOS)) {
                        return await this.handleSupabaseTurnos(endpoint, options);
                    }

                    if (endpoint.startsWith(CONFIG.API_REGISTROS)) {
                        return await this.handleSupabaseRegistros(endpoint, options);
                    }

                    if (endpoint.startsWith(CONFIG.API_CATALOGS)) {
                        return await this.handleSupabaseCatalogos(endpoint, options);
                    }

                    return { success: false, message: 'Endpoint no implementado', data: null };
                } catch (error) {
                    console.error('Error en solicitud API:', error);
                    return { success: false, message: error.message, data: null };
                }
            },

            async handleSupabaseTurnos(endpoint, options) {
                const method = options.method || 'GET';
                const url = new URL(endpoint, window.location.origin);
                const params = Object.fromEntries(url.searchParams.entries());

                try {
                    if (method === 'GET') {
                        if (params.id) {
                            const { data, error } = await supabaseClient
                                .from('turnos')
                                .select('*, despachadores(nombre)')
                                .eq('id', params.id)
                                .maybeSingle();

                            if (error) throw error;
                            return {
                                success: !!data,
                                message: data ? 'Turno encontrado' : 'Turno no encontrado',
                                data: data ? { ...data, despachador: data.despachadores?.nombre } : null
                            };
                        }

                        let query = supabaseClient
                            .from('turnos')
                            .select('*, despachadores(nombre)', { count: 'exact' })
                            .order('fecha', { ascending: false })
                            .order('turno', { ascending: true });

                        if (params.fecha_inicio && params.fecha_fin) {
                            query = query.gte('fecha', params.fecha_inicio).lte('fecha', params.fecha_fin);
                        } else if (params.fecha) {
                            query = query.eq('fecha', params.fecha);
                        }

                        if (params.estado) {
                            query = query.eq('estado', params.estado);
                        }

                        const { data, error, count } = await query;
                        if (error) throw error;

                        const turnos = (data || []).map(t => ({
                            ...t,
                            despachador: t.despachadores?.nombre,
                            diff_ini: CONFIG.FLOTA_TOTAL - (t.op_ini || 0) - (t.man_ini || 0),
                            diff_fin: t.op_fin ? CONFIG.FLOTA_TOTAL - (t.op_fin || 0) - (t.man_fin || 0) : null
                        }));

                        return {
                            success: true,
                            message: 'Turnos obtenidos correctamente',
                            data: turnos,
                            total: count || turnos.length
                        };
                    }

                    if (method === 'POST') {
                        const turnoData = this.parseBody(options.body);
                        const despachadorNombre = turnoData.despachador;

                        if (!despachadorNombre) throw new Error('Despachador requerido');

                        const { data: despachador, error: despachadorError } = await supabaseClient
                            .from('despachadores')
                            .select('id')
                            .eq('nombre', despachadorNombre)
                            .maybeSingle();

                        if (despachadorError) throw despachadorError;
                        if (!despachador) throw new Error('Despachador no encontrado');

                        const insertPayload = {
                            fecha: turnoData.fecha,
                            turno: turnoData.turno,
                            despachador_id: despachador.id,
                            tel_inicio: turnoData.tel_inicio || null,
                            llaves_ini: turnoData.llaves_ini || 0,
                            op_ini: turnoData.op_ini || 0,
                            man_ini: turnoData.man_ini || 0,
                            estado: 'Abierto'
                        };

                        const { data, error } = await supabaseClient
                            .from('turnos')
                            .insert(insertPayload)
                            .select('*, despachadores(nombre)')
                            .single();

                        if (error) throw error;

                        return {
                            success: true,
                            message: 'Turno creado correctamente',
                            data: { ...data, despachador: data.despachadores?.nombre }
                        };
                    }

                    if (method === 'PUT') {
                        const turnoId = endpoint.split('/').pop();
                        const turnoData = this.parseBody(options.body);
                        const updatePayload = { ...turnoData };

                        if (updatePayload.despachador) {
                            const { data: despachador, error: despachadorError } = await supabaseClient
                                .from('despachadores')
                                .select('id')
                                .eq('nombre', updatePayload.despachador)
                                .maybeSingle();

                            if (despachadorError) throw despachadorError;
                            if (!despachador) throw new Error('Despachador no encontrado');

                            updatePayload.despachador_id = despachador.id;
                            delete updatePayload.despachador;
                        }

                        const { data, error } = await supabaseClient
                            .from('turnos')
                            .update(updatePayload)
                            .eq('id', turnoId)
                            .select('*, despachadores(nombre)')
                            .maybeSingle();

                        if (error) throw error;
                        if (!data) return { success: false, message: 'Turno no encontrado', data: null };

                        return {
                            success: true,
                            message: 'Turno actualizado correctamente',
                            data: { ...data, despachador: data.despachadores?.nombre }
                        };
                    }

                    if (method === 'DELETE') {
                        const turnoId = endpoint.split('/').pop();
                        const { error } = await supabaseClient.from('turnos').delete().eq('id', turnoId);
                        if (error) throw error;
                        return { success: true, message: 'Turno eliminado correctamente', data: null };
                    }

                    return { success: false, message: 'Método no soportado', data: null };
                } catch (error) {
                    console.error('Error al procesar turnos:', error);
                    return { success: false, message: error.message, data: null };
                }
            },

            async handleSupabaseRegistros(endpoint, options) {
                const method = options.method || 'GET';
                const url = new URL(endpoint, window.location.origin);
                const params = Object.fromEntries(url.searchParams.entries());

                try {
                    if (method === 'GET') {
                        if (params.id) {
                            const { data, error } = await supabaseClient
                                .from('registros')
                                .select('*')
                                .eq('id', params.id)
                                .maybeSingle();

                            if (error) throw error;
                            return {
                                success: !!data,
                                message: data ? 'Registro encontrado' : 'Registro no encontrado',
                                data
                            };
                        }

                        let query = supabaseClient
                            .from('registros')
                            .select('*', { count: 'exact' })
                            .order('fecha', { ascending: false })
                            .order('hora_prog', { ascending: true, nullsLast: true });

                        if (params.fecha_inicio && params.fecha_fin) {
                            query = query.gte('fecha', params.fecha_inicio).lte('fecha', params.fecha_fin);
                        } else if (params.fecha) {
                            query = query.eq('fecha', params.fecha);
                        }

                        if (params.turno) query = query.eq('turno', params.turno);
                        if (params.tipoevento) query = query.eq('tipoevento', params.tipoevento);

                        const { data, error, count } = await query;
                        if (error) throw error;

                        return {
                            success: true,
                            message: 'Registros obtenidos correctamente',
                            data: data || [],
                            total: count || (data ? data.length : 0)
                        };
                    }

                    if (method === 'POST') {
                        const registroData = this.parseBody(options.body);
                        const { data, error } = await supabaseClient
                            .from('registros')
                            .insert(registroData)
                            .select('*')
                            .single();

                        if (error) throw error;
                        return { success: true, message: 'Registro creado correctamente', data };
                    }

                    if (method === 'PUT') {
                        const registroId = endpoint.split('/').pop();
                        const registroData = this.parseBody(options.body);
                        const { data, error } = await supabaseClient
                            .from('registros')
                            .update(registroData)
                            .eq('id', registroId)
                            .select('*')
                            .maybeSingle();

                        if (error) throw error;
                        if (!data) return { success: false, message: 'Registro no encontrado', data: null };
                        return { success: true, message: 'Registro actualizado correctamente', data };
                    }

                    if (method === 'DELETE') {
                        const registroId = endpoint.split('/').pop();
                        const { error } = await supabaseClient.from('registros').delete().eq('id', registroId);
                        if (error) throw error;
                        return { success: true, message: 'Registro eliminado correctamente', data: null };
                    }

                    return { success: false, message: 'Método no soportado', data: null };
                } catch (error) {
                    console.error('Error al procesar registros:', error);
                    return { success: false, message: error.message, data: null };
                }
            },

            async handleSupabaseCatalogos(endpoint, options) {
                const method = options.method || 'GET';
                const url = new URL(endpoint, window.location.origin);
                const params = Object.fromEntries(url.searchParams.entries());
                const type = params.type || '';

                try {
                    if (method === 'GET') {
                        if (type === 'despachadores') {
                            const { data, error } = await supabaseClient
                                .from('despachadores')
                                .select('nombre')
                                .order('nombre', { ascending: true });
                            if (error) throw error;
                            return {
                                success: true,
                                message: 'Despachadores obtenidos',
                                data: (data || []).map(item => item.nombre)
                            };
                        }

                        if (type === 'servicios') {
                            const { data, error } = await supabaseClient
                                .from('servicios')
                                .select('numero')
                                .order('numero', { ascending: true });
                            if (error) throw error;
                            return {
                                success: true,
                                message: 'Servicios obtenidos',
                                data: (data || []).map(item => item.numero)
                            };
                        }

                        if (type === 'conductores') {
                            const { data, error } = await supabaseClient
                                .from('conductores')
                                .select('nombre')
                                .order('nombre', { ascending: true });
                            if (error) throw error;
                            return {
                                success: true,
                                message: 'Conductores obtenidos',
                                data: (data || []).map(item => item.nombre)
                            };
                        }

                        if (type === 'buses') {
                            const { data, error } = await supabaseClient
                                .from('buses')
                                .select('ppu, tipo')
                                .order('ppu', { ascending: true });
                            if (error) throw error;
                            return {
                                success: true,
                                message: 'Buses obtenidos',
                                data: data || []
                            };
                        }

                        if (type === 'parametros') {
                            const { data, error } = await supabaseClient
                                .from('parametros')
                                .select('flota_total, tol_atraso_min, tol_anticipo_min')
                                .maybeSingle();
                            
                            if (error && error.code !== 'PGRST116') throw error;
                            
                            return {
                                success: true,
                                message: 'Parámetros obtenidos',
                                data: data || {
                                    flota_total: CONFIG.FLOTA_TOTAL,
                                    tol_atraso_min: CONFIG.TOL_ATRASO_MIN,
                                    tol_anticipo_min: CONFIG.TOL_ANTICIPO_MIN
                                }
                            };
                        }

                        // Obtener todos los catálogos
                        const [desp, serv, cond, bus] = await Promise.all([
                            supabaseClient.from('despachadores').select('nombre'),
                            supabaseClient.from('servicios').select('numero'),
                            supabaseClient.from('conductores').select('nombre'),
                            supabaseClient.from('buses').select('ppu, tipo')
                        ]);

                        return {
                            success: true,
                            message: 'Catálogos obtenidos',
                            data: {
                                despachadores: (desp.data || []).map(item => item.nombre),
                                servicios: (serv.data || []).map(item => item.numero),
                                conductores: (cond.data || []).map(item => item.nombre),
                                buses: bus.data || []
                            }
                        };
                    }

                    if (method === 'POST') {
                        const itemData = this.parseBody(options.body);

                        if (type === 'despachadores') {
                            const { data, error } = await supabaseClient
                                .from('despachadores')
                                .insert({ nombre: itemData.nombre })
                                .select('nombre')
                                .single();
                            if (error) throw error;
                            return { success: true, message: 'Despachador creado', data: data.nombre };
                        }

                        if (type === 'servicios') {
                            const { data, error } = await supabaseClient
                                .from('servicios')
                                .insert({ numero: itemData.numero })
                                .select('numero')
                                .single();
                            if (error) throw error;
                            return { success: true, message: 'Servicio creado', data: data.numero };
                        }

                        if (type === 'conductores') {
                            const { data, error } = await supabaseClient
                                .from('conductores')
                                .insert({ nombre: itemData.nombre })
                                .select('nombre')
                                .single();
                            if (error) throw error;
                            return { success: true, message: 'Conductor creado', data: data.nombre };
                        }

                        if (type === 'buses') {
                            const { data, error } = await supabaseClient
                                .from('buses')
                                .insert({ ppu: itemData.ppu, tipo: itemData.tipo })
                                .select('ppu, tipo')
                                .single();
                            if (error) throw error;
                            return { success: true, message: 'Bus creado', data };
                        }

                        if (type === 'parametros') {
                            const payload = {
                                id: 1,
                                flota_total: itemData.flota_total,
                                tol_atraso_min: itemData.tol_atraso_min,
                                tol_anticipo_min: itemData.tol_anticipo_min
                            };
                            const { data, error } = await supabaseClient
                                .from('parametros')
                                .upsert(payload, { onConflict: 'id' })
                                .select('flota_total, tol_atraso_min, tol_anticipo_min')
                                .single();
                            if (error) throw error;
                            return { success: true, message: 'Parámetros actualizados', data };
                        }

                        return { success: false, message: 'Tipo de catálogo no válido', data: null };
                    }

                    if (method === 'DELETE') {
                        const pathPart = endpoint.split('?')[0];
                        const segments = pathPart.split('/').filter(Boolean);
                        const pathId = segments.length > 2 ? decodeURIComponent(segments[segments.length - 1]) : '';
                        const itemId = params.id || params.value || pathId;

                        if (!itemId) return { success: false, message: 'ID no proporcionado', data: null };

                        if (type === 'despachadores') {
                            const { error } = await supabaseClient.from('despachadores').delete().eq('nombre', itemId);
                            if (error) throw error;
                            return { success: true, message: 'Despachador eliminado', data: null };
                        }

                        if (type === 'servicios') {
                            const { error } = await supabaseClient.from('servicios').delete().eq('numero', itemId);
                            if (error) throw error;
                            return { success: true, message: 'Servicio eliminado', data: null };
                        }

                        if (type === 'conductores') {
                            const { error } = await supabaseClient.from('conductores').delete().eq('nombre', itemId);
                            if (error) throw error;
                            return { success: true, message: 'Conductor eliminado', data: null };
                        }

                        if (type === 'buses') {
                            const { error } = await supabaseClient.from('buses').delete().eq('ppu', itemId);
                            if (error) throw error;
                            return { success: true, message: 'Bus eliminado', data: null };
                        }

                        return { success: false, message: 'Tipo de catálogo no válido', data: null };
                    }

                    return { success: false, message: 'Método no soportado', data: null };
                } catch (error) {
                    console.error('Error al procesar catálogos:', error);
                    return { success: false, message: error.message, data: null };
                }
            },

            parseBody(body) {
                if (!body) return {};
                if (typeof body === 'string') {
                    if (!body.trim()) return {};
                    return JSON.parse(body);
                }
                return body;
            }
        };

        // ============================================
        // VIEWS CONTROLLER
        // ============================================
        const Views = {
            current: 'dashboardView',
            
            show(viewId) {
                document.querySelectorAll('.main-content > div').forEach(el => {
                    el.style.display = 'none';
                });
                
                document.querySelectorAll('.sidebar-menu-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                const view = document.getElementById(viewId);
                if (view) {
                    view.style.display = 'block';
                    const menuItem = document.getElementById(viewId.replace('View', 'Link'));
                    if (menuItem) menuItem.classList.add('active');
                    this.updatePageTitle(viewId);
                    this.current = viewId;
                    this.initializeView(viewId);
                }
            },
            
            updatePageTitle(viewId) {
                const titles = {
                    dashboardView: '<i class="fas fa-tachometer-alt"></i> Dashboard Operacional',
                    turnosView: '<i class="fas fa-clock"></i> Control de Turnos',
                    registrosView: '<i class="fas fa-clipboard-list"></i> Registro de Eventos',
                    informesView: '<i class="fas fa-file-alt"></i> Informes y Estadísticas',
                    kpisView: '<i class="fas fa-chart-line"></i> KPI\'s Operacionales',
                    catalogosView: '<i class="fas fa-folder-open"></i> Catálogos del Sistema'
                };
                document.querySelector('.page-title').innerHTML = titles[viewId] || 'VOY15';
            },
            
            initializeView(viewId) {
                const controllers = {
                    dashboardView: () => Dashboard.initialize(),
                    turnosView: () => TurnosController.initialize(),
                    registrosView: () => RegistrosController.initialize(),
                    informesView: () => InformesController.initialize(),
                    kpisView: () => KPIsController.initialize(),
                    catalogosView: () => CatalogosController.initialize()
                };
                if (controllers[viewId]) controllers[viewId]();
            }
        };

        // ============================================
        // DASHBOARD CONTROLLER
        // ============================================
        const Dashboard = {
            charts: {},
            initialized: false,
            
            initialize() {
                if (!this.initialized) {
                    document.getElementById('dashboardDateFilter').valueAsDate = new Date();
                    this.initializeCharts();
                    this.initialized = true;
                }
                this.loadData();
            },
            
            async loadData() {
                try {
                    document.getElementById("currentShiftLoader").style.display = "block";
                    document.getElementById("activityLoader").style.display = "block";
                    document.getElementById("currentShiftData").style.display = "none";
                    document.getElementById("noCurrentShiftMessage").style.display = "none";
                    
                    const fecha = document.getElementById('dashboardDateFilter').value;
                    const turnosResponse = await API.request(`${CONFIG.API_TURNOS}?fecha=${fecha}`);
                    
                    if (turnosResponse.success) {
                        const turnos = turnosResponse.data;
                        const turnoAbierto = turnos.find(t => t.estado === 'Abierto');
                        
                        if (turnoAbierto) {
                            this.displayCurrentShift(turnoAbierto);
                        } else {
                            document.getElementById("currentShiftData").style.display = "none";
                            document.getElementById("noCurrentShiftMessage").style.display = "block";
                        }
                    }
                    
                    const registrosResponse = await API.request(`${CONFIG.API_REGISTROS}?fecha=${fecha}`);
                    if (registrosResponse.success) {
                        const registros = registrosResponse.data;
                        this.updateKPIs(registros);
                        this.displayRecentActivity(registros);
                    }
                    
                    this.updateCharts(fecha);
                } catch (error) {
                    console.error('Error al cargar datos del dashboard:', error);
                    UI.showToast('Error al cargar datos', 'error');
                } finally {
                    document.getElementById("currentShiftLoader").style.display = "none";
                    document.getElementById("activityLoader").style.display = "none";
                }
            },
            
            displayCurrentShift(turno) {
                document.getElementById("currentShiftData").style.display = "block";
                document.getElementById("noCurrentShiftMessage").style.display = "none";
                document.getElementById("currentShiftTurno").textContent = turno.turno;
                document.getElementById("currentShiftFecha").textContent = Utils.formatDate(turno.fecha);
                document.getElementById("currentShiftDespachador").textContent = turno.despachador;
                
                const telStatus = document.getElementById("currentShiftTelStatus");
                telStatus.textContent = turno.tel_inicio || 'N/A';
                telStatus.className = `status-badge status-${(turno.tel_inicio || 'ok').toLowerCase()}`;
                
                document.getElementById("currentShiftOperativos").textContent = turno.op_ini || 0;
                document.getElementById("currentShiftMantencion").textContent = turno.man_ini || 0;
                document.getElementById("currentShiftDiferencia").textContent = turno.diff_ini || 0;
                document.getElementById("closeCurrentShiftBtn").setAttribute('data-id', turno.id);
            },
            
            updateKPIs(registros) {
                const busesOperativos = registros.filter(r => r.tipoevento === 'BusOperativo').length;
                const busesMantencion = registros.filter(r => r.tipoevento === 'BusDetenido').length;
                const cancelaciones = registros.filter(r => r.tipoevento === 'Cancelación').length;
                const ausencias = registros.filter(r => r.tipoevento === 'AusenciaConductor').length;
                const llavesFaltantes = registros.filter(r => r.tipoevento === 'LlavesFaltantes').length;
                const telefonosFalla = registros.filter(r => r.tipoevento === 'TelefonoFalla').length;
                
                const primerasSalidas = registros.filter(r => r.tipoevento === 'PrimeraSalida');
                const ultimasSalidas = registros.filter(r => r.tipoevento === 'UltimaSalida');
                
                const puntualidadPrimera = primerasSalidas.length > 0 
                    ? Math.round((primerasSalidas.filter(r => r.ontime === 1).length / primerasSalidas.length) * 100) 
                    : 0;
                
                const puntualidadUltima = ultimasSalidas.length > 0 
                    ? Math.round((ultimasSalidas.filter(r => r.ontime === 1).length / ultimasSalidas.length) * 100) 
                    : 0;
                
                document.getElementById('kpiBusesOperativos').textContent = busesOperativos;
                document.getElementById('kpiBusesMantencion').textContent = busesMantencion;
                document.getElementById('kpiCancelaciones').textContent = cancelaciones;
                document.getElementById('kpiAusencias').textContent = ausencias;
                document.getElementById('kpiLlavesFaltantes').textContent = llavesFaltantes;
                document.getElementById('kpiTelefonosFalla').textContent = telefonosFalla;
                document.getElementById('kpiPuntualidadPrimera').textContent = `${puntualidadPrimera}%`;
                document.getElementById('kpiPuntualidadUltima').textContent = `${puntualidadUltima}%`;
                document.getElementById('kpiFlotaTotal').textContent = CONFIG.FLOTA_TOTAL;
                
                const porcentajeMantencion = Math.round((busesMantencion / CONFIG.FLOTA_TOTAL) * 100);
                document.getElementById('kpiPorcentajeMantencion').textContent = porcentajeMantencion;
            },
            
            displayRecentActivity(registros) {
                const activityFeed = document.getElementById('activityFeed');
                const noActivityMessage = document.getElementById('noActivityMessage');
                
                const sortedRegistros = [...registros]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 10);
                
                if (sortedRegistros.length === 0) {
                    activityFeed.innerHTML = '';
                    noActivityMessage.style.display = 'block';
                    return;
                }
                
                noActivityMessage.style.display = 'none';
                activityFeed.innerHTML = '';
                
                const iconMap = {
                    PrimeraSalida: 'fas fa-play',
                    UltimaSalida: 'fas fa-flag-checkered',
                    Cancelación: 'fas fa-ban',
                    BusOperativo: 'fas fa-bus',
                    BusDetenido: 'fas fa-tools',
                    AusenciaConductor: 'fas fa-user-slash',
                    LlavesFaltantes: 'fas fa-key',
                    TelefonoOK: 'fas fa-phone',
                    TelefonoFalla: 'fas fa-phone-slash'
                };
                
                sortedRegistros.forEach(registro => {
                    const iconClass = iconMap[registro.tipoevento] || 'fas fa-clipboard-check';
                    const activityTitle = Utils.formatTipoEvento(registro.tipoevento);
                    
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activityTitle}${registro.servicio ? ` - Servicio ${registro.servicio}` : ''}</div>
                            <div class="activity-time">Turno ${registro.turno} - ${Utils.formatDate(registro.fecha)} - ${Utils.timeAgo(new Date(registro.created_at))}</div>
                        </div>
                    `;
                    activityFeed.appendChild(activityItem);
                });
            },
            
            initializeCharts() {
                const ctx = document.getElementById('puntualidadChart');
                if (!ctx) return;
                
                if (this.charts.puntualidad) {
                    this.charts.puntualidad.destroy();
                }
                
                this.charts.puntualidad = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Puntualidad Primera (%)',
                                data: [],
                                borderColor: '#0056b3',
                                backgroundColor: 'rgba(0, 85, 150, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: 'Puntualidad Última (%)',
                                data: [],
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12, weight: '600' }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: context => context.dataset.label + ': ' + context.parsed.y + '%'
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            }
                        }
                    }
                });
            },
            
            async updateCharts(fechaActual) {
                try {
                    const fechas = [];
                    const puntualidadPrimera = [];
                    const puntualidadUltima = [];
                    const today = new Date(fechaActual);
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const fechaStr = date.toISOString().split('T')[0];
                        
                        const response = await API.request(`${CONFIG.API_REGISTROS}?fecha=${fechaStr}`);
                        
                        if (response.success) {
                            const registros = response.data;
                            const primerasSalidas = registros.filter(r => r.tipoevento === 'PrimeraSalida');
                            const ultimasSalidas = registros.filter(r => r.tipoevento === 'UltimaSalida');
                            
                            const puntPrimera = primerasSalidas.length > 0 
                                ? Math.round((primerasSalidas.filter(r => r.ontime === 1).length / primerasSalidas.length) * 100) 
                                : 0;
                            
                            const puntUltima = ultimasSalidas.length > 0 
                                ? Math.round((ultimasSalidas.filter(r => r.ontime === 1).length / ultimasSalidas.length) * 100) 
                                : 0;
                            
                            fechas.push(date.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit' }));
                            puntualidadPrimera.push(puntPrimera);
                            puntualidadUltima.push(puntUltima);
                        }
                    }
                    
                    if (this.charts.puntualidad) {
                        this.charts.puntualidad.data.labels = fechas;
                        this.charts.puntualidad.data.datasets[0].data = puntualidadPrimera;
                        this.charts.puntualidad.data.datasets[1].data = puntualidadUltima;
                        this.charts.puntualidad.update();
                    }
                } catch (error) {
                    console.error('Error al actualizar gráficos:', error);
                }
            }
        };

        // ============================================
        // TURNOS CONTROLLER
        // ============================================
        const TurnosController = {
            currentPage: 1,
            itemsPerPage: 10,
            
            initialize() {
                document.getElementById('turnosDateFilter').valueAsDate = new Date();
                this.loadTurnosAbiertos();
            },
            
            async loadTurnosAbiertos() {
                try {
                    document.getElementById('turnosAbiertosLoader').style.display = 'block';
                    document.getElementById('noTurnosAbiertosMessage').style.display = 'none';
                    document.getElementById('turnosAbiertosTableBody').innerHTML = '';
                    
                    const fecha = document.getElementById('turnosDateFilter').value;
                    const response = await API.request(`${CONFIG.API_TURNOS}?fecha=${fecha}&estado=Abierto`);
                    
                    if (response.success) {
                        const turnos = response.data;
                        if (turnos.length === 0) {
                            document.getElementById('noTurnosAbiertosMessage').style.display = 'block';
                        } else {
                            this.renderTurnosAbiertos(turnos);
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar turnos abiertos:', error);
                    UI.showToast('Error al cargar turnos abiertos', 'error');
                } finally {
                    document.getElementById('turnosAbiertosLoader').style.display = 'none';
                }
            },
            
            renderTurnosAbiertos(turnos) {
                const tbody = document.getElementById('turnosAbiertosTableBody');
                tbody.innerHTML = '';
                
                turnos.forEach(turno => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${Utils.formatDate(turno.fecha)}</td>
                        <td><span class="badge bg-primary">${turno.turno}</span></td>
                        <td>${turno.despachador}</td>
                        <td><span class="status-badge status-${(turno.tel_inicio || 'ok').toLowerCase()}">${turno.tel_inicio || 'N/A'}</span></td>
                        <td><strong class="text-success">${turno.op_ini}</strong></td>
                        <td><strong class="text-warning">${turno.man_ini}</strong></td>
                        <td><strong>${turno.diff_ini}</strong></td>
                        <td><span class="status-badge status-abierto">${turno.estado}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success" onclick="TurnosController.openCerrarTurnoModal(${turno.id})" title="Cerrar Turno">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="TurnosController.openEditarTurnoModal(${turno.id})" title="Editar Turno">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            async loadTurnosCerrados() {
                try {
                    document.getElementById('turnosCerradosLoader').style.display = 'block';
                    document.getElementById('noTurnosCerradosMessage').style.display = 'none';
                    document.getElementById('turnosCerradosTableBody').innerHTML = '';
                    
                    const fecha = document.getElementById('turnosDateFilter').value;
                    const response = await API.request(`${CONFIG.API_TURNOS}?fecha=${fecha}&estado=Cerrado`);
                    
                    if (response.success) {
                        const turnos = response.data;
                        if (turnos.length === 0) {
                            document.getElementById('noTurnosCerradosMessage').style.display = 'block';
                        } else {
                            this.renderTurnosCerrados(turnos);
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar turnos cerrados:', error);
                    UI.showToast('Error al cargar turnos cerrados', 'error');
                } finally {
                    document.getElementById('turnosCerradosLoader').style.display = 'none';
                }
            },
            
            renderTurnosCerrados(turnos) {
                const tbody = document.getElementById('turnosCerradosTableBody');
                tbody.innerHTML = '';
                
                turnos.forEach(turno => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${Utils.formatDate(turno.fecha)}</td>
                        <td><span class="badge bg-secondary">${turno.turno}</span></td>
                        <td>${turno.despachador}</td>
                        <td>${turno.op_ini}</td>
                        <td>${turno.man_ini}</td>
                        <td>${turno.op_fin || '-'}</td>
                        <td>${turno.man_fin || '-'}</td>
                        <td>${Utils.formatDateTime(turno.updated_at)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="TurnosController.verDetallesTurno(${turno.id})" title="Ver Detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('turnosCerradosPaginationInfo').textContent = 
                    `Mostrando ${turnos.length > 0 ? '1' : '0'} - ${turnos.length} de ${turnos.length} turnos`;
            },
            
            openNuevoTurnoModal() {
                document.getElementById('nuevoTurnoForm').reset();
                document.getElementById('turnoIdInput').value = '';
                document.getElementById('nuevoTurnoModalLabel').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Turno';
                document.getElementById('turnoFechaInput').value = document.getElementById('turnosDateFilter').value;
                this.loadDespachadores();
                document.getElementById('turnoFlotaTotal').textContent = CONFIG.FLOTA_TOTAL;
                this.calcularDiferenciaTurno();
                new bootstrap.Modal(document.getElementById('nuevoTurnoModal')).show();
            },
            
            async openEditarTurnoModal(turnoId) {
                try {
                    const response = await API.request(`${CONFIG.API_TURNOS}?id=${turnoId}`);
                    if (response.success) {
                        const turno = response.data;
                        document.getElementById('nuevoTurnoModalLabel').innerHTML = '<i class="fas fa-edit"></i> Editar Turno';
                        document.getElementById('turnoIdInput').value = turno.id;
                        document.getElementById('turnoFechaInput').value = turno.fecha;
                        document.getElementById('turnoTurnoInput').value = turno.turno;
                        document.getElementById('turnoTelInicioInput').value = turno.tel_inicio || '';
                        document.getElementById('turnoLlavesIniInput').value = turno.llaves_ini || 0;
                        document.getElementById('turnoOpIniInput').value = turno.op_ini;
                        document.getElementById('turnoManIniInput').value = turno.man_ini;
                        await this.loadDespachadores(turno.despachador);
                        document.getElementById('turnoFlotaTotal').textContent = CONFIG.FLOTA_TOTAL;
                        this.calcularDiferenciaTurno();
                        new bootstrap.Modal(document.getElementById('nuevoTurnoModal')).show();
                    }
                } catch (error) {
                    console.error('Error al cargar turno:', error);
                    UI.showToast('Error al cargar datos del turno', 'error');
                }
            },
            
            async openCerrarTurnoModal(turnoId) {
                try {
                    const response = await API.request(`${CONFIG.API_TURNOS}?id=${turnoId}`);
                    if (response.success) {
                        const turno = response.data;
                        document.getElementById('cerrarTurnoIdInput').value = turno.id;
                        document.getElementById('cerrarTurnoFechaText').textContent = Utils.formatDate(turno.fecha);
                        document.getElementById('cerrarTurnoTurnoText').textContent = turno.turno;
                        document.getElementById('cerrarTurnoDespachadorText').textContent = turno.despachador;
                        document.getElementById('cerrarTurnoEstadoInicialText').textContent = 
                            `Op: ${turno.op_ini}, Mant: ${turno.man_ini}, Tel: ${turno.tel_inicio || 'N/A'}`;
                        document.getElementById('cerrarTurnoTelFinInput').value = turno.tel_inicio || '';
                        document.getElementById('cerrarTurnoLlavesFinInput').value = turno.llaves_ini || 0;
                        document.getElementById('cerrarTurnoOpFinInput').value = turno.op_ini;
                        document.getElementById('cerrarTurnoManFinInput').value = turno.man_ini;
                        document.getElementById('cerrarTurnoFlotaTotal').textContent = CONFIG.FLOTA_TOTAL;
                        this.calcularDiferenciaCierreTurno();
                        new bootstrap.Modal(document.getElementById('cerrarTurnoModal')).show();
                    }
                } catch (error) {
                    console.error('Error al cargar turno:', error);
                    UI.showToast('Error al cargar datos del turno', 'error');
                }
            },
            
            async loadDespachadores(selected = '') {
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=despachadores`);
                    if (response.success) {
                        const select = document.getElementById('turnoDespachadorInput');
                        select.innerHTML = '<option value="">Seleccione un despachador...</option>';
                        response.data.forEach(despachador => {
                            const option = document.createElement('option');
                            option.value = despachador;
                            option.textContent = despachador;
                            if (despachador === selected) option.selected = true;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error al cargar despachadores:', error);
                }
            },
            
            calcularDiferenciaTurno() {
                const opIni = parseInt(document.getElementById('turnoOpIniInput').value) || 0;
                const manIni = parseInt(document.getElementById('turnoManIniInput').value) || 0;
                const diff = CONFIG.FLOTA_TOTAL - opIni - manIni;
                
                const diffElement = document.getElementById('turnoDiffIniValue');
                diffElement.textContent = diff;
                
                const alertElement = document.getElementById('turnoDiferenciaAlert');
                alertElement.classList.remove('alert-info', 'alert-warning', 'alert-danger', 'alert-success');
                
                if (diff < 0) {
                    diffElement.style.color = '#dc3545';
                    alertElement.classList.add('alert-danger');
                } else if (diff > 0) {
                    diffElement.style.color = '#ffc107';
                    alertElement.classList.add('alert-warning');
                } else {
                    diffElement.style.color = '#198754';
                    alertElement.classList.add('alert-success');
                }
            },
            
            calcularDiferenciaCierreTurno() {
                const opFin = parseInt(document.getElementById('cerrarTurnoOpFinInput').value) || 0;
                const manFin = parseInt(document.getElementById('cerrarTurnoManFinInput').value) || 0;
                const diff = CONFIG.FLOTA_TOTAL - opFin - manFin;
                
                const diffElement = document.getElementById('cerrarTurnoDiffFinValue');
                diffElement.textContent = diff;
                
                const alertElement = document.getElementById('cerrarTurnoDiferenciaAlert');
                alertElement.classList.remove('alert-info', 'alert-warning', 'alert-danger', 'alert-success');
                
                if (diff < 0) {
                    diffElement.style.color = '#dc3545';
                    alertElement.classList.add('alert-danger');
                } else if (diff > 0) {
                    diffElement.style.color = '#ffc107';
                    alertElement.classList.add('alert-warning');
                } else {
                    diffElement.style.color = '#198754';
                    alertElement.classList.add('alert-success');
                }
            },
            
            async saveTurno() {
                try {
                    const form = document.getElementById('nuevoTurnoForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    const turnoId = document.getElementById('turnoIdInput').value;
                    const turnoData = {
                        fecha: document.getElementById('turnoFechaInput').value,
                        turno: document.getElementById('turnoTurnoInput').value,
                        despachador: document.getElementById('turnoDespachadorInput').value,
                        tel_inicio: document.getElementById('turnoTelInicioInput').value || null,
                        llaves_ini: parseInt(document.getElementById('turnoLlavesIniInput').value) || 0,
                        op_ini: parseInt(document.getElementById('turnoOpIniInput').value) || 0,
                        man_ini: parseInt(document.getElementById('turnoManIniInput').value) || 0
                    };
                    
                    if (turnoData.op_ini + turnoData.man_ini > CONFIG.FLOTA_TOTAL) {
                        UI.showToast('La suma no puede superar la flota total', 'warning');
                        return;
                    }
                    
                    const response = turnoId
                        ? await API.request(`${CONFIG.API_TURNOS}/${turnoId}`, { method: 'PUT', body: JSON.stringify(turnoData) })
                        : await API.request(CONFIG.API_TURNOS, { method: 'POST', body: JSON.stringify(turnoData) });
                    
                    if (response.success) {
                        bootstrap.Modal.getInstance(document.getElementById('nuevoTurnoModal')).hide();
                        UI.showToast(turnoId ? 'Turno actualizado' : 'Turno creado', 'success');
                        this.loadTurnosAbiertos();
                        if (Views.current === 'dashboardView') Dashboard.loadData();
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error al guardar turno:', error);
                    UI.showToast('Error al guardar turno', 'error');
                }
            },
            
            async cerrarTurno() {
                try {
                    const form = document.getElementById('cerrarTurnoForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    const turnoId = document.getElementById('cerrarTurnoIdInput').value;
                    const turnoData = {
                        tel_fin: document.getElementById('cerrarTurnoTelFinInput').value || null,
                        llaves_fin: parseInt(document.getElementById('cerrarTurnoLlavesFinInput').value) || 0,
                        op_fin: parseInt(document.getElementById('cerrarTurnoOpFinInput').value) || 0,
                        man_fin: parseInt(document.getElementById('cerrarTurnoManFinInput').value) || 0,
                        notas_cierre: document.getElementById('cerrarTurnoNotasInput').value || null,
                        estado: 'Cerrado'
                    };
                    
                    if (turnoData.op_fin + turnoData.man_fin > CONFIG.FLOTA_TOTAL) {
                        UI.showToast('La suma no puede superar la flota total', 'warning');
                        return;
                    }
                    
                    const response = await API.request(`${CONFIG.API_TURNOS}/${turnoId}`, {
                        method: 'PUT',
                        body: JSON.stringify(turnoData)
                    });
                    
                    if (response.success) {
                        bootstrap.Modal.getInstance(document.getElementById('cerrarTurnoModal')).hide();
                        UI.showToast('Turno cerrado correctamente', 'success');
                        this.loadTurnosAbiertos();
                        if (Views.current === 'dashboardView') Dashboard.loadData();
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error al cerrar turno:', error);
                    UI.showToast('Error al cerrar turno', 'error');
                }
            },
            
            verDetallesTurno(turnoId) {
                UI.showToast('Función en desarrollo', 'info');
            }
        };

        // ============================================
        // REGISTROS CONTROLLER
        // ============================================
        const RegistrosController = {
            initialized: false,
            
            initialize() {
                if (!this.initialized) {
                    document.getElementById('registrosDateFilter').valueAsDate = new Date();
                    this.initialized = true;
                }
                this.loadRegistros();
            },
            
            async loadRegistros() {
                try {
                    document.getElementById('registrosLoader').style.display = 'block';
                    document.getElementById('noRegistrosMessage').style.display = 'none';
                    document.getElementById('registrosTableBody').innerHTML = '';
                    
                    const fecha = document.getElementById('registrosDateFilter').value;
                    const turno = document.getElementById('registrosTurnoFilter').value;
                    const tipoEvento = document.getElementById('registrosEventoFilter').value;
                    const busqueda = document.getElementById('registrosSearchInput').value.trim();
                    
                    let url = `${CONFIG.API_REGISTROS}?fecha=${fecha}`;
                    if (turno) url += `&turno=${turno}`;
                    if (tipoEvento) url += `&tipoevento=${tipoEvento}`;
                    
                    const response = await API.request(url);
                    
                    if (response.success) {
                        let registros = response.data;
                        
                        if (busqueda) {
                            const searchLower = busqueda.toLowerCase();
                            registros = registros.filter(r => 
                                (r.servicio && r.servicio.toLowerCase().includes(searchLower)) ||
                                (r.busid && r.busid.toLowerCase().includes(searchLower)) ||
                                (r.conductor && r.conductor.toLowerCase().includes(searchLower))
                            );
                        }
                        
                        if (registros.length === 0) {
                            document.getElementById('noRegistrosMessage').style.display = 'block';
                        } else {
                            this.renderRegistros(registros);
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar registros:', error);
                    UI.showToast('Error al cargar registros', 'error');
                } finally {
                    document.getElementById('registrosLoader').style.display = 'none';
                }
            },
            
            renderRegistros(registros) {
                const tbody = document.getElementById('registrosTableBody');
                tbody.innerHTML = '';
                
                registros.forEach(registro => {
                    const row = document.createElement('tr');
                    const retrasoMin = registro.retraso_min;
                    let retrasoText = '-';
                    let retrasoClass = '';
                    
                    if (retrasoMin !== null && retrasoMin !== undefined) {
                        const signo = retrasoMin >= 0 ? '+' : '';
                        retrasoText = `${signo}${retrasoMin} min`;
                        retrasoClass = registro.ontime === 1 ? 'ontime' : 'delay';
                    }
                    
                    row.innerHTML = `
                        <td>${Utils.formatDate(registro.fecha)}</td>
                        <td><span class="badge bg-info">${registro.turno}</span></td>
                        <td>${registro.servicio || '-'}</td>
                        <td>${registro.busid || '-'}</td>
                        <td>${registro.conductor || '-'}</td>
                        <td><span class="badge bg-secondary">${Utils.formatTipoEvento(registro.tipoevento)}</span></td>
                        <td>${registro.hora_prog || '-'}</td>
                        <td>${registro.hora_real || '-'}</td>
                        <td class="${retrasoClass}">${retrasoText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="RegistrosController.openVerRegistroModal(${registro.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="RegistrosController.openEditarRegistroModal(${registro.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('registrosPaginationInfo').textContent = 
                    `Mostrando ${registros.length > 0 ? '1' : '0'} - ${registros.length} de ${registros.length} registros`;
            },
            
            async openNuevoRegistroModal() {
                document.getElementById('nuevoRegistroForm').reset();
                document.getElementById('registroIdInput').value = '';
                document.getElementById('nuevoRegistroModalLabel').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Registro';
                document.getElementById('registroFechaInput').value = document.getElementById('registrosDateFilter').value;
                document.getElementById('registroMotivoContainer').style.display = 'none';
                document.getElementById('registroHorariosContainer').style.display = 'none';
                document.getElementById('registroTelefonoContainer').style.display = 'none';
                await this.loadCatalogsForRegistro();
                new bootstrap.Modal(document.getElementById('nuevoRegistroModal')).show();
            },
            
            async openVerRegistroModal(registroId) {
                try {
                    const response = await API.request(`${CONFIG.API_REGISTROS}?id=${registroId}`);
                    if (response.success) {
                        const registro = response.data;
                        const tbody = document.getElementById('verRegistroDetalles');
                        tbody.innerHTML = `
                            <tr><th width="40%">Fecha:</th><td>${Utils.formatDate(registro.fecha)}</td></tr>
                            <tr><th>Turno:</th><td>${registro.turno}</td></tr>
                            <tr><th>Tipo Evento:</th><td>${Utils.formatTipoEvento(registro.tipoevento)}</td></tr>
                            ${registro.servicio ? `<tr><th>Servicio:</th><td>${registro.servicio}</td></tr>` : ''}
                            ${registro.busid ? `<tr><th>PPU:</th><td>${registro.busid}</td></tr>` : ''}
                            ${registro.conductor ? `<tr><th>Conductor:</th><td>${registro.conductor}</td></tr>` : ''}
                            ${registro.hora_prog ? `<tr><th>Hora Programada:</th><td>${registro.hora_prog}</td></tr>` : ''}
                            ${registro.hora_real ? `<tr><th>Hora Real:</th><td>${registro.hora_real}</td></tr>` : ''}
                            ${registro.retraso_min !== null ? `<tr><th>Retraso:</th><td class="${registro.ontime === 1 ? 'text-success' : 'text-danger'}">${registro.retraso_min >= 0 ? '+' : ''}${registro.retraso_min} min</td></tr>` : ''}
                            ${registro.obs ? `<tr><th>Observaciones:</th><td>${registro.obs}</td></tr>` : ''}
                        `;
                        document.getElementById('editarRegistroBtn').setAttribute('data-id', registroId);
                        new bootstrap.Modal(document.getElementById('verRegistroModal')).show();
                    }
                } catch (error) {
                    console.error('Error al cargar registro:', error);
                    UI.showToast('Error al cargar registro', 'error');
                }
            },
            
            async openEditarRegistroModal(registroId) {
                try {
                    if (typeof registroId === 'object') {
                        const btn = registroId.target || registroId.currentTarget;
                        registroId = btn.getAttribute('data-id');
                        bootstrap.Modal.getInstance(document.getElementById('verRegistroModal'))?.hide();
                    }
                    
                    const response = await API.request(`${CONFIG.API_REGISTROS}?id=${registroId}`);
                    if (response.success) {
                        const registro = response.data;
                        document.getElementById('nuevoRegistroModalLabel').innerHTML = '<i class="fas fa-edit"></i> Editar Registro';
                        await this.loadCatalogsForRegistro();
                        
                        document.getElementById('registroIdInput').value = registro.id;
                        document.getElementById('registroFechaInput').value = registro.fecha;
                        document.getElementById('registroTurnoInput').value = registro.turno;
                        document.getElementById('registroTipoEventoInput').value = registro.tipoevento;
                        
                        if (registro.servicio) document.getElementById('registroServicioInput').value = registro.servicio;
                        if (registro.busid) {
                            document.getElementById('registroPPUInput').value = registro.busid;
                            document.getElementById('registroPPUInput').dispatchEvent(new Event('change'));
                        }
                        if (registro.tipo_bus) document.getElementById('registroTipoBusInput').value = registro.tipo_bus;
                        if (registro.conductor) document.getElementById('registroConductorInput').value = registro.conductor;
                        if (registro.despachador_evento) document.getElementById('registroDespachadorInput').value = registro.despachador_evento;
                        if (registro.motivo) document.getElementById('registroMotivoInput').value = registro.motivo;
                        if (registro.hora_prog) document.getElementById('registroHoraProgInput').value = registro.hora_prog;
                        if (registro.hora_real) document.getElementById('registroHoraRealInput').value = registro.hora_real;
                        if (registro.nextday) document.getElementById('registroNextDayInput').checked = registro.nextday;
                        if (registro.tel) document.getElementById('registroTelInput').value = registro.tel;
                        if (registro.obs) document.getElementById('registroObsInput').value = registro.obs;
                        
                        this.ajustarCamposRegistroModal();
                        new bootstrap.Modal(document.getElementById('nuevoRegistroModal')).show();
                    }
                } catch (error) {
                    console.error('Error al cargar registro:', error);
                    UI.showToast('Error al cargar registro', 'error');
                }
            },
            
            async loadCatalogsForRegistro() {
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}`);
                    if (response.success) {
                        const catalogs = response.data;
                        
                        const serviciosSelect = document.getElementById('registroServicioInput');
                        serviciosSelect.innerHTML = '<option value="">Seleccione...</option>';
                        (catalogs.servicios || []).forEach(servicio => {
                            serviciosSelect.innerHTML += `<option value="${servicio}">${servicio}</option>`;
                        });
                        
                        const despachadorSelect = document.getElementById('registroDespachadorInput');
                        despachadorSelect.innerHTML = '<option value="">Seleccione...</option>';
                        (catalogs.despachadores || []).forEach(despachador => {
                            despachadorSelect.innerHTML += `<option value="${despachador}">${despachador}</option>`;
                        });
                        
                        const conductorSelect = document.getElementById('registroConductorInput');
                        conductorSelect.innerHTML = '<option value="">Seleccione...</option>';
                        (catalogs.conductores || []).forEach(conductor => {
                            conductorSelect.innerHTML += `<option value="${conductor}">${conductor}</option>`;
                        });
                        
                        const ppuSelect = document.getElementById('registroPPUInput');
                        ppuSelect.innerHTML = '<option value="">Seleccione...</option>';
                        (catalogs.buses || []).forEach(bus => {
                            ppuSelect.innerHTML += `<option value="${bus.ppu}" data-tipo="${bus.tipo}">${bus.ppu} (${bus.tipo})</option>`;
                        });
                        
                        ppuSelect.onchange = () => {
                            const selected = ppuSelect.options[ppuSelect.selectedIndex];
                            const tipo = selected.getAttribute('data-tipo');
                            if (tipo) document.getElementById('registroTipoBusInput').value = tipo;
                        };
                    }
                } catch (error) {
                    console.error('Error al cargar catálogos:', error);
                }
            },
            
            ajustarCamposRegistroModal() {
                const tipoEvento = document.getElementById('registroTipoEventoInput').value;
                document.getElementById('registroMotivoContainer').style.display = 'none';
                document.getElementById('registroHorariosContainer').style.display = 'none';
                document.getElementById('registroTelefonoContainer').style.display = 'none';
                
                if (tipoEvento === 'PrimeraSalida' || tipoEvento === 'UltimaSalida') {
                    document.getElementById('registroHorariosContainer').style.display = 'flex';
                } else if (tipoEvento === 'Cancelación') {
                    document.getElementById('registroMotivoContainer').style.display = 'block';
                    document.getElementById('registroHorariosContainer').style.display = 'flex';
                } else if (tipoEvento === 'TelefonoOK' || tipoEvento === 'TelefonoFalla') {
                    document.getElementById('registroTelefonoContainer').style.display = 'flex';
                    document.getElementById('registroTelInput').value = tipoEvento === 'TelefonoOK' ? 'OK' : 'Falla';
                }
            },
            
            async saveRegistro() {
                try {
                    const form = document.getElementById('nuevoRegistroForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    const registroId = document.getElementById('registroIdInput').value;
                    const tipoEvento = document.getElementById('registroTipoEventoInput').value;
                    
                    const registroData = {
                        fecha: document.getElementById('registroFechaInput').value,
                        turno: document.getElementById('registroTurnoInput').value,
                        tipoevento: tipoEvento,
                        servicio: document.getElementById('registroServicioInput').value || null,
                        tipo_bus: document.getElementById('registroTipoBusInput').value || null,
                        busid: document.getElementById('registroPPUInput').value || null,
                        conductor: document.getElementById('registroConductorInput').value || null,
                        despachador_evento: document.getElementById('registroDespachadorInput').value || null,
                        obs: document.getElementById('registroObsInput').value || null
                    };
                    
                    if (tipoEvento === 'Cancelación') {
                        registroData.motivo = document.getElementById('registroMotivoInput').value;
                    }
                    
                    if (tipoEvento === 'PrimeraSalida' || tipoEvento === 'UltimaSalida' || tipoEvento === 'Cancelación') {
                        const horaProg = Utils.normalizeTimeValue(document.getElementById('registroHoraProgInput').value);
                        const horaReal = Utils.normalizeTimeValue(document.getElementById('registroHoraRealInput').value);
                        const crossesMidnight = document.getElementById('registroNextDayInput').checked;
                        
                        registroData.hora_prog = horaProg || null;
                        registroData.hora_real = horaReal || null;
                        registroData.nextday = crossesMidnight;
                        
                        if (horaProg && horaReal) {
                            const retraso = Utils.calculateDelayMinutes(horaProg, horaReal, crossesMidnight);
                            if (retraso !== null) {
                                registroData.retraso_min = retraso;
                                registroData.ontime = Math.abs(retraso) <= CONFIG.TOL_ATRASO_MIN && retraso >= -CONFIG.TOL_ANTICIPO_MIN ? 1 : 0;
                            }
                        }
                    }
                    
                    if (tipoEvento === 'TelefonoOK' || tipoEvento === 'TelefonoFalla') {
                        registroData.tel = document.getElementById('registroTelInput').value;
                    }
                    
                    const response = registroId
                        ? await API.request(`${CONFIG.API_REGISTROS}/${registroId}`, { method: 'PUT', body: JSON.stringify(registroData) })
                        : await API.request(CONFIG.API_REGISTROS, { method: 'POST', body: JSON.stringify(registroData) });
                    
                    if (response.success) {
                        bootstrap.Modal.getInstance(document.getElementById('nuevoRegistroModal')).hide();
                        UI.showToast(registroId ? 'Registro actualizado' : 'Registro creado', 'success');
                        this.loadRegistros();
                        if (Views.current === 'dashboardView') Dashboard.loadData();
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error al guardar registro:', error);
                    UI.showToast('Error al guardar registro', 'error');
                }
            }
        };

        // ============================================
        // CATALOGOS CONTROLLER (Simplificado)
        // ============================================
        const CatalogosController = {
            initialize() {
                this.loadDespachadores();
                this.loadServicios();
                this.loadConductores();
                this.loadBuses();
                this.loadParametros();
            },
            
            async loadDespachadores() {
                try {
                    document.getElementById('despachadorLoader').style.display = 'block';
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=despachadores`);
                    if (response.success) {
                        const listContainer = document.getElementById('despachadorList');
                        listContainer.innerHTML = '';
                        response.data.forEach(despachador => {
                            listContainer.innerHTML += `
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div><i class="fas fa-user-tie text-primary me-2"></i>${despachador}</div>
                                    <button class="btn btn-sm btn-danger remove-despachador-btn" data-id="${despachador}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                    }
                } finally {
                    document.getElementById('despachadorLoader').style.display = 'none';
                }
            },
            
            async loadServicios() {
                try {
                    document.getElementById('serviciosLoader').style.display = 'block';
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=servicios`);
                    if (response.success) {
                        const listContainer = document.getElementById('serviciosList');
                        listContainer.innerHTML = '';
                        response.data.forEach(servicio => {
                            listContainer.innerHTML += `
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div><i class="fas fa-route text-primary me-2"></i>Servicio ${servicio}</div>
                                    <button class="btn btn-sm btn-danger remove-servicio-btn" data-id="${servicio}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                    }
                } finally {
                    document.getElementById('serviciosLoader').style.display = 'none';
                }
            },
            
            async loadConductores() {
                try {
                    document.getElementById('conductoresLoader').style.display = 'block';
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=conductores`);
                    if (response.success) {
                        const listContainer = document.getElementById('conductoresList');
                        listContainer.innerHTML = '';
                        response.data.forEach(conductor => {
                            listContainer.innerHTML += `
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div><i class="fas fa-id-card text-primary me-2"></i>${conductor}</div>
                                    <button class="btn btn-sm btn-danger remove-conductor-btn" data-id="${conductor}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                    }
                } finally {
                    document.getElementById('conductoresLoader').style.display = 'none';
                }
            },
            
            async loadBuses() {
                try {
                    document.getElementById('busesLoader').style.display = 'block';
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=buses`);
                    if (response.success) {
                        const tbody = document.getElementById('busesTableBody');
                        tbody.innerHTML = '';
                        response.data.forEach(bus => {
                            tbody.innerHTML += `
                                <tr>
                                    <td><strong>${bus.ppu}</strong></td>
                                    <td><span class="badge bg-info">${bus.tipo}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-bus-btn" data-id="${bus.ppu}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                } finally {
                    document.getElementById('busesLoader').style.display = 'none';
                }
            },
            
            async loadParametros() {
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=parametros`);
                    if (response.success) {
                        document.getElementById('flotaTotal').value = response.data.flota_total;
                        document.getElementById('toleranciaAtraso').value = response.data.tol_atraso_min;
                        document.getElementById('toleranciaAnticipo').value = response.data.tol_anticipo_min;
                        
                        CONFIG.FLOTA_TOTAL = response.data.flota_total;
                        CONFIG.TOL_ATRASO_MIN = response.data.tol_atraso_min;
                        CONFIG.TOL_ANTICIPO_MIN = response.data.tol_anticipo_min;
                    }
                } catch (error) {
                    console.error('Error al cargar parámetros:', error);
                }
            },
            
            async agregarDespachador() {
                const nombre = document.getElementById('nuevoDespachadorInput').value.trim();
                if (!nombre) {
                    UI.showToast('Ingrese un nombre', 'warning');
                    return;
                }
                
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=despachadores`, {
                        method: 'POST',
                        body: JSON.stringify({ nombre })
                    });
                    
                    if (response.success) {
                        document.getElementById('nuevoDespachadorInput').value = '';
                        this.loadDespachadores();
                        UI.showToast('Despachador agregado', 'success');
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    UI.showToast('Error al agregar', 'error');
                }
            },
            
            async agregarServicio() {
                const numero = document.getElementById('nuevoServicioInput').value.trim();
                if (!numero) {
                    UI.showToast('Ingrese un número', 'warning');
                    return;
                }
                
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=servicios`, {
                        method: 'POST',
                        body: JSON.stringify({ numero })
                    });
                    
                    if (response.success) {
                        document.getElementById('nuevoServicioInput').value = '';
                        this.loadServicios();
                        UI.showToast('Servicio agregado', 'success');
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    UI.showToast('Error al agregar', 'error');
                }
            },
            
            async agregarConductor() {
                const nombre = document.getElementById('nuevoConductorInput').value.trim();
                if (!nombre) {
                    UI.showToast('Ingrese un nombre', 'warning');
                    return;
                }
                
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=conductores`, {
                        method: 'POST',
                        body: JSON.stringify({ nombre })
                    });
                    
                    if (response.success) {
                        document.getElementById('nuevoConductorInput').value = '';
                        this.loadConductores();
                        UI.showToast('Conductor agregado', 'success');
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    UI.showToast('Error al agregar', 'error');
                }
            },
            
            async agregarBus() {
                const ppu = document.getElementById('nuevoBusPPUInput').value.trim().toUpperCase();
                const tipo = document.getElementById('nuevoBusTipoInput').value;
                
                if (!ppu || !tipo) {
                    UI.showToast('Complete todos los campos', 'warning');
                    return;
                }
                
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=buses`, {
                        method: 'POST',
                        body: JSON.stringify({ ppu, tipo })
                    });
                    
                    if (response.success) {
                        document.getElementById('nuevoBusPPUInput').value = '';
                        document.getElementById('nuevoBusTipoInput').value = '';
                        this.loadBuses();
                        UI.showToast('Bus agregado', 'success');
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    UI.showToast('Error al agregar', 'error');
                }
            },
            
            async guardarParametros(e) {
                e.preventDefault();
                
                const flotaTotal = parseInt(document.getElementById('flotaTotal').value);
                const tolAtraso = parseInt(document.getElementById('toleranciaAtraso').value);
                const tolAnticipo = parseInt(document.getElementById('toleranciaAnticipo').value);
                
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=parametros`, {
                        method: 'POST',
                        body: JSON.stringify({
                            flota_total: flotaTotal,
                            tol_atraso_min: tolAtraso,
                            tol_anticipo_min: tolAnticipo
                        })
                    });
                    
                    if (response.success) {
                        CONFIG.FLOTA_TOTAL = flotaTotal;
                        CONFIG.TOL_ATRASO_MIN = tolAtraso;
                        CONFIG.TOL_ANTICIPO_MIN = tolAnticipo;
                        UI.showToast('Parámetros guardados', 'success');
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    UI.showToast('Error al guardar', 'error');
                }
            },
            
            confirmarEliminar(tipo, id) {
                document.getElementById('deleteItemType').value = tipo;
                document.getElementById('deleteItemId').value = id;
                new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
            },
            
            async eliminarItem(tipo, id) {
                try {
                    const response = await API.request(`${CONFIG.API_CATALOGS}?type=${tipo}/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        UI.showToast('Elemento eliminado', 'success');
                        
                        if (tipo === 'despachadores') this.loadDespachadores();
                        else if (tipo === 'servicios') this.loadServicios();
                        else if (tipo === 'conductores') this.loadConductores();
                        else if (tipo === 'buses') this.loadBuses();
                    } else {
                        UI.showToast(`Error: ${response.message}`, 'error');
                    }
                } catch (error) {
                    UI.showToast('Error al eliminar', 'error');
                }
            }
        };

        // ============================================
        // INFORMES CONTROLLER (Simplificado)
        // ============================================
        const InformesController = {
            initialize() {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('fechaInicioInforme').valueAsDate = firstDay;
                document.getElementById('fechaFinInforme').valueAsDate = today;
            }
        };

        // ============================================
        // KPIS CONTROLLER (Simplificado)
        // ============================================
        const KPIsController = {
            charts: {},
            
            initialize() {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('kpisDesdeFilter').valueAsDate = firstDay;
                document.getElementById('kpisHastaFilter').valueAsDate = today;
                this.initializeCharts();
            },
            
            initializeCharts() {
                const ctx1 = document.getElementById('puntualidadKpiChart');
                const ctx2 = document.getElementById('cancelacionesKpiChart');
                const ctx3 = document.getElementById('flotaKpiChart');
                const ctx4 = document.getElementById('serviciosKpiChart');
                
                if (ctx1) {
                    this.charts.puntualidad = new Chart(ctx1.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['A Tiempo', 'Retraso'],
                            datasets: [{
                                data: [75, 25],
                                backgroundColor: ['rgba(25, 135, 84, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                                borderColor: ['rgba(25, 135, 84, 1)', 'rgba(220, 53, 69, 1)'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
                
                if (ctx2) {
                    this.charts.cancelaciones = new Chart(ctx2.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Conductor', 'Falta Bus', 'Mantenimiento', 'Otros'],
                            datasets: [{
                                data: [10, 5, 3, 2],
                                backgroundColor: [
                                    'rgba(220, 53, 69, 0.7)',
                                    'rgba(255, 193, 7, 0.7)',
                                    'rgba(0, 85, 150, 0.7)',
                                    'rgba(108, 117, 125, 0.7)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
                
                if (ctx3) {
                    this.charts.flota = new Chart(ctx3.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Operativos', 'Mantención', 'No Disponibles'],
                            datasets: [{
                                data: [110, 10, 4],
                                backgroundColor: [
                                    'rgba(25, 135, 84, 0.7)',
                                    'rgba(255, 193, 7, 0.7)',
                                    'rgba(108, 117, 125, 0.7)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
                
                if (ctx4) {
                    this.charts.servicios = new Chart(ctx4.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['505', '513', '517'],
                            datasets: [{
                                label: 'Puntualidad (%)',
                                data: [85, 90, 80],
                                backgroundColor: 'rgba(0, 85, 150, 0.7)',
                                borderColor: 'rgba(0, 85, 150, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } },
                            scales: {
                                y: { beginAtZero: true, max: 100 }
                            }
                        }
                    });
                }
            }
        };

        // ============================================
        // UI UTILITIES
        // ============================================
        const UI = {
            showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type} show`;
                toast.setAttribute('role', 'alert');
                
                const icons = {
                    success: '<i class="fas fa-check-circle"></i>',
                    error: '<i class="fas fa-exclamation-circle"></i>',
                    warning: '<i class="fas fa-exclamation-triangle"></i>',
                    info: '<i class="fas fa-info-circle"></i>'
                };
                
                toast.innerHTML = `
                    <div class="toast-header">
                        ${icons[type] || icons.info}
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toastContainer.removeChild(toast), 300);
                }, 3000);
            }
        };

        // ============================================
        // UTILS
        // ============================================
        const Utils = {
            formatDate(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },
            
            formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            },
            
            timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                if (seconds < 60) return 'hace unos segundos';
                if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} minutos`;
                if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} horas`;
                if (seconds < 2592000) return `hace ${Math.floor(seconds / 86400)} días`;
                if (seconds < 31536000) return `hace ${Math.floor(seconds / 2592000)} meses`;
                return `hace ${Math.floor(seconds / 31536000)} años`;
            },
            
            normalizeTimeValue(value) {
                if (!value) return '';
                const digits = value.toString().replace(/[^0-9]/g, '').slice(0, 4);
                if (digits.length !== 4) return '';
                const hours = parseInt(digits.slice(0, 2), 10);
                const minutes = parseInt(digits.slice(2, 4), 10);
                if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return '';
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            },
            
            parseTimeToMinutes(value) {
                const normalized = this.normalizeTimeValue(value);
                if (!normalized) return null;
                const [hoursStr, minutesStr] = normalized.split(':');
                return parseInt(hoursStr, 10) * 60 + parseInt(minutesStr, 10);
            },
            
            calculateDelayMinutes(horaProg, horaReal, crossesMidnight) {
                const minProg = this.parseTimeToMinutes(horaProg);
                const minRealBase = this.parseTimeToMinutes(horaReal);
                if (minProg === null || minRealBase === null) return null;
                
                let minReal = minRealBase;
                if (crossesMidnight && minReal < minProg) {
                    minReal += 1440;
                }
                return minReal - minProg;
            },
            
            formatTipoEvento(tipo) {
                const tipos = {
                    PrimeraSalida: 'Primera Salida',
                    UltimaSalida: 'Última Salida',
                    Cancelación: 'Cancelación',
                    BusOperativo: 'Bus Operativo',
                    BusDetenido: 'Bus Detenido',
                    AusenciaConductor: 'Ausencia Conductor',
                    LlavesFaltantes: 'Llaves Faltantes',
                    TelefonoOK: 'Teléfono OK',
                    TelefonoFalla: 'Teléfono Falla'
                };
                return tipos[tipo] || tipo;
            }
        };

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Iniciando VOY15...');
            
            // Navegación
            document.getElementById('dashboardLink').addEventListener('click', () => Views.show('dashboardView'));
            document.getElementById('turnosLink').addEventListener('click', () => Views.show('turnosView'));
            document.getElementById('registrosLink').addEventListener('click', () => Views.show('registrosView'));
            document.getElementById('informesLink').addEventListener('click', () => Views.show('informesView'));
            document.getElementById('kpisLink').addEventListener('click', () => Views.show('kpisView'));
            document.getElementById('catalogosLink').addEventListener('click', () => Views.show('catalogosView'));
            
            // Sidebar
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
                document.getElementById('mainContent').classList.toggle('expanded');
            });
            
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            // Sync button
            document.getElementById('syncButton').addEventListener('click', function() {
                this.classList.add('loading');
                setTimeout(() => {
                    this.classList.remove('loading');
                    UI.showToast('Datos sincronizados', 'success');
                }, 1500);
            });
            
            // Dashboard events
            document.getElementById('applyDateFilterBtn').addEventListener('click', () => Dashboard.loadData());
            document.getElementById('refreshChartBtn').addEventListener('click', () => Dashboard.updateCharts(document.getElementById('dashboardDateFilter').value));
            document.getElementById('refreshTurnoBtn').addEventListener('click', () => Dashboard.loadData());
            document.getElementById('refreshActivityBtn').addEventListener('click', () => Dashboard.loadData());
            document.getElementById('closeCurrentShiftBtn').addEventListener('click', function() {
                const turnoId = this.getAttribute('data-id');
                if (turnoId) TurnosController.openCerrarTurnoModal(turnoId);
            });
            document.getElementById('createTurnoBtn').addEventListener('click', () => TurnosController.openNuevoTurnoModal());
            document.getElementById('newTurnoBtn').addEventListener('click', () => TurnosController.openNuevoTurnoModal());
            
            // Turnos events
            document.getElementById('turnosApplyFilterBtn').addEventListener('click', () => TurnosController.loadTurnosAbiertos());
            document.getElementById('turnosNuevoBtn').addEventListener('click', () => TurnosController.openNuevoTurnoModal());
            document.getElementById('createTurnoFromListBtn').addEventListener('click', () => TurnosController.openNuevoTurnoModal());
            document.getElementById('guardarTurnoBtn').addEventListener('click', () => TurnosController.saveTurno());
            document.getElementById('confirmarCerrarTurnoBtn').addEventListener('click', () => TurnosController.cerrarTurno());
            document.getElementById('turnoOpIniInput').addEventListener('input', () => TurnosController.calcularDiferenciaTurno());
            document.getElementById('turnoManIniInput').addEventListener('input', () => TurnosController.calcularDiferenciaTurno());
            document.getElementById('cerrarTurnoOpFinInput').addEventListener('input', () => TurnosController.calcularDiferenciaCierreTurno());
            document.getElementById('cerrarTurnoManFinInput').addEventListener('input', () => TurnosController.calcularDiferenciaCierreTurno());
            
            // Tabs events
            document.getElementById('turnos-abiertos-tab').addEventListener('click', () => TurnosController.loadTurnosAbiertos());
            document.getElementById('turnos-cerrados-tab').addEventListener('click', () => TurnosController.loadTurnosCerrados());
            
            // Registros events
            document.getElementById('registrosDateFilter').addEventListener('change', () => RegistrosController.loadRegistros());
            document.getElementById('registrosTurnoFilter').addEventListener('change', () => RegistrosController.loadRegistros());
            document.getElementById('registrosEventoFilter').addEventListener('change', () => RegistrosController.loadRegistros());
            document.getElementById('registrosSearchInput').addEventListener('input', () => RegistrosController.loadRegistros());
            document.getElementById('registrosNuevoBtn').addEventListener('click', () => RegistrosController.openNuevoRegistroModal());
            document.getElementById('guardarRegistroBtn').addEventListener('click', () => RegistrosController.saveRegistro());
            document.getElementById('editarRegistroBtn').addEventListener('click', (e) => RegistrosController.openEditarRegistroModal(e));
            document.getElementById('registroTipoEventoInput').addEventListener('change', () => RegistrosController.ajustarCamposRegistroModal());
            
            // Catálogos events
            document.getElementById('agregarDespachadorBtn').addEventListener('click', () => CatalogosController.agregarDespachador());
            document.getElementById('agregarServicioBtn').addEventListener('click', () => CatalogosController.agregarServicio());
            document.getElementById('agregarConductorBtn').addEventListener('click', () => CatalogosController.agregarConductor());
            document.getElementById('agregarBusBtn').addEventListener('click', () => CatalogosController.agregarBus());
            document.getElementById('parametrosForm').addEventListener('submit', (e) => CatalogosController.guardarParametros(e));
            
            // Delete confirmation
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                const tipo = document.getElementById('deleteItemType').value;
                const id = document.getElementById('deleteItemId').value;
                CatalogosController.eliminarItem(tipo, id);
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
            });
            
            // Event delegation for dynamic buttons
            document.addEventListener('click', (e) => {
                if (e.target.closest('.remove-despachador-btn')) {
                    CatalogosController.confirmarEliminar('despachadores', e.target.closest('.remove-despachador-btn').getAttribute('data-id'));
                }
                if (e.target.closest('.remove-servicio-btn')) {
                    CatalogosController.confirmarEliminar('servicios', e.target.closest('.remove-servicio-btn').getAttribute('data-id'));
                }
                if (e.target.closest('.remove-conductor-btn')) {
                    CatalogosController.confirmarEliminar('conductores', e.target.closest('.remove-conductor-btn').getAttribute('data-id'));
                }
                if (e.target.closest('.remove-bus-btn')) {
                    CatalogosController.confirmarEliminar('buses', e.target.closest('.remove-bus-btn').getAttribute('data-id'));
                }
            });
            
            // Time input masks
            const attachTimeMask = (input) => {
                if (!input) return;
                input.setAttribute('inputmode', 'numeric');
                input.addEventListener('input', function() {
                    let digits = this.value.replace(/[^0-9]/g, '');
                    if (digits.length > 4) digits = digits.slice(0, 4);
                    this.value = digits.length <= 2 ? digits : digits.slice(0, 2) + ':' + digits.slice(2);
                });
                input.addEventListener('blur', function() {
                    this.value = Utils.normalizeTimeValue(this.value);
                });
            };
            
            attachTimeMask(document.getElementById('registroHoraProgInput'));
            attachTimeMask(document.getElementById('registroHoraRealInput'));
            
            // Ocultar loading y mostrar dashboard
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                Views.show('dashboardView');
                console.log('✅ VOY15 cargado correctamente');
            }, 1000);
        });
    </script>
</body>
</html>